<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SchoolUs - 생기부 작성</title>
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7LJ1TCE277"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-7LJ1TCE277');</script>
    <script src="/static/js/tailwindcss.js"></script>
    <link href="/static/fontawesome/css/all.min.css" rel="stylesheet">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
body { font-family: 'Noto Sans KR', sans-serif; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        .curriculum-tab {
            transition: all 0.2s;
        }
        .curriculum-tab.active-2015 {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .curriculum-tab.active-2022 {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        .byte-bar {
            height: 3px;
            border-radius: 2px;
            transition: width 0.3s, background-color 0.3s;
        }
    </style>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SchoolUs">
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
    <script src="/static/js/pwa-install.js" defer></script>
    <script src="/static/js/pwa-push.js" defer></script>
</head>
<body class="bg-gradient-to-br from-slate-100 via-slate-50 to-indigo-50 text-slate-800 min-h-screen">

    <!-- 헤더 -->
    <header class="bg-white/80 backdrop-blur-lg border-b border-slate-200/50 shadow-sm sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="homeroom.html" class="flex items-center gap-2 text-slate-500 hover:text-indigo-600 transition">
                    <i class="fas fa-arrow-left"></i>
                    <span class="text-sm font-medium">담임업무로 돌아가기</span>
                </a>
                <div class="h-6 w-px bg-slate-200"></div>
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center text-white">
                        <i class="fas fa-file-signature"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-slate-800">생기부 작성</h1>
                        <p class="text-xs text-slate-500">AI 기반 생활기록부 작성 도구</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span id="class-badge" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold"></span>
                <!-- 포인트 표시 -->
                <div class="flex items-center gap-2 bg-gradient-to-r from-amber-50 to-yellow-50 border border-amber-200 px-3 py-1.5 rounded-full">
                    <i class="fas fa-coins text-amber-500"></i>
                    <span id="userPoint" class="font-bold text-amber-700 text-sm">0</span>
                    <span class="text-amber-600 text-xs">P</span>
                </div>
                <span id="teacher-name" class="text-sm font-medium text-slate-700"></span>
            </div>
        </div>
    </header>

    <!-- 메인 컨텐츠 -->
    <main class="max-w-7xl mx-auto p-6">
        <!-- 담임 아님 표시 -->
        <div id="no-homeroom-view" class="hidden">
            <div class="glass-card rounded-2xl shadow-lg p-12 text-center">
                <div class="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mb-6 mx-auto">
                    <i class="fas fa-user-slash text-4xl text-slate-400"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">담임 학급이 배정되지 않았습니다</h3>
                <p class="text-slate-500">담임 학급 배정 후 이용 가능합니다.</p>
            </div>
        </div>

        <!-- 메인 뷰 -->
        <div id="main-view" class="hidden">
            <!-- 학생 선택 + 교육과정 선택 영역 -->
            <div class="glass-card rounded-2xl shadow-lg overflow-hidden mb-6">
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-5 text-white">
                    <div class="flex items-center justify-between">
                        <h3 class="font-bold text-lg"><i class="fas fa-user-graduate mr-2"></i>학생 선택</h3>
                        <span class="text-sm text-white/80 bg-white/20 px-3 py-1 rounded-full">(학생 1인당 생기부 생성 시 300포인트 차감)</span>
                    </div>
                </div>
                <div class="p-6 space-y-4">
                    <!-- 교육과정 선택 탭 -->
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-2">
                            <i class="fas fa-graduation-cap mr-1"></i>적용 교육과정
                        </label>
                        <div class="flex gap-2">
                            <button onclick="switchCurriculum('2015')" id="cur-tab-2015"
                                class="curriculum-tab active-2015 flex-1 py-3 rounded-xl font-bold text-sm transition border-2 border-transparent">
                                <i class="fas fa-book mr-1"></i>2015 개정교육과정
                                <span class="block text-xs font-normal opacity-80 mt-0.5">고3 | 자율·동아리·봉사·진로 4영역</span>
                            </button>
                            <button onclick="switchCurriculum('2022')" id="cur-tab-2022"
                                class="curriculum-tab flex-1 py-3 rounded-xl font-bold text-sm bg-slate-100 text-slate-500 transition border-2 border-transparent hover:bg-slate-200">
                                <i class="fas fa-book-open mr-1"></i>2022 개정교육과정
                                <span class="block text-xs font-normal opacity-80 mt-0.5">고1~2 | 자율·자치/동아리/진로 3영역</span>
                            </button>
                        </div>
                    </div>

                    <!-- 학생/학년도/학기/버튼 -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2">학생</label>
                            <select id="select-student" onchange="onStudentChange()" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 outline-none">
                                <option value="">학생을 선택하세요</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2">학년도</label>
                            <select id="select-year" onchange="loadStudentData()" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 outline-none">
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2">학기</label>
                            <select id="select-semester" onchange="loadStudentData()" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 outline-none">
                                <option value="1">1학기</option>
                                <option value="2">2학기</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="loadStudentData()" class="w-full px-4 py-3 bg-indigo-100 text-indigo-700 rounded-xl font-bold hover:bg-indigo-200 transition">
                                <i class="fas fa-sync-alt mr-2"></i>자료 불러오기
                            </button>
                        </div>
                        <div class="flex items-end">
                            <button id="btn-generate" onclick="generateRecord()" disabled class="w-full px-4 py-3 bg-slate-200 text-slate-400 rounded-xl font-bold cursor-not-allowed transition">
                                <i class="fas fa-magic mr-2"></i>생기부 생성하기
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 작성 영역 (2열 그리드) -->
            <div id="work-area" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- 좌측: 참고자료 -->
                <div class="space-y-6">
                    <!-- 기초자료 -->
                    <div class="glass-card rounded-2xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-teal-500 to-cyan-600 p-4 text-white flex justify-between items-center">
                            <h3 class="font-bold"><i class="fas fa-database mr-2"></i>기초자료</h3>
                        </div>
                        <div class="p-4">
                            <div id="base-data" class="bg-slate-50 rounded-xl p-4 min-h-[150px] text-sm text-slate-600 whitespace-pre-wrap">
                                학생을 선택하면 기초자료가 표시됩니다.
                            </div>
                        </div>
                    </div>

                    <!-- 상담일지 -->
                    <div class="glass-card rounded-2xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-purple-500 to-pink-600 p-4 text-white flex justify-between items-center">
                            <h3 class="font-bold"><i class="fas fa-clipboard-list mr-2"></i>상담일지</h3>
                        </div>
                        <div class="p-4 max-h-[300px] overflow-y-auto">
                            <div id="counsel-logs" class="space-y-3">
                                <p class="text-sm text-slate-400 text-center py-4">학생을 선택하면 상담일지가 표시됩니다.</p>
                            </div>
                        </div>
                    </div>

                    <!-- 첨부파일 -->
                    <div class="glass-card rounded-2xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-amber-500 to-orange-500 p-4 text-white flex justify-between items-center">
                            <h3 class="font-bold"><i class="fas fa-paperclip mr-2"></i>첨부파일</h3>
                        </div>
                        <div class="p-4 max-h-[250px] overflow-y-auto">
                            <div id="maker-file-list" class="space-y-2">
                                <p class="text-sm text-slate-400 text-center py-4">학생을 선택하면 첨부파일이 표시됩니다.</p>
                            </div>
                        </div>
                    </div>

                    <!-- 학급 공통사항 -->
                    <div class="glass-card rounded-2xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-emerald-500 to-green-600 p-4 text-white flex justify-between items-center">
                            <h3 class="font-bold"><i class="fas fa-layer-group mr-2"></i>학급 공통사항</h3>
                        </div>
                        <div class="p-4 max-h-[300px] overflow-y-auto">
                            <div id="maker-common-list" class="space-y-3">
                                <p class="text-sm text-slate-400 text-center py-4">자료를 불러오면 공통사항이 표시됩니다.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 우측: 생기부 작성 필드 -->
                <div class="glass-card rounded-2xl shadow-lg overflow-hidden">
                    <div id="write-header" class="bg-gradient-to-r from-blue-500 to-blue-700 p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-bold"><i class="fas fa-file-signature mr-2"></i>생기부 작성</h3>
                                <p class="text-xs text-white/70 mt-1">기초자료와 상담일지를 참고하여 작성합니다.</p>
                            </div>
                            <span id="curriculum-badge" class="text-xs bg-white/20 px-3 py-1 rounded-full font-bold">2015 교육과정</span>
                        </div>
                    </div>
                    <div class="p-4 space-y-5" id="write-fields-container">
                        <!-- 교육과정에 따라 동적 생성되는 작성 필드 영역 -->
                    </div>
                    <div class="px-4 pb-4">
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="saveDraft()" class="px-4 py-3 bg-slate-100 text-slate-700 rounded-xl font-bold hover:bg-slate-200 transition">
                                <i class="fas fa-save mr-2"></i>임시저장
                            </button>
                            <button onclick="saveComplete()" class="px-4 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl font-bold hover:shadow-lg transition">
                                <i class="fas fa-check mr-2"></i>작성완료
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 학생 미선택 시 안내 -->
            <div id="no-student-view" class="glass-card rounded-2xl shadow-lg p-12 text-center">
                <div class="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-hand-pointer text-4xl text-indigo-500"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">학생을 선택해주세요</h3>
                <p class="text-slate-500">상단에서 학생을 선택하면 생기부 작성을 시작할 수 있습니다.</p>
            </div>
        </div>
    </main>

    <script>
        let currentUser = null;
        let homeroomInfo = null;
        let studentList = [];
        let currentPoint = 0;
        let dataLoaded = false;
        let currentCurriculum = '2015';

        /* ============================================
         * 교육과정별 필드 정의
         * id: textarea ID
         * label: 표시명
         * tag: AI 응답 파싱 태그 (백엔드 result 키)
         * defaultBytes: 기본 바이트 제한
         * rows: textarea 줄 수
         * desc: 항목 설명
         * ============================================ */
        const CURRICULUM_FIELDS = {
            '2015': [
                {
                    id: 'write-behavior',
                    label: '행동특성 및 종합의견',
                    tag: '행동특성및종합의견',
                    defaultBytes: 1500,
                    rows: 8,
                    desc: '학생의 성격, 학습태도, 교우관계, 리더십 등 종합 서술 (담임 입력)'
                },
                {
                    id: 'write-autonomous',
                    label: '자율활동 특기사항',
                    tag: '자율활동',
                    defaultBytes: 1500,
                    rows: 5,
                    desc: '학교행사, 체험학습, 수학여행 참여 등 (담임 입력)'
                },
                {
                    id: 'write-career',
                    label: '진로활동 특기사항',
                    tag: '진로활동',
                    defaultBytes: 2100,
                    rows: 5,
                    desc: '진로 탐색, 직업 체험, 진로 상담 등 (담임 입력)'
                },
                {
                    id: 'write-volunteer',
                    label: '봉사활동',
                    tag: '봉사활동',
                    defaultBytes: 500,
                    rows: 3,
                    desc: '봉사활동 참여 내역과 태도 (독립 영역)'
                }
            ],
            '2022': [
                {
                    id: 'write-behavior',
                    label: '행동특성 및 종합의견',
                    tag: '행동특성및종합의견',
                    defaultBytes: 1500,
                    rows: 8,
                    desc: '학생의 성격, 학습태도, 교우관계 등 종합 서술 (담임 입력)'
                },
                {
                    id: 'write-autonomous',
                    label: '자율·자치활동 특기사항',
                    tag: '자율자치활동',
                    defaultBytes: 1500,
                    rows: 5,
                    desc: '주제 탐구, 자치활동, 학교행사 참여 등 (담임 입력)'
                },
                {
                    id: 'write-career',
                    label: '진로활동 특기사항',
                    tag: '진로활동',
                    defaultBytes: 2100,
                    rows: 5,
                    desc: '진로 탐색, 진로 설계 및 실천 활동 (담임 입력)'
                }
            ]
        };

        /* ============================================
         * 바이트 계산 유틸리티 (UTF-8 기준)
         * ============================================ */
        function getByteLength(str) {
            let bytes = 0;
            for (let i = 0; i < str.length; i++) {
                const code = str.charCodeAt(i);
                if (code <= 0x7F) {
                    bytes += 1;
                } else if (code <= 0x7FF) {
                    bytes += 2;
                } else if (code <= 0xFFFF) {
                    bytes += 3;
                } else {
                    bytes += 4;
                }
            }
            return bytes;
        }

        function updateByteCounter(fieldId) {
            const textarea = document.getElementById(fieldId);
            const counterEl = document.getElementById(fieldId + '-byte-count');
            const barEl = document.getElementById(fieldId + '-byte-bar');
            const limitInput = document.getElementById(fieldId + '-byte-limit');
            if (!textarea || !counterEl || !barEl || !limitInput) return;

            const text = textarea.value;
            const currentBytes = getByteLength(text);
            const charCount = text.length;
            const maxBytes = parseInt(limitInput.value) || 0;

            counterEl.textContent = `${currentBytes.toLocaleString()} / ${maxBytes.toLocaleString()} bytes (${charCount}자)`;

            const ratio = maxBytes > 0 ? (currentBytes / maxBytes) : 0;
            barEl.style.width = Math.min(ratio * 100, 100) + '%';

            if (ratio > 1) {
                counterEl.className = 'text-xs font-bold text-red-600';
                barEl.className = 'byte-bar bg-red-500';
                textarea.style.borderColor = '#ef4444';
            } else if (ratio > 0.9) {
                counterEl.className = 'text-xs font-bold text-amber-600';
                barEl.className = 'byte-bar bg-amber-400';
                textarea.style.borderColor = '#f59e0b';
            } else {
                counterEl.className = 'text-xs font-medium text-slate-400';
                barEl.className = 'byte-bar bg-indigo-400';
                textarea.style.borderColor = '';
            }
        }

        /* ============================================
         * 교육과정 전환
         * ============================================ */
        function switchCurriculum(type) {
            currentCurriculum = type;

            const tab2015 = document.getElementById('cur-tab-2015');
            const tab2022 = document.getElementById('cur-tab-2022');
            const header = document.getElementById('write-header');
            const badge = document.getElementById('curriculum-badge');

            // 탭 스타일 전환
            if (type === '2015') {
                tab2015.className = 'curriculum-tab active-2015 flex-1 py-3 rounded-xl font-bold text-sm transition border-2 border-transparent';
                tab2022.className = 'curriculum-tab flex-1 py-3 rounded-xl font-bold text-sm bg-slate-100 text-slate-500 transition border-2 border-transparent hover:bg-slate-200';
                header.className = 'bg-gradient-to-r from-blue-500 to-blue-700 p-4 text-white';
                badge.textContent = '2015 교육과정';
            } else {
                tab2015.className = 'curriculum-tab flex-1 py-3 rounded-xl font-bold text-sm bg-slate-100 text-slate-500 transition border-2 border-transparent hover:bg-slate-200';
                tab2022.className = 'curriculum-tab active-2022 flex-1 py-3 rounded-xl font-bold text-sm transition border-2 border-transparent';
                header.className = 'bg-gradient-to-r from-purple-500 to-violet-700 p-4 text-white';
                badge.textContent = '2022 교육과정';
            }

            renderWriteFields();
        }

        /* ============================================
         * 작성 필드 동적 렌더링
         * ============================================ */
        function renderWriteFields() {
            const container = document.getElementById('write-fields-container');
            if (!container) return;

            const fields = CURRICULUM_FIELDS[currentCurriculum];

            container.innerHTML = fields.map(f => `
                <div>
                    <div class="flex items-center justify-between mb-1.5">
                        <div>
                            <label class="text-xs font-bold text-slate-600">${f.label}</label>
                            <p class="text-xs text-slate-400">${f.desc}</p>
                        </div>
                        <div class="flex items-center gap-1 flex-shrink-0 ml-2">
                            <input type="number" id="${f.id}-byte-limit"
                                value="${f.defaultBytes}" min="100" max="9999" step="100"
                                class="w-[72px] px-2 py-1 text-xs border border-slate-200 rounded-lg text-center focus:border-indigo-400 outline-none"
                                onchange="updateByteCounter('${f.id}')"
                                title="바이트 제한 설정" />
                            <span class="text-xs text-slate-400">B</span>
                        </div>
                    </div>
                    <textarea id="${f.id}" rows="${f.rows}"
                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 outline-none resize-none text-sm"
                        placeholder="${f.label}을(를) 작성하세요"
                        oninput="updateByteCounter('${f.id}')"></textarea>
                    <div class="flex items-center justify-between mt-1">
                        <div class="flex-1 bg-slate-100 rounded-full h-[3px] mr-3 overflow-hidden">
                            <div id="${f.id}-byte-bar" class="byte-bar bg-indigo-400" style="width:0%"></div>
                        </div>
                        <span id="${f.id}-byte-count" class="text-xs font-medium text-slate-400 whitespace-nowrap">
                            0 / ${f.defaultBytes.toLocaleString()} bytes (0자)
                        </span>
                        <button onclick="copyFieldText('${f.id}')" id="${f.id}-copy-btn"
                            class="ml-2 px-2 py-0.5 text-xs text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition flex items-center gap-1 flex-shrink-0"
                            title="${f.label} 복사">
                            <i class="fas fa-copy"></i><span>복사</span>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        /* ============================================
         * 텍스트 복사 기능
         * ============================================ */
        function copyFieldText(fieldId) {
            const textarea = document.getElementById(fieldId);
            if (!textarea || !textarea.value.trim()) {
                return;
            }
            navigator.clipboard.writeText(textarea.value).then(() => {
                const btn = document.getElementById(fieldId + '-copy-btn');
                if (btn) {
                    const original = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i><span>복사됨</span>';
                    btn.classList.add('text-emerald-600');
                    btn.classList.remove('text-slate-400');
                    setTimeout(() => {
                        btn.innerHTML = original;
                        btn.classList.remove('text-emerald-600');
                        btn.classList.add('text-slate-400');
                    }, 1500);
                }
            }).catch(() => {
                // clipboard API 미지원 시 fallback
                textarea.select();
                document.execCommand('copy');
                window.getSelection().removeAllRanges();
                const btn = document.getElementById(fieldId + '-copy-btn');
                if (btn) {
                    const original = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i><span>복사됨</span>';
                    btn.classList.add('text-emerald-600');
                    btn.classList.remove('text-slate-400');
                    setTimeout(() => {
                        btn.innerHTML = original;
                        btn.classList.remove('text-emerald-600');
                        btn.classList.add('text-slate-400');
                    }, 1500);
                }
            });
        }

        /* ============================================
         * 초기화
         * ============================================ */
        document.addEventListener('DOMContentLoaded', () => {
            const userStr = localStorage.getItem('schoolus_user');
            if (!userStr) {
                alert('로그인이 필요합니다.');
                window.location.href = '/';
                return;
            }
            currentUser = JSON.parse(userStr);
            document.getElementById('teacher-name').textContent = (currentUser.member_name || '') + ' 선생님';
            
            loadUserPoint();
            checkHomeroomTeacher();
            renderWriteFields();
        });

        function getSchoolParams() {
            const params = new URLSearchParams();
            if (currentUser.school_id) params.append('school_id', currentUser.school_id);
            if (currentUser.member_school) params.append('member_school', currentUser.member_school);
            return params;
        }

        /* ============================================
         * 포인트
         * ============================================ */
        async function loadUserPoint() {
            try {
                const url = `/api/teacher/info?member_id=${encodeURIComponent(currentUser.member_id)}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.teacher) {
                    displayPoint(data.teacher.point);
                }
            } catch (error) {
                console.error('포인트 로드 오류:', error);
            }
        }

        function displayPoint(point) {
            const el = document.getElementById('userPoint');
            if (!el) return;
            
            if (point === 'free' || point === 'Free') {
                el.textContent = 'Free';
                currentPoint = 'free';
            } else if (point === null || point === undefined || point === '') {
                el.textContent = '0';
                currentPoint = 0;
            } else {
                const num = parseInt(point);
                currentPoint = isNaN(num) ? 0 : num;
                el.textContent = currentPoint.toLocaleString();
            }
        }

        /* ============================================
         * 담임 확인 + 학생 로드
         * ============================================ */
        async function checkHomeroomTeacher() {
            try {
                const params = getSchoolParams();
                params.append('member_id', currentUser.member_id);
                
                const response = await fetch(`/api/homeroom/check?${params.toString()}`);
                const data = await response.json();
                
                if (data.success && data.is_homeroom) {
                    homeroomInfo = {
                        class_grade: data.class_grade,
                        class_no: data.class_no,
                        teacher_name: data.teacher_name
                    };
                    
                    document.getElementById('class-badge').textContent = `${data.class_grade}학년 ${data.class_no}반 담임`;
                    document.getElementById('no-homeroom-view').classList.add('hidden');
                    document.getElementById('main-view').classList.remove('hidden');
                    
                    // 년도 옵션 설정
                    const yearSelect = document.getElementById('select-year');
                    const currentYear = new Date().getFullYear();
                    yearSelect.innerHTML = '';
                    for (let y = currentYear; y >= currentYear - 2; y--) {
                        yearSelect.innerHTML += `<option value="${y}">${y}년</option>`;
                    }
                    
                    // 학년 기반 교육과정 자동 선택 (3학년=2015, 1~2학년=2022)
                    const autoCurriculum = parseInt(data.class_grade) >= 3 ? '2015' : '2022';
                    if (autoCurriculum !== currentCurriculum) {
                        switchCurriculum(autoCurriculum);
                    }

                    loadStudents();
                } else {
                    document.getElementById('no-homeroom-view').classList.remove('hidden');
                    document.getElementById('main-view').classList.add('hidden');
                }
            } catch (error) {
                console.error('담임 확인 오류:', error);
                document.getElementById('no-homeroom-view').classList.remove('hidden');
            }
        }

        async function loadStudents() {
            try {
                const params = getSchoolParams();
                params.append('class_grade', homeroomInfo.class_grade);
                params.append('class_no', homeroomInfo.class_no);
                
                const response = await fetch(`/api/homeroom/students?${params.toString()}`);
                const data = await response.json();
                
                if (data.success) {
                    studentList = data.students || [];
                    const select = document.getElementById('select-student');
                    select.innerHTML = '<option value="">학생을 선택하세요</option>' + 
                        studentList.map(s => 
                            `<option value="${s.member_id}" data-name="${s.member_name}" data-num="${s.class_num}">${s.class_num}번 ${s.member_name}</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('학생 로드 오류:', error);
            }
        }

        function onStudentChange() {
            const studentId = document.getElementById('select-student').value;
            dataLoaded = false;
            updateGenerateButton();
            
            if (studentId) {
                document.getElementById('work-area').classList.remove('hidden');
                document.getElementById('no-student-view').classList.add('hidden');
            } else {
                document.getElementById('work-area').classList.add('hidden');
                document.getElementById('no-student-view').classList.remove('hidden');
            }
        }

        function updateGenerateButton() {
            const btn = document.getElementById('btn-generate');
            if (dataLoaded) {
                btn.disabled = false;
                btn.className = 'w-full px-4 py-3 bg-gradient-to-r from-pink-500 to-rose-600 text-white rounded-xl font-bold hover:shadow-lg transition cursor-pointer';
            } else {
                btn.disabled = true;
                btn.className = 'w-full px-4 py-3 bg-slate-200 text-slate-400 rounded-xl font-bold cursor-not-allowed transition';
            }
        }

        /* ============================================
         * 학생 데이터 로드
         * ============================================ */
        async function loadStudentData() {
            const studentId = document.getElementById('select-student').value;
            if (!studentId) {
                alert('학생을 먼저 선택해주세요.');
                return;
            }
            
            const recordYear = document.getElementById('select-year').value;
            const recordSemester = document.getElementById('select-semester').value;
            
            // 기초자료 로드
            try {
                const params = getSchoolParams();
                params.append('student_id', studentId);
                params.append('record_year', recordYear);
                params.append('record_semester', recordSemester);
                
                const response = await fetch(`/api/homeroom/student-record/get?${params.toString()}`);
                const data = await response.json();
                
                const baseDataEl = document.getElementById('base-data');
                if (data.success && data.record && data.record.behavior_record) {
                    baseDataEl.textContent = data.record.behavior_record;
                } else {
                    baseDataEl.textContent = '등록된 기초자료가 없습니다.';
                }
            } catch (error) {
                console.error('기초자료 로드 오류:', error);
            }
            
            // 상담일지 로드
            try {
                const params = getSchoolParams();
                params.append('class_grade', homeroomInfo.class_grade);
                params.append('class_no', homeroomInfo.class_no);
                params.append('student_id', studentId);
                
                const response = await fetch(`/api/homeroom/counsel-log/list?${params.toString()}`);
                const data = await response.json();
                
                const logsEl = document.getElementById('counsel-logs');
                if (data.success && data.logs?.length > 0) {
                    logsEl.innerHTML = data.logs.map(l => `
                        <div class="bg-purple-50 rounded-xl p-3 border border-purple-100">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-bold text-purple-600">${l.counsel_type}</span>
                                <span class="text-xs text-slate-400">${l.counsel_date}</span>
                            </div>
                            <p class="text-sm text-slate-700">${l.counsel_content}</p>
                            ${l.counsel_result ? `<p class="text-xs text-slate-500 mt-1"><b>결과:</b> ${l.counsel_result}</p>` : ''}
                        </div>
                    `).join('');
                } else {
                    logsEl.innerHTML = '<p class="text-sm text-slate-400 text-center py-4">등록된 상담일지가 없습니다.</p>';
                }
            } catch (error) {
                console.error('상담일지 로드 오류:', error);
            }

            // 첨부파일 로드
            try {
                const params = getSchoolParams();
                params.append('student_id', studentId);
                params.append('record_year', recordYear);
                params.append('record_semester', recordSemester);
                
                const response = await fetch(`/api/homeroom/counsel-file/list?${params.toString()}`);
                const data = await response.json();
                
                const fileEl = document.getElementById('maker-file-list');
                if (data.success && data.files?.length > 0) {
                    const iconMap = {
                        pdf: 'fa-file-pdf text-red-500',
                        hwp: 'fa-file-alt text-blue-500',
                        hwpx: 'fa-file-alt text-blue-500',
                        doc: 'fa-file-word text-blue-600',
                        docx: 'fa-file-word text-blue-600',
                        xls: 'fa-file-excel text-green-600',
                        xlsx: 'fa-file-excel text-green-600',
                        ppt: 'fa-file-powerpoint text-orange-500',
                        pptx: 'fa-file-powerpoint text-orange-500',
                        jpg: 'fa-file-image text-purple-500',
                        jpeg: 'fa-file-image text-purple-500',
                        png: 'fa-file-image text-purple-500',
                        gif: 'fa-file-image text-pink-500',
                        zip: 'fa-file-archive text-yellow-600'
                    };
                    fileEl.innerHTML = data.files.map(f => {
                        const ext = (f.original_name || '').split('.').pop().toLowerCase();
                        const icon = iconMap[ext] || 'fa-file text-slate-400';
                        const size = f.file_size < 1024 
                            ? f.file_size + 'B' 
                            : (f.file_size / 1024).toFixed(1) + 'KB';
                        return `
                            <div class="flex items-center gap-3 p-2 bg-slate-50 rounded-lg">
                                <i class="fas ${icon}"></i>
                                <span class="flex-1 text-sm text-slate-700 truncate">${f.original_name}</span>
                                <span class="text-xs text-slate-400">${size}</span>
                                <a href="/api/homeroom/counsel-file/download/${f.id}" target="_blank" 
                                    class="text-indigo-500 hover:text-indigo-700">
                                    <i class="fas fa-download"></i>
                                </a>
                            </div>
                        `;
                    }).join('');
                } else {
                    fileEl.innerHTML = '<p class="text-sm text-slate-400 text-center py-4">첨부된 파일이 없습니다.</p>';
                }
            } catch (error) {
                console.error('첨부파일 로드 오류:', error);
            }

            // 학급 공통사항 로드
            try {
                const params = getSchoolParams();
                params.append('class_grade', homeroomInfo.class_grade);
                params.append('class_no', homeroomInfo.class_no);
                params.append('record_year', recordYear);
                params.append('record_semester', recordSemester);
                
                const response = await fetch(`/api/homeroom/common-activity/list?${params.toString()}`);
                const data = await response.json();
                
                const commonEl = document.getElementById('maker-common-list');
                const typeColors = {
                    '수학여행': 'bg-blue-100 text-blue-700',
                    '체험학습': 'bg-green-100 text-green-700',
                    '봉사활동': 'bg-pink-100 text-pink-700',
                    '현장학습': 'bg-orange-100 text-orange-700',
                    '진로체험': 'bg-purple-100 text-purple-700',
                    '학교행사': 'bg-yellow-100 text-yellow-700',
                    '기타': 'bg-slate-100 text-slate-700'
                };
                
                if (data.success && data.activities?.length > 0) {
                    commonEl.innerHTML = data.activities.map(a => {
                        const colorClass = typeColors[a.activity_type] || typeColors['기타'];
                        return `
                            <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs font-bold px-2 py-0.5 rounded-full ${colorClass}">${a.activity_type}</span>
                                    <span class="text-xs text-slate-400">${a.activity_date || ''}</span>
                                </div>
                                <p class="font-bold text-sm text-slate-700">${a.title}</p>
                                <p class="text-xs text-slate-600 mt-1">${a.content || ''}</p>
                            </div>
                        `;
                    }).join('');
                } else {
                    commonEl.innerHTML = '<p class="text-sm text-slate-400 text-center py-4">등록된 공통사항이 없습니다.</p>';
                }
            } catch (error) {
                console.error('공통사항 로드 오류:', error);
            }

            // 데이터 로드 완료 - 버튼 활성화
            dataLoaded = true;
            updateGenerateButton();

            // 기존 저장된 생기부 데이터 불러오기
            await loadSavedRecord(studentId, recordYear, recordSemester);
        }

        /* ============================================
         * AI 생기부 생성
         * ============================================ */
        async function generateRecord() {
            if (!dataLoaded) {
                alert('먼저 자료를 불러와주세요.');
                return;
            }

            const studentSelect = document.getElementById('select-student');
            const studentName = studentSelect.options[studentSelect.selectedIndex]?.dataset?.name || '';
            const fields = CURRICULUM_FIELDS[currentCurriculum];

            // 포인트 확인
            if (currentPoint !== 'free') {
                if (currentPoint < 300) {
                    alert(`포인트가 부족합니다.\n\n현재 포인트: ${currentPoint.toLocaleString()}P\n필요 포인트: 300P`);
                    return;
                }
                
                if (!confirm(`${studentName} 학생의 생기부를 AI로 생성합니다.\n\n적용 교육과정: ${currentCurriculum} 개정교육과정\n300포인트가 차감됩니다.\n현재 포인트: ${currentPoint.toLocaleString()}P\n\n계속하시겠습니까?`)) {
                    return;
                }
            }

            // 버튼 로딩 상태
            const btn = document.getElementById('btn-generate');
            const btnOriginal = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>AI 생성 중...';
            btn.className = 'w-full px-4 py-3 bg-indigo-400 text-white rounded-xl font-bold cursor-wait transition';

            // 텍스트영역 로딩 표시
            fields.forEach(f => {
                const el = document.getElementById(f.id);
                if (el) {
                    el.value = '⏳ AI가 생성 중입니다... 잠시만 기다려주세요.';
                    el.disabled = true;
                }
            });

            // 좌측 데이터 수집
            const baseData = document.getElementById('base-data')?.textContent || '';

            // 상담일지 수집
            const counselLogs = [];
            document.querySelectorAll('#counsel-logs > div').forEach(div => {
                const typeEl = div.querySelector('.text-purple-600');
                const dateEl = div.querySelector('.text-slate-400');
                const contentEl = div.querySelector('.text-slate-700');
                const resultEl = div.querySelector('.text-slate-500 b');
                counselLogs.push({
                    type: typeEl?.textContent?.trim() || '',
                    date: dateEl?.textContent?.trim() || '',
                    content: contentEl?.textContent?.trim() || '',
                    result: resultEl?.parentElement?.textContent?.replace('결과:', '')?.trim() || ''
                });
            });

            // 공통사항 수집
            const commonActivities = [];
            document.querySelectorAll('#maker-common-list > div').forEach(div => {
                const typeEl = div.querySelector('.rounded-full');
                const dateEl = div.querySelectorAll('.text-slate-400')[0];
                const titleEl = div.querySelector('.font-bold.text-slate-700');
                const contentEl = div.querySelector('.text-slate-600');
                commonActivities.push({
                    type: typeEl?.textContent?.trim() || '',
                    date: dateEl?.textContent?.trim() || '',
                    title: titleEl?.textContent?.trim() || '',
                    content: contentEl?.textContent?.trim() || ''
                });
            });

            // 첨부파일 메타정보 수집
            const counselFiles = [];
            document.querySelectorAll('#maker-file-list > div').forEach(div => {
                const nameEl = div.querySelector('.text-slate-700');
                const sizeEl = div.querySelector('.text-slate-400');
                if (nameEl) {
                    counselFiles.push({
                        file_name: nameEl.textContent?.trim() || '',
                        file_size: sizeEl?.textContent?.trim() || ''
                    });
                }
            });

            // 바이트 제한 수집
            const byteLimits = {};
            fields.forEach(f => {
                const limitInput = document.getElementById(f.id + '-byte-limit');
                byteLimits[f.tag] = limitInput ? parseInt(limitInput.value) || f.defaultBytes : f.defaultBytes;
            });

            // Gemini API 호출
            try {
                const response = await fetch('/api/homeroom/generate-record', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        member_id: currentUser.member_id,
                        school_id: currentUser.school_id,
                        student_id: studentSelect.value,
                        student_name: studentName,
                        class_grade: homeroomInfo.class_grade,
                        class_no: homeroomInfo.class_no,
                        base_data: baseData,
                        counsel_logs: counselLogs,
                        counsel_files: counselFiles,
                        common_activities: commonActivities,
                        curriculum_type: currentCurriculum,
                        byte_limits: byteLimits
                    })
                });
                const data = await response.json();

                if (data.success && data.result) {
                    if (data.new_point !== undefined) displayPoint(data.new_point);
                    // 결과를 각 필드의 tag 키로 매핑
                    fields.forEach(f => {
                        const el = document.getElementById(f.id);
                        if (el) {
                            el.value = data.result[f.tag] || '';
                            updateByteCounter(f.id);
                        }
                    });
                } else {
                    if (data.new_point !== undefined) displayPoint(data.new_point);
                    if (data.point_error) {
                        alert(data.message);
                    } else {
                        alert(data.message || 'AI 생성에 실패했습니다.');
                    }
                    fields.forEach(f => {
                        document.getElementById(f.id).value = '';
                    });
                }
            } catch (error) {
                console.error('생기부 생성 오류:', error);
                alert('AI 서비스 연결에 실패했습니다. 다시 시도해주세요.');
                fields.forEach(f => {
                    document.getElementById(f.id).value = '';
                });
            } finally {
                // 버튼 복원
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic mr-2"></i>생기부 생성하기';
                btn.className = 'w-full px-4 py-3 bg-gradient-to-r from-pink-500 to-rose-600 text-white rounded-xl font-bold hover:shadow-lg transition cursor-pointer';
                // 텍스트영역 활성화
                fields.forEach(f => {
                    document.getElementById(f.id).disabled = false;
                });
            }
        }

        /* ============================================
         * 저장된 생기부 데이터 불러오기
         * ============================================ */
        async function loadSavedRecord(studentId, recordYear, recordSemester) {
            try {
                const params = getSchoolParams();
                params.append('student_id', studentId);
                params.append('record_year', recordYear);
                params.append('record_semester', recordSemester);

                const response = await fetch(`/api/homeroom/school-record-gen/get?${params.toString()}`);
                const data = await response.json();

                if (data.success && data.exists && data.record) {
                    const rec = data.record;

                    // 저장된 교육과정으로 전환
                    if (rec.curriculum_type && rec.curriculum_type !== currentCurriculum) {
                        switchCurriculum(rec.curriculum_type);
                    }

                    const fields = CURRICULUM_FIELDS[currentCurriculum];

                    // 바이트 제한값 복원
                    const limitMap = {
                        'write-behavior': rec.behavior_byte_limit,
                        'write-autonomous': rec.autonomous_byte_limit,
                        'write-career': rec.career_byte_limit,
                        'write-volunteer': rec.volunteer_byte_limit
                    };

                    // 필드 내용 복원
                    const contentMap = {
                        'write-behavior': rec.behavior,
                        'write-autonomous': rec.autonomous,
                        'write-career': rec.career,
                        'write-volunteer': rec.volunteer
                    };

                    fields.forEach(f => {
                        // 바이트 제한 복원
                        const limitInput = document.getElementById(f.id + '-byte-limit');
                        if (limitInput && limitMap[f.id]) {
                            limitInput.value = limitMap[f.id];
                        }

                        // 내용 복원
                        const textarea = document.getElementById(f.id);
                        if (textarea && contentMap[f.id]) {
                            textarea.value = contentMap[f.id];
                            updateByteCounter(f.id);
                        }
                    });

                    // 상태 배지 표시
                    updateStatusBadge(rec.status, rec.updated_at);
                }
            } catch (error) {
                console.error('저장된 생기부 로드 오류:', error);
            }
        }

        /* ============================================
         * 상태 배지 업데이트
         * ============================================ */
        function updateStatusBadge(status, updatedAt) {
            let badgeEl = document.getElementById('save-status-badge');

            // 배지가 없으면 생성
            if (!badgeEl) {
                badgeEl = document.createElement('div');
                badgeEl.id = 'save-status-badge';
                badgeEl.className = 'text-center py-2';
                const btnArea = document.querySelector('#write-fields-container')?.parentElement;
                const btnGrid = btnArea?.querySelector('.grid.grid-cols-2');
                if (btnGrid) {
                    btnGrid.parentElement.insertBefore(badgeEl, btnGrid);
                }
            }

            if (!status) {
                badgeEl.innerHTML = '';
                return;
            }

            if (status === 'complete') {
                badgeEl.innerHTML = `
                    <div class="flex items-center justify-center gap-2 text-emerald-600 bg-emerald-50 rounded-lg py-2 px-3 mb-3">
                        <i class="fas fa-check-circle"></i>
                        <span class="text-xs font-bold">작성완료</span>
                        <span class="text-xs text-emerald-500">${updatedAt || ''}</span>
                    </div>
                `;
            } else if (status === 'draft') {
                badgeEl.innerHTML = `
                    <div class="flex items-center justify-center gap-2 text-amber-600 bg-amber-50 rounded-lg py-2 px-3 mb-3">
                        <i class="fas fa-edit"></i>
                        <span class="text-xs font-bold">임시저장</span>
                        <span class="text-xs text-amber-500">${updatedAt || ''}</span>
                    </div>
                `;
            }
        }

        /* ============================================
         * 생기부 저장 공통 함수
         * ============================================ */
        async function saveRecord(status) {
            const studentId = document.getElementById('select-student').value;
            if (!studentId) {
                alert('학생을 먼저 선택해주세요.');
                return;
            }

            const recordYear = document.getElementById('select-year').value;
            const recordSemester = document.getElementById('select-semester').value;
            const fields = CURRICULUM_FIELDS[currentCurriculum];

            // 작성완료 시 빈 필드 확인
            if (status === 'complete') {
                const emptyFields = [];
                fields.forEach(f => {
                    const el = document.getElementById(f.id);
                    if (!el || !el.value.trim()) {
                        emptyFields.push(f.label);
                    }
                });
                if (emptyFields.length > 0) {
                    alert(`다음 항목이 비어있습니다:\n\n- ${emptyFields.join('\n- ')}\n\n모든 항목을 작성 후 완료해주세요.`);
                    return;
                }

                if (!confirm('작성완료로 저장하시겠습니까?\n\n작성완료 후에도 수정이 가능합니다.')) {
                    return;
                }
            }

            // 필드 데이터 수집
            const behavior = document.getElementById('write-behavior')?.value || '';
            const autonomous = document.getElementById('write-autonomous')?.value || '';
            const career = document.getElementById('write-career')?.value || '';
            const volunteer = document.getElementById('write-volunteer')?.value || '';

            // 바이트 제한값 수집
            const behaviorLimit = parseInt(document.getElementById('write-behavior-byte-limit')?.value) || 1500;
            const autonomousLimit = parseInt(document.getElementById('write-autonomous-byte-limit')?.value) || 1500;
            const careerLimit = parseInt(document.getElementById('write-career-byte-limit')?.value) || 2100;
            const volunteerLimit = parseInt(document.getElementById('write-volunteer-byte-limit')?.value) || 500;

            try {
                const response = await fetch('/api/homeroom/school-record-gen/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        school_id: currentUser.school_id,
                        student_id: studentId,
                        record_year: parseInt(recordYear),
                        record_semester: parseInt(recordSemester),
                        curriculum_type: currentCurriculum,
                        behavior: behavior,
                        autonomous: autonomous,
                        career: career,
                        volunteer: volunteer,
                        behavior_byte_limit: behaviorLimit,
                        autonomous_byte_limit: autonomousLimit,
                        career_byte_limit: careerLimit,
                        volunteer_byte_limit: volunteerLimit,
                        status: status
                    })
                });
                const data = await response.json();

                if (data.success) {
                    const now = new Date();
                    const timeStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                    updateStatusBadge(status, timeStr);
                    alert(data.message);
                } else {
                    alert(data.message || '저장에 실패했습니다.');
                }
            } catch (error) {
                console.error('생기부 저장 오류:', error);
                alert('저장 중 오류가 발생했습니다.');
            }
        }

        function saveDraft() {
            saveRecord('draft');
        }

        function saveComplete() {
            saveRecord('complete');
        }
    </script>
<script src="/static/js/help-modal.js" data-doc="school-record"></script>
</body>
</html>