<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- Google Analytics (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7LJ1TCE277"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-7LJ1TCE277');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SchoolUs - 교사 대시보드</title>
    <script src="/static/js/tailwindcss.js"></script>
    <link href="/static/fontawesome/css/all.min.css" rel="stylesheet">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&family=Outfit:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
body { font-family: 'Noto Sans KR', sans-serif; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        #sidebar ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }
        #sidebar ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
        
        /* Sidebar */
        .sidebar-gradient { background: linear-gradient(180deg, #060d1f 0%, #0a1628 40%, #111d35 100%); }
        
        /* Glass card */
        .glass-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(226, 232, 240, 0.6);
        }
        
        /* Nav items */
        .nav-item {
            position: relative;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .nav-item::before {
            content: '';
            position: absolute;
            left: 0; top: 0;
            height: 100%; width: 0;
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.12), transparent);
            border-radius: inherit;
            transition: width 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .nav-item:hover::before { width: 100%; }
        .nav-item:hover { color: #f1f5f9; }
        .nav-item.active {
            background: rgba(59, 130, 246, 0.12);
            border-left: 3px solid #3b82f6;
            color: white;
        }
        
        /* Tab buttons */
        .tab-btn { @apply px-5 py-3 text-sm font-bold text-slate-400 border-b-2 border-transparent hover:text-blue-500 transition-all duration-300 cursor-pointer; }
        .tab-btn.active { @apply text-blue-600 border-blue-600 bg-blue-50/50; }
        
        /* Point card */
        .point-card {
            background: linear-gradient(135deg, #3b6ff5 0%, #6366f1 100%);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        /* Charge button */
        .charge-btn {
            background: rgba(255,255,255,0.18);
            backdrop-filter: blur(4px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .charge-btn:hover {
            background: rgba(255,255,255,0.28);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Avatar ring */
        .avatar-ring { background: linear-gradient(135deg, #3b82f6, #8b5cf6, #ec4899); padding: 2.5px; }
        
        /* Nav scroll hint */
        .nav-wrap { position: relative; }
        .nav-scroll-hint {
            position: absolute; bottom: 0; left: 0; right: 0; height: 40px;
            background: linear-gradient(to bottom, transparent, rgba(10,22,40,0.95));
            display: flex; align-items: flex-end; justify-content: center;
            padding-bottom: 4px; pointer-events: none; transition: opacity 0.3s;
        }
        .nav-scroll-hint.hidden { opacity: 0; }
        .nav-scroll-hint i { color: rgba(148,163,184,0.5); font-size: 14px; animation: bounceDown 1.5s infinite; }
        @keyframes bounceDown { 0%,100% { transform: translateY(0); } 50% { transform: translateY(4px); } }
        
        /* Modal */
        .modal-overlay { animation: fadeIn 0.2s ease; }
        .modal-content { animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Stat card */
        .stat-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
        }
        
        /* Mobile sidebar drawer */
        #mobile-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 40; }
        #mobile-overlay.active { display: block; }
        #sidebar.mobile-open { display: flex !important; position: fixed !important; left: 0 !important; top: 0 !important; bottom: 0 !important; z-index: 50 !important; flex-direction: column !important; }
        
        /* Mobile touch targets */
        @media (max-width: 767px) {
            #sidebar.mobile-open { overflow-y: auto !important; }
            #sidebar.mobile-open .nav-wrap { flex: none !important; min-height: auto !important; }
            #sidebar.mobile-open #sidebar-nav { height: auto !important; overflow: visible !important; }
            .nav-item { min-height: 52px; padding-top: 14px !important; padding-bottom: 14px !important; font-size: 15px !important; }
            #sidebar .space-y-1 > li { margin-bottom: 4px; }
            #sidebar .p-4.border-t a { min-height: 48px; padding-top: 14px !important; padding-bottom: 14px !important; font-size: 14px !important; }
            .tab-btn { min-height: 48px; padding: 12px 16px !important; font-size: 14px !important; white-space: nowrap; }
        }
        
        /* Calendar */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .cal-day-header { @apply text-xs font-bold text-slate-400 py-2; }
        .cal-cell {
            @apply h-10 flex flex-col items-center justify-center rounded-xl cursor-pointer transition-all duration-200 relative text-sm font-medium;
            background: white;
        }
        .cal-cell:hover { @apply bg-slate-100 shadow-sm; transform: scale(1.05); }
        .cal-cell.today {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
        }
        .cal-cell.today .schedule-dot { background: white; }
        .cal-cell.selected { @apply ring-2 ring-offset-1; ring-color: #3b82f6; }
        .cal-cell.other-month { @apply text-slate-300 bg-slate-50; }
        .schedule-dot {
            position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%);
            width: 5px; height: 5px; background: #3b82f6; border-radius: 50%;
        }

        /* === Enhanced Design Overrides === */
        
        /* Sidebar brand section - tighter spacing */
        #sidebar > div:first-child {
            border-color: rgba(255,255,255,0.04) !important;
        }
        
        /* Profile section */
        #sidebar > div:nth-child(2) {
            border-color: rgba(255,255,255,0.04) !important;
            background: rgba(255,255,255,0.02) !important;
        }
        
        /* Sidebar footer links */
        #sidebar .p-4.border-t {
            border-color: rgba(255,255,255,0.04) !important;
        }
        
        /* Header bar refinement */
        header {
            background: rgba(255,255,255,0.92) !important;
            backdrop-filter: blur(16px) saturate(180%) !important;
            -webkit-backdrop-filter: blur(16px) saturate(180%) !important;
            border-color: rgba(226,232,240,0.5) !important;
        }
        
        /* Main content - subtle pattern */
        main {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 50%, #eef2ff 100%) !important;
        }
        
        /* Widget cards - cleaner borders */
        .glass-card {
            box-shadow: 0 1px 3px rgba(15,23,42,0.04), 0 4px 12px rgba(15,23,42,0.03);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .glass-card:hover {
            box-shadow: 0 4px 12px rgba(15,23,42,0.06), 0 12px 32px rgba(15,23,42,0.06);
        }
    </style>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SchoolUs">
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
    <script src="/static/js/pwa-install.js" defer></script>
    <script src="/static/js/pwa-push.js" defer></script>
</head>
<body class="bg-gradient-to-br from-slate-100 via-slate-50 to-blue-50 text-slate-800">

    <div class="flex h-screen overflow-hidden">
        <div id="mobile-overlay"></div>
        <aside id="sidebar" class="w-72 sidebar-gradient text-slate-300 hidden md:flex flex-col flex-shrink-0 shadow-2xl">
            <div class="p-6 border-b border-slate-700/50">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
                        <i class="fas fa-school text-xl"></i>
                    </div>
                    <div>
                        <span class="font-black text-2xl text-white tracking-tight">SchoolUs</span>
                        <p class="text-xs text-slate-400 font-medium">스마트 교육 플랫폼</p>
                    </div>
                </div>
            </div>
            
            <div class="p-5 border-b border-slate-700/50 bg-slate-800/30">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center">
                        <i class="fas fa-building text-white text-sm"></i>
                    </div>
                    <div id="school-name-display" class="text-sm font-bold text-white truncate">-</div>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="avatar-ring rounded-full">
                        <div class="w-14 h-14 rounded-full bg-slate-800 flex items-center justify-center text-white font-black text-xl" id="teacher-avatar">T</div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-white font-bold text-lg truncate" id="teacher-name">-</p>
                        <p class="text-xs text-slate-400 truncate" id="teacher-info">-</p>
                    </div>
                </div>
                
                <div class="mt-4 point-card rounded-xl p-4 text-white relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full -mr-10 -mt-10"></div>
                    <div class="absolute bottom-0 left-0 w-16 h-16 bg-white/10 rounded-full -ml-8 -mb-8"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-medium text-white/80">보유 포인트</span>
                            <i class="fas fa-coins text-yellow-300"></i>
                        </div>
                        <div class="flex items-end gap-1">
                            <span class="text-2xl font-black" id="teacher-point">0</span>
                            <span class="text-sm font-bold mb-0.5">P</span>
                        </div>
                        <button onclick="openChargeModal()" class="mt-3 w-full charge-btn text-white text-xs font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                            <i class="fas fa-plus-circle"></i> 포인트 충전
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex-1 nav-wrap min-h-0">
                <nav id="sidebar-nav" class="h-full overflow-y-auto py-4">
                    <ul class="space-y-1 px-3 mb-4">
                        <li><a href="tea.html" class="nav-item active flex items-center px-4 py-3 rounded-xl text-white font-medium"><i class="fas fa-desktop w-6 mr-3 text-blue-400"></i> 대시보드</a></li>
                    </ul>
                    <ul class="space-y-1 px-3">
                        <li><a href="tea/homeroom.html" class="nav-item flex items-center px-4 py-3 rounded-xl hover:text-white font-medium"><i class="fas fa-chalkboard-user w-6 mr-3 text-green-400"></i> 담임업무</a></li>
                        <li><a href="tea/subject.html" class="nav-item flex items-center px-4 py-3 rounded-xl hover:text-white font-medium"><i class="fas fa-book-open w-6 mr-3 text-purple-400"></i> 교과업무</a></li>
                        <li><a href="/highschool/admission/admission.html" class="nav-item flex items-center px-4 py-3 rounded-xl hover:text-white font-medium"><i class="fas fa-graduation-cap w-6 mr-3 text-pink-400"></i> 입시상담</a></li>
                        <li><a href="tea/schooladmin.html" class="nav-item flex items-center px-4 py-3 rounded-xl hover:text-white font-medium"><i class="fas fa-cog w-6 mr-3 text-yellow-400"></i> 행정업무</a></li>
                    </ul>
                </nav>
                <div id="nav-scroll-hint" class="nav-scroll-hint hidden"><i class="fas fa-chevron-down"></i></div>
            </div>
            
            <div class="p-4 border-t border-slate-700/50 space-y-2">
                <a href="#" onclick="openTeacherInfoModal()" class="flex items-center justify-center w-full py-3 bg-slate-800/50 hover:bg-emerald-500/20 hover:text-emerald-400 rounded-xl text-sm font-medium transition-all"><i class="fas fa-id-card mr-2"></i> 학급 담임 및 부서입력</a>
                <a href="mypage.html" class="flex items-center justify-center w-full py-3 bg-slate-800/50 hover:bg-blue-500/20 hover:text-blue-400 rounded-xl text-sm font-medium transition-all"><i class="fas fa-user-cog mr-2"></i> 회원정보 수정</a>
                <a href="#" onclick="handleLogout()" class="flex items-center justify-center w-full py-3 bg-slate-800/50 hover:bg-red-500/20 hover:text-red-400 rounded-xl text-sm font-medium transition-all"><i class="fas fa-sign-out-alt mr-2"></i> 로그아웃</a>
            </div>
        </aside>

        <div class="flex-1 flex flex-col h-screen overflow-hidden">
            <header class="bg-white/80 backdrop-blur-lg h-16 border-b border-slate-200/50 flex items-center justify-between px-6 shadow-sm z-10">
                <div class="flex items-center gap-4">
                    <button id="sidebar-toggle" class="md:hidden text-slate-600" onclick="toggleMobileSidebar()"><i class="fas fa-bars text-xl"></i></button>
                    <div class="flex items-center text-slate-500">
                        <span class="text-sm font-medium" id="current-semester-label"></span>
                        <i class="fas fa-chevron-right mx-2 text-xs text-slate-300"></i>
                        <span class="text-sm font-bold text-slate-700">나의 대시보드</span>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="hidden sm:flex items-center gap-3 bg-slate-100 rounded-xl px-4 py-2">
                        <i class="fas fa-calendar-day text-blue-500"></i>
                        <div class="text-right">
                            <p class="font-bold text-slate-700 text-sm" id="current-date">-</p>
                            <p class="text-xs text-slate-400">오늘</p>
                        </div>
                    </div>
                    <button class="relative w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center text-slate-500 hover:bg-slate-200 transition" onclick="toggleNotificationPanel()">
                        <i class="fas fa-bell"></i>
                        <span id="notification-badge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center font-bold">0</span>
                    </button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-6">
                <!-- 온보딩 배너: class_no 미설정 시 표시 -->
                <div id="onboarding-banner" class="hidden mb-4 p-4 bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-200 rounded-2xl flex items-center gap-4">
                    <div class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-amber-500"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-bold text-amber-800">학급 설정이 필요합니다</p>
                        <p class="text-sm text-amber-600">담임 학급을 설정해야 학급 시간표, 출결 관리 등을 사용할 수 있습니다.</p>
                    </div>
                    <button onclick="openSettingsPopup()" class="px-4 py-2 bg-amber-500 text-white rounded-xl font-bold text-sm hover:bg-amber-600 transition whitespace-nowrap">설정하기</button>
                </div>

                <div class="mb-6">
                    <h1 class="text-2xl font-black text-slate-800" id="welcome-message">환영합니다!</h1>
                    <p class="text-slate-500 text-sm mt-1">오늘도 좋은 하루 되세요 ✨</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-6">
                    <div class="stat-card glass-card rounded-2xl p-5 shadow-lg shadow-slate-200/50 flex items-center justify-between hover:shadow-xl">
                        <div>
                            <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">다음 수업</p>
                            <h3 class="text-xl font-black text-slate-800" id="next-class-subject">-</h3>
                            <p class="text-sm text-blue-600 font-semibold" id="next-class-time">일정 없음</p>
                        </div>
                        <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-blue-500/30"><i class="fas fa-chalkboard-teacher"></i></div>
                    </div>
                    
                    <div class="stat-card glass-card rounded-2xl p-5 shadow-lg shadow-slate-200/50 flex items-center justify-between hover:shadow-xl">
                        <div class="flex-1 min-w-0">
                            <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">오늘의 급식</p>
                            <h3 class="text-lg font-black text-slate-800 mb-2">중식</h3>
                            <div id="meal-menu" class="space-y-0.5 overflow-y-auto max-h-16"><p class="text-xs text-slate-500">로딩중...</p></div>
                        </div>
                        <div class="w-14 h-14 bg-gradient-to-br from-emerald-500 to-green-600 text-white rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-green-500/30"><i class="fas fa-utensils"></i></div>
                    </div>
                    
                    <div class="stat-card glass-card rounded-2xl p-5 shadow-lg shadow-slate-200/50 flex items-center justify-between hover:shadow-xl cursor-pointer" onclick="window.open('https://www.neis.go.kr', '_blank')">
                        <div>
                            <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">나이스(NEIS)</p>
                            <h3 class="text-xl font-black text-slate-800">업무포털</h3>
                            <p class="text-sm text-orange-500 font-semibold">바로가기 →</p>
                        </div>
                        <div class="w-14 h-14 bg-gradient-to-br from-orange-500 to-amber-600 text-white rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-orange-500/30"><i class="fas fa-external-link-alt"></i></div>
                    </div>
                </div>

                <!-- 오늘의 할 일 위젯 -->
                <div class="glass-card rounded-2xl shadow-lg shadow-slate-200/50 mb-4 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-slate-800 flex items-center"><i class="fas fa-tasks mr-2 text-indigo-500"></i>오늘의 할 일</h3>
                        <span id="todo-count" class="text-xs bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full font-bold">0건</span>
                    </div>
                    <div id="todo-widget" class="flex flex-wrap gap-2">
                        <p class="text-sm text-slate-400 text-center py-2 w-full">확인 중...</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" style="height: calc(100vh - 380px);">
                    <div class="glass-card rounded-2xl shadow-lg shadow-slate-200/50 flex flex-col overflow-hidden">
                        <div class="flex border-b border-slate-100 px-2 pt-2 gap-1 bg-slate-50/50">
                            <button onclick="loadTodayTimetable('my')" id="btn-tt-my" class="tab-btn active rounded-t-xl"><i class="fas fa-user-clock mr-2"></i>나의 시간표</button>
                            <button onclick="loadTodayTimetable('class')" id="btn-tt-class" class="tab-btn rounded-t-xl"><i class="fas fa-users mr-2"></i>우리반</button>
                        </div>
                        <div class="p-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
                            <div class="flex items-center justify-between">
                                <div><p class="text-xs text-white/70 font-medium">오늘</p><p class="text-lg font-black" id="today-day">-</p></div>
                                <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center"><i class="fas fa-calendar-day"></i></div>
                            </div>
                        </div>
                        <div class="flex-1 p-4 overflow-auto bg-white"><div id="today-timetable" class="space-y-2"></div></div>
                    </div>

                    <div class="glass-card rounded-2xl shadow-lg shadow-slate-200/50 flex flex-col overflow-hidden">
                        <div class="p-4 bg-gradient-to-r from-amber-500 to-orange-600 text-white">
                            <div class="flex items-center justify-between">
                                <div onclick="location.href='notice.html'" class="flex items-center gap-2 cursor-pointer hover:opacity-80 transition"><i class="fas fa-bullhorn"></i><span class="font-bold">공지사항</span><i class="fas fa-chevron-right text-xs opacity-60"></i></div>
                                <button onclick="openNoticeModal()" class="w-8 h-8 bg-white/20 hover:bg-white/30 rounded-lg flex items-center justify-center transition"><i class="fas fa-plus text-sm"></i></button>
                            </div>
                        </div>
                        <div class="flex-1 overflow-auto p-4 bg-white"><div id="notice-list" class="space-y-3"></div></div>
                    </div>

                    <div class="glass-card rounded-2xl shadow-lg shadow-slate-200/50 flex flex-col overflow-hidden">
                        <div class="p-4 bg-gradient-to-r from-cyan-500 to-blue-600 text-white">
                            <div class="flex items-center justify-between">
                                <div onclick="openMsgPopup()" class="flex items-center gap-2 cursor-pointer hover:opacity-80 transition"><i class="fas fa-comments"></i><span class="font-bold">메시지</span><span id="dash-msg-count" class="hidden text-xs bg-white/30 rounded-full px-2 py-0.5 ml-1">0</span><i class="fas fa-chevron-right text-xs opacity-60"></i></div>
                                <button onclick="openMsgPopup()" class="w-8 h-8 bg-white/20 hover:bg-white/30 rounded-lg flex items-center justify-center transition"><i class="fas fa-arrow-right text-sm"></i></button>
                            </div>
                        </div>
                        <div class="flex-1 overflow-auto p-3 bg-white">
                            <div id="dash-msg-list" class="space-y-2">
                                <div class="text-center py-8 text-slate-300"><i class="fas fa-comments text-2xl mb-2"></i><p class="text-xs font-medium">메시지가 없습니다.</p></div>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl shadow-lg shadow-slate-200/50 flex flex-col overflow-hidden">
                        <div class="p-5 pb-3 bg-gradient-to-r from-indigo-500 to-purple-600">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-white flex items-center text-lg"><i class="far fa-calendar-alt mr-2"></i>일정</h3>
                                <button onclick="openScheduleModal()" class="w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 text-white flex items-center justify-center transition"><i class="fas fa-plus text-sm"></i></button>
                            </div>
                            <div class="flex justify-between items-center bg-white/10 rounded-xl px-4 py-2">
                                <button onclick="changeMonth(-1)" class="text-white/70 hover:text-white transition"><i class="fas fa-chevron-left"></i></button>
                                <span id="cal-title" class="text-sm font-bold text-white">-</span>
                                <button onclick="changeMonth(1)" class="text-white/70 hover:text-white transition"><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                        <div class="p-4 flex-1 overflow-y-auto bg-gradient-to-b from-slate-50 to-white">
                            <div class="calendar-grid mb-2">
                                <div class="cal-day-header text-red-400">일</div><div class="cal-day-header">월</div><div class="cal-day-header">화</div><div class="cal-day-header">수</div><div class="cal-day-header">목</div><div class="cal-day-header">금</div><div class="cal-day-header text-blue-400">토</div>
                            </div>
                            <div id="calendar-body" class="calendar-grid mb-4"></div>
                            <div class="border-t border-slate-100 pt-4">
                                <p class="text-xs font-bold text-slate-500 mb-3 flex items-center"><i class="fas fa-list-ul mr-2 text-indigo-500"></i><span id="selected-date-title">오늘의 일정</span></p>
                                <div id="selected-date-list" class="space-y-2 max-h-32 overflow-y-auto">
                                    <div class="text-center py-6 text-slate-300"><i class="fas fa-inbox text-2xl mb-2"></i><p class="text-xs font-medium">일정이 없습니다.</p></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 포인트 충전 모달 -->
    <div id="charge-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-overlay absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeChargeModal()"></div>
        <div class="modal-content glass-card rounded-3xl shadow-2xl w-full max-w-md relative z-10 overflow-hidden border border-white/50">
            <div class="bg-gradient-to-r from-amber-500 to-orange-600 p-6 text-white">
                <button onclick="closeChargeModal()" class="absolute top-4 right-4 text-white/70 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center"><i class="fas fa-coins text-2xl"></i></div>
                    <div>
                        <h2 class="text-xl font-black">포인트 충전</h2>
                        <p class="text-sm text-white/80">원하는 금액을 선택하세요</p>
                    </div>
                </div>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button onclick="selectChargeAmount(1000)" class="charge-amount-btn p-4 rounded-xl border-2 border-slate-200 hover:border-amber-500 hover:bg-amber-50 transition text-center">
                        <span class="text-lg font-black text-slate-700">1,000</span><span class="text-sm text-slate-500">P</span>
                    </button>
                    <button onclick="selectChargeAmount(5000)" class="charge-amount-btn p-4 rounded-xl border-2 border-slate-200 hover:border-amber-500 hover:bg-amber-50 transition text-center">
                        <span class="text-lg font-black text-slate-700">5,000</span><span class="text-sm text-slate-500">P</span>
                    </button>
                    <button onclick="selectChargeAmount(10000)" class="charge-amount-btn p-4 rounded-xl border-2 border-slate-200 hover:border-amber-500 hover:bg-amber-50 transition text-center">
                        <span class="text-lg font-black text-slate-700">10,000</span><span class="text-sm text-slate-500">P</span>
                    </button>
                    <button onclick="selectChargeAmount(50000)" class="charge-amount-btn p-4 rounded-xl border-2 border-slate-200 hover:border-amber-500 hover:bg-amber-50 transition text-center">
                        <span class="text-lg font-black text-slate-700">50,000</span><span class="text-sm text-slate-500">P</span>
                    </button>
                </div>
                <div class="mb-6">
                    <label class="block text-xs font-bold text-slate-500 mb-2">직접 입력</label>
                    <div class="relative">
                        <input type="number" id="custom-charge-amount" placeholder="충전할 포인트 입력" class="w-full px-4 py-3 pr-12 border-2 border-slate-200 rounded-xl focus:border-amber-500 focus:ring-4 focus:ring-amber-500/10 outline-none font-bold text-slate-700">
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">P</span>
                    </div>
                </div>
                <button onclick="processCharge()" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 text-white font-black py-4 rounded-xl shadow-lg shadow-amber-500/30 hover:shadow-xl hover:shadow-amber-500/40 transition-all">충전하기</button>
            </div>
        </div>
    </div>

    <!-- 공지사항 등록 모달 (교사 전용) -->
    <div id="notice-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-overlay absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeNoticeModal()"></div>
        <div class="modal-content glass-card rounded-3xl shadow-2xl w-full max-w-lg relative z-10 overflow-hidden border border-white/50">
            <div class="bg-gradient-to-r from-amber-500 to-orange-600 p-6 text-white">
                <button onclick="closeNoticeModal()" class="absolute top-4 right-4 text-white/70 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center"><i class="fas fa-bullhorn text-2xl"></i></div>
                    <div><h2 class="text-xl font-black">공지사항 등록</h2><p class="text-sm text-white/80">새 공지사항을 작성하세요</p></div>
                </div>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 mb-2">제목</label>
                    <input type="text" id="notice-title" placeholder="공지사항 제목" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-amber-500 focus:ring-4 focus:ring-amber-500/10 outline-none font-medium text-slate-700">
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 mb-2">내용</label>
                    <textarea id="notice-message" rows="5" placeholder="공지사항 내용을 입력하세요" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-amber-500 focus:ring-4 focus:ring-amber-500/10 outline-none font-medium text-slate-700 resize-none"></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 mb-2">수정/삭제 비밀번호 (4자리 이상)</label>
                    <input type="password" id="notice-correct-no" placeholder="비밀번호 입력" maxlength="20" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-amber-500 focus:ring-4 focus:ring-amber-500/10 outline-none font-medium text-slate-700">
                </div>
                <p class="text-xs text-slate-400 mb-4"><i class="fas fa-info-circle mr-1"></i>공지사항은 학교 전체(교사, 학생, 학부모)에게 공개됩니다.</p>
                <button onclick="submitNotice()" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 text-white font-black py-4 rounded-xl shadow-lg shadow-amber-500/30 hover:shadow-xl hover:shadow-amber-500/40 transition-all">등록하기</button>
            </div>
        </div>
    </div>

    <!-- 일정 등록 모달 -->
    <div id="schedule-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-overlay absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeScheduleModal()"></div>
        <div class="modal-content glass-card rounded-3xl shadow-2xl w-full max-w-md relative z-10 overflow-hidden border border-white/50">
            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-6 text-white">
                <button onclick="closeScheduleModal()" class="absolute top-4 right-4 text-white/70 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center"><i class="far fa-calendar-plus text-2xl"></i></div>
                    <div><h2 id="schedule-modal-title" class="text-xl font-black">일정 등록</h2><p id="schedule-modal-desc" class="text-sm text-white/80">새 일정을 추가하세요</p></div>
                </div>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 mb-2">일정 제목</label>
                    <input type="text" id="schedule-title" placeholder="일정 제목" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 outline-none font-medium text-slate-700">
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 mb-2">날짜 및 시간</label>
                    <input type="datetime-local" id="schedule-date" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 outline-none font-medium text-slate-700">
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 mb-2">내용 (선택)</label>
                    <textarea id="schedule-content" rows="3" placeholder="상세 내용" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 outline-none font-medium text-slate-700 resize-none"></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 mb-2">공개 대상</label>
                    <div id="schedule-read-roll" class="flex flex-wrap gap-2">
                        <label class="flex items-center gap-2 px-3 py-2 border-2 border-slate-200 rounded-xl cursor-pointer hover:border-indigo-300 transition has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50">
                            <input type="checkbox" name="read_roll" value="self" checked class="accent-indigo-500"> <span class="text-sm font-medium text-slate-700">나만 보기</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 border-2 border-slate-200 rounded-xl cursor-pointer hover:border-indigo-300 transition has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50">
                            <input type="checkbox" name="read_roll" value="teacher" class="accent-indigo-500"> <span class="text-sm font-medium text-slate-700">교사</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 border-2 border-slate-200 rounded-xl cursor-pointer hover:border-indigo-300 transition has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50">
                            <input type="checkbox" name="read_roll" value="student" class="accent-indigo-500"> <span class="text-sm font-medium text-slate-700">학생</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 border-2 border-slate-200 rounded-xl cursor-pointer hover:border-indigo-300 transition has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50">
                            <input type="checkbox" name="read_roll" value="parent" class="accent-indigo-500"> <span class="text-sm font-medium text-slate-700">학부모</span>
                        </label>
                    </div>
                    <p class="text-xs text-slate-400 mt-1">여러 대상을 동시에 선택할 수 있습니다.</p>
                </div>
                <button onclick="submitSchedule()" id="schedule-submit-btn" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-black py-4 rounded-xl shadow-lg shadow-indigo-500/30 hover:shadow-xl transition-all">등록하기</button>
            </div>
        </div>
    </div>

    <!-- ★ 학급 담임 및 부서입력 모달 ★ -->
    <div id="teacher-info-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-overlay absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeTeacherInfoModal()"></div>
        <div class="modal-content glass-card rounded-3xl shadow-2xl w-full max-w-md relative z-10 overflow-hidden border border-white/50">
            <div class="bg-gradient-to-r from-emerald-500 to-teal-600 p-6 text-white">
                <button onclick="closeTeacherInfoModal()" class="absolute top-4 right-4 text-white/70 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center"><i class="fas fa-id-card text-2xl"></i></div>
                    <div><h2 class="text-xl font-black">학급 담임 및 부서입력</h2><p class="text-sm text-white/80">담임/부서 정보를 수정합니다</p></div>
                </div>
            </div>
            <!-- 1단계: 비밀번호 확인 -->
            <div id="ti-pw-step" class="p-6">
                <p class="text-sm text-slate-500 mb-4">본인 확인을 위해 현재 비밀번호를 입력해주세요.</p>
                <input type="password" id="ti-password" placeholder="현재 비밀번호" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 outline-none font-medium text-slate-700 mb-4" onkeydown="if(event.key==='Enter') verifyTeacherInfoPw()">
                <button onclick="verifyTeacherInfoPw()" class="w-full bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-black py-3 rounded-xl shadow-lg shadow-emerald-500/30 hover:shadow-xl transition-all">확인</button>
            </div>
            <!-- 2단계: 정보 수정 폼 -->
            <div id="ti-form-step" class="hidden p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-2">부서</label>
                        <input type="text" id="ti-department" placeholder="예: 교무기획, 학생생활지도" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 outline-none font-medium text-slate-700">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-2">담당업무</label>
                        <input type="text" id="ti-position" placeholder="예: 부장, 기획" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 outline-none font-medium text-slate-700">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2">담임 학년</label>
                            <select id="ti-grade" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 outline-none font-medium text-slate-700">
                                <option value="">선택안함</option>
                                <option value="1">1학년</option>
                                <option value="2">2학년</option>
                                <option value="3">3학년</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2">담임 반</label>
                            <select id="ti-classno" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 outline-none font-medium text-slate-700">
                                <option value="">선택안함</option>
                                <option value="1">1반</option><option value="2">2반</option><option value="3">3반</option>
                                <option value="4">4반</option><option value="5">5반</option><option value="6">6반</option>
                                <option value="7">7반</option><option value="8">8반</option><option value="9">9반</option>
                                <option value="10">10반</option><option value="11">11반</option><option value="12">12반</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button onclick="saveTeacherInfo()" class="w-full mt-6 bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-black py-4 rounded-xl shadow-lg shadow-emerald-500/30 hover:shadow-xl transition-all">저장</button>
            </div>
        </div>
    </div>

    <!-- ★ 동명이인 시간표 매칭 모달 ★ -->
    <div id="timetable-match-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeTimetableMatch()"></div>
        <div class="modal-content glass-card rounded-3xl shadow-2xl w-full max-w-md relative z-10 overflow-hidden border border-white/50">
            <div class="bg-gradient-to-r from-amber-500 to-orange-600 p-6 text-white">
                <button onclick="closeTimetableMatch()" class="absolute top-4 right-4 text-white/70 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center"><i class="fas fa-user-check text-2xl"></i></div>
                    <div><h2 class="text-xl font-black">시간표 데이터 확인</h2><p class="text-sm text-white/80">본인의 수업을 선택해 주세요</p></div>
                </div>
            </div>
            <div class="p-6">
                <p class="text-sm text-slate-600 mb-4">같은 이름의 교사가 여러 명 있습니다.<br>아래에서 본인이 담당하는 수업을 선택해 주세요.</p>
                <div id="match-entries" class="space-y-2 max-h-60 overflow-y-auto"></div>
                <div class="flex gap-3 mt-6">
                    <button onclick="closeTimetableMatch()" class="flex-1 py-3 rounded-xl border-2 border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition-all">나중에</button>
                    <button onclick="submitTimetableMatch()" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-amber-500 to-orange-600 text-white font-bold shadow-lg hover:shadow-xl transition-all">확인</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ★ 학교 계약 안내 팝업 ★ -->
    <div id="announce-popup" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeAnnouncePopup(false)"></div>
        <div class="modal-content glass-card rounded-3xl shadow-2xl w-full max-w-md relative z-10 overflow-hidden border border-white/50">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white text-center">
                <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-bullhorn text-3xl"></i>
                </div>
                <h2 class="text-xl font-black">안내</h2>
            </div>
            <div class="p-6">
                <p class="text-slate-700 text-[15px] leading-relaxed font-medium text-center">
                    학교별 계약을 통해 소속 학교의 모든 교사는<br>모든 기능을 자유롭게 사용하실 수 있습니다.
                </p>
                <div class="mt-4 bg-blue-50 border border-blue-200 rounded-xl p-4 text-center">
                    <p class="text-blue-800 font-bold text-sm">
                        <i class="fas fa-phone-alt mr-2"></i>문의 전화 010-5291-6965
                    </p>
                    <p class="text-blue-600 text-xs mt-1">(문자를 남겨 주시면 연락 드리겠습니다.)</p>
                </div>
                <div class="mt-6 space-y-3">
                    <button onclick="closeAnnouncePopup(false)" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg hover:shadow-xl transition-all">
                        확인
                    </button>
                    <button onclick="closeAnnouncePopup(true)" class="w-full text-slate-400 hover:text-slate-600 text-sm font-medium py-2 transition-colors flex items-center justify-center gap-2">
                        <i class="far fa-clock"></i> 24시간 보지 않기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let teacherInfo = null;
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();

        document.addEventListener('DOMContentLoaded', async () => {
            const userStr = localStorage.getItem('schoolus_user');
            if (!userStr) { alert('로그인이 필요합니다.'); window.location.href = '/'; return; }
            currentUser = JSON.parse(userStr);
            if (!currentUser.school_id) console.warn('school_id가 없습니다.');
            
            updateCurrentDate();
            // 학년도/학기 동적 표시
            (function() {
                const now = new Date();
                const m = now.getMonth() + 1;
                const year = m >= 3 ? now.getFullYear() : now.getFullYear() - 1;
                const semester = (m >= 3 && m <= 8) ? 1 : 2;
                const el = document.getElementById('current-semester-label');
                if (el) el.textContent = `${year}학년도 ${semester}학기`;
            })();
            displayBasicInfo();
            loadTeacherInfo();
            loadTodayMeal();
            loadTodayTimetable('my');
            loadNoticeList();
            loadSchedules();
            loadTodoWidget();
            updateNotificationBadge();
            initPushNotifications();
            
            // 안내 팝업 표시 (0.5초 후)
            setTimeout(showAnnouncePopup, 500);

            // 동명이인 시간표 매칭 확인 (1초 후)
            setTimeout(checkTimetableMatch, 1000);
        });

        // ============================================
        // 안내 팝업
        // ============================================
        function showAnnouncePopup() {
            const hideUntil = localStorage.getItem('schoolus_announce_hide_until');
            if (hideUntil && new Date().getTime() < parseInt(hideUntil)) return;
            document.getElementById('announce-popup').classList.remove('hidden');
        }

        function closeAnnouncePopup(hide24h) {
            document.getElementById('announce-popup').classList.add('hidden');
            if (hide24h) {
                const hideUntil = new Date().getTime() + (24 * 60 * 60 * 1000);
                localStorage.setItem('schoolus_announce_hide_until', hideUntil.toString());
            }
        }

        function getSchoolParams() {
            const params = new URLSearchParams();
            if (currentUser.school_id) params.append('school_id', currentUser.school_id);
            if (currentUser.member_school) params.append('member_school', currentUser.member_school);
            return params;
        }

        function displayBasicInfo() {
            const name = currentUser?.member_name || '사용자';
            const school = currentUser?.member_school || '-';
            setText('school-name-display', school);
            setText('teacher-name', name + ' 선생님');
            setText('teacher-avatar', name.charAt(0) || 'T');
            setText('welcome-message', `${name} 선생님, 반갑습니다!`);
        }

        function setText(id, text) { const el = document.getElementById(id); if (el) el.textContent = text || '-'; }

        function updateCurrentDate() {
            const now = new Date();
            const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
            setText('current-date', now.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'short' }));
            setText('today-day', dayNames[now.getDay()] + '요일');
        }

        async function loadTeacherInfo() {
            try {
                const params = new URLSearchParams();
                params.append('member_id', currentUser.member_id);
                if (currentUser.school_id) params.append('school_id', currentUser.school_id);
                
                const response = await fetch(`/api/teacher/info?${params.toString()}`);
                const data = await response.json();
                
                if (!data.success || !data.teacher) return;
                teacherInfo = data.teacher;
                
                if (teacherInfo.member_school) setText('school-name-display', teacherInfo.member_school);
                if (teacherInfo.member_name) {
                    setText('teacher-name', teacherInfo.member_name + ' 선생님');
                    setText('teacher-avatar', teacherInfo.member_name.charAt(0));
                    setText('welcome-message', `${teacherInfo.member_name} 선생님, 반갑습니다!`);
                }
                
                let infoText = '';
                if (teacherInfo.class_grade && teacherInfo.class_no) infoText = `${teacherInfo.class_grade}학년 ${teacherInfo.class_no}반 담임`;
                if (teacherInfo.department) infoText = infoText ? `${infoText} | ${teacherInfo.department}` : teacherInfo.department;
                setText('teacher-info', infoText || '담당 정보 없음');
                displayPoint(teacherInfo.point);
                
                if (teacherInfo.school_id && !currentUser.school_id) {
                    currentUser.school_id = teacherInfo.school_id;
                    localStorage.setItem('schoolus_user', JSON.stringify(currentUser));
                }

                // 온보딩 배너: class_no 미설정 시 표시
                if (!teacherInfo.class_no) {
                    const banner = document.getElementById('onboarding-banner');
                    if (banner) banner.classList.remove('hidden');
                }
            } catch (error) { console.error('교사 정보 로드 오류:', error); }
        }

        function displayPoint(point) {
            const el = document.getElementById('teacher-point');
            if (!el) return;
            if (point === 'free' || point === 'Free') el.textContent = 'Free';
            else if (point === null || point === undefined || point === '') el.textContent = '0';
            else { const num = parseInt(point); el.textContent = isNaN(num) ? '0' : num.toLocaleString(); }
        }

        async function loadTodayMeal() {
            const container = document.getElementById('meal-menu');
            if (!container) return;
            try {
                const now = new Date();
                const month = now.getMonth() + 1;
                const day = now.getDate();
                const params = getSchoolParams();
                params.append('month', month);
                params.append('day', day);
                const response = await fetch(`/api/meal/today?${params.toString()}`);
                const data = await response.json();
                if (data.success && data.meal?.menu) {
                    const items = data.meal.menu.split(/[\n,]/).filter(item => item.trim());
                    container.innerHTML = items.map(item => `<p class="text-sm text-slate-600">• ${item.trim()}</p>`).join('');
                } else container.innerHTML = '<p class="text-xs text-slate-400">오늘의 급식 정보가 없습니다.</p>';
            } catch (error) { container.innerHTML = '<p class="text-xs text-slate-400">급식 정보를 불러올 수 없습니다.</p>'; }
        }

        async function loadTodayTimetable(type) {
            document.getElementById('btn-tt-my')?.classList.toggle('active', type === 'my');
            document.getElementById('btn-tt-class')?.classList.toggle('active', type === 'class');
            const container = document.getElementById('today-timetable');
            if (!container) return;
            container.innerHTML = '<div class="text-center py-8 text-slate-300"><i class="fas fa-spinner fa-spin text-2xl"></i></div>';
            try {
                let params = getSchoolParams();
                let url;
                if (type === 'my') {
                    if (currentUser.member_id) params.append('member_id', currentUser.member_id);
                    params.append('member_name', currentUser.member_name);
                    url = `/api/timetable/teacher?${params.toString()}`;
                } else {
                    if (!teacherInfo?.class_grade || !teacherInfo?.class_no) {
                        container.innerHTML = '<div class="text-center py-8 text-slate-400"><i class="fas fa-info-circle text-2xl mb-2"></i><p class="text-xs">학급 설정이 필요합니다.</p><a href="javascript:void(0)" onclick="openSettingsPopup()" class="text-xs text-blue-500 hover:underline mt-1 inline-block">설정 바로가기 →</a></div>';
                        return;
                    }
                    params.append('grade', teacherInfo.class_grade);
                    params.append('class_no', teacherInfo.class_no);
                    url = `/api/timetable/class?${params.toString()}`;
                }
                const response = await fetch(url);
                const data = await response.json();
                if (data.success && data.timetable?.length > 0) {
                    let html = '';
                    for (let i = 1; i <= 7; i++) {
                        const lesson = data.timetable.find(t => t.period == i);
                        if (lesson) {
                            if (lesson.changed) {
                                const isCancel = lesson.change_type === 'cancelled';
                                const isCover = lesson.change_type === 'cover';
                                const badgeText = isCancel ? lesson.change_reason || '변경' : (isCover ? '보강' : '변경');
                                const subInfo = type === 'my' ? `${lesson.grade}-${lesson.class_no}반` : (lesson.member_name || '');
                                const origSubj = lesson.original_subject && lesson.original_subject !== lesson.subject ? `<span class="line-through text-orange-300 mr-1">${lesson.original_subject}</span>→ ` : '';
                                const coverInfo = isCover && lesson.original_teacher ? ` <span class="text-orange-300">(원래: ${lesson.original_teacher})</span>` : '';
                                html += `<div class="flex items-center gap-3 p-3 bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl border border-orange-200"><div class="w-8 h-8 bg-orange-500 text-white rounded-lg flex items-center justify-center font-bold text-sm">${i}</div><div class="flex-1"><p class="font-bold text-orange-700">${origSubj}${lesson.subject} <span class="text-xs font-normal bg-orange-100 text-orange-600 px-1.5 py-0.5 rounded-full ml-1">${badgeText}</span></p><p class="text-xs text-orange-400">${subInfo}${coverInfo}</p></div></div>`;
                            } else {
                                html += `<div class="flex items-center gap-3 p-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100"><div class="w-8 h-8 bg-blue-500 text-white rounded-lg flex items-center justify-center font-bold text-sm">${i}</div><div class="flex-1"><p class="font-bold text-slate-800">${lesson.subject}</p><p class="text-xs text-slate-500">${type === 'my' ? `${lesson.grade}-${lesson.class_no}반` : (lesson.member_name || '')}</p></div></div>`;
                            }
                        } else {
                            html += `<div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl border border-slate-100"><div class="w-8 h-8 bg-slate-300 text-white rounded-lg flex items-center justify-center font-bold text-sm">${i}</div><div class="flex-1"><p class="text-slate-400 text-sm">-</p></div></div>`;
                        }
                    }
                    container.innerHTML = html;
                } else container.innerHTML = '<div class="text-center py-8 text-slate-300"><i class="fas fa-calendar-times text-2xl mb-2"></i><p class="text-xs">오늘 시간표가 없습니다.</p></div>';
            } catch (error) { container.innerHTML = '<div class="text-center py-8 text-slate-300"><i class="fas fa-exclamation-circle text-2xl mb-2"></i><p class="text-xs">시간표를 불러올 수 없습니다.</p></div>'; }
        }

        async function loadNoticeList() {
            const container = document.getElementById('notice-list');
            if (!container) return;
            try {
                const params = getSchoolParams();
                const response = await fetch(`/api/notice/list?${params.toString()}`);
                const data = await response.json();
                if (data.success && data.notices?.length > 0) {
                    container.innerHTML = data.notices.map(notice => `
                        <div class="p-3 bg-slate-50 rounded-xl border border-slate-100 hover:border-amber-300 hover:bg-amber-50/30 transition cursor-pointer" 
                             onclick="location.href='notice.html?id=${notice.id}'">
                            <div class="flex items-center gap-3">
                                <span class="w-8 h-8 bg-amber-100 text-amber-600 rounded-lg flex items-center justify-center text-xs font-bold flex-shrink-0">${notice.row_num}</span>
                                <div class="flex-1 min-w-0">
                                    <p class="font-bold text-slate-800 text-sm truncate">${notice.title}</p>
                                    <p class="text-xs text-slate-500 mt-1">${notice.member_name} · ${notice.created_at}</p>
                                </div>
                                <i class="fas fa-chevron-right text-slate-300 text-xs"></i>
                            </div>
                        </div>
                    `).join('');
                } else container.innerHTML = '<div class="text-center py-8 text-slate-300"><i class="fas fa-inbox text-2xl mb-2"></i><p class="text-xs">공지사항이 없습니다.</p></div>';
            } catch (error) { container.innerHTML = '<div class="text-center py-8 text-slate-300"><i class="fas fa-inbox text-2xl mb-2"></i><p class="text-xs">공지사항이 없습니다.</p></div>'; }
        }

        function openNoticeModal() {
            document.getElementById('notice-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeNoticeModal() {
            document.getElementById('notice-modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            document.getElementById('notice-title').value = '';
            document.getElementById('notice-message').value = '';
            document.getElementById('notice-correct-no').value = '';
        }

        async function submitNotice() {
            const title = document.getElementById('notice-title').value.trim();
            const message = document.getElementById('notice-message').value.trim();
            const correct_no = document.getElementById('notice-correct-no').value.trim();
            
            if (!title || !message) return alert('제목과 내용을 모두 입력해주세요.');
            if (!correct_no || correct_no.length < 4) return alert('수정/삭제용 비밀번호를 4자리 이상 입력해주세요.');
            
            try {
                const response = await fetch('/api/notice/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        member_name: currentUser.member_name,
                        member_school: currentUser.member_school,
                        school_id: currentUser.school_id,
                        title,
                        message,
                        correct_no
                    })
                });
                const data = await response.json();
                if (data.success) {
                    alert(data.message);
                    closeNoticeModal();
                    loadNoticeList();
                } else alert(data.message);
            } catch (error) { alert('공지사항 등록 중 오류가 발생했습니다.'); }
        }

        // ============================================
        // 오늘의 할 일 위젯
        // ============================================
        async function loadTodoWidget() {
            const container = document.getElementById('todo-widget');
            const countEl = document.getElementById('todo-count');
            if (!container) return;
            const todos = [];

            try {
                // 미읽은 메시지
                const msgRes = await fetch('/api/message/rooms');
                const msgData = await msgRes.json();
                if (msgData.success) {
                    const unread = (msgData.rooms || []).reduce((sum, r) => sum + (r.unread_count || 0), 0);
                    if (unread > 0) todos.push({icon: 'fa-envelope', color: 'cyan', text: `미읽은 메시지 ${unread}건`, action: "openMsgPopup()"});
                }
            } catch(e) {}

            try {
                // 미처리 상담 요청
                if (teacherInfo?.class_grade && teacherInfo?.class_no) {
                    const params = getSchoolParams();
                    params.append('class_grade', teacherInfo.class_grade);
                    params.append('class_no', teacherInfo.class_no);
                    const cRes = await fetch(`/api/homeroom/counsel-schedule/list?${params.toString()}`);
                    const cData = await cRes.json();
                    if (cData.success) {
                        const pending = (cData.schedules || []).filter(s => s.status === 'pending').length;
                        if (pending > 0) todos.push({icon: 'fa-user-clock', color: 'amber', text: `대기중 상담 ${pending}건`, action: "location.href='tea/homeroom.html'"});
                    }
                }
            } catch(e) {}

            try {
                // 오늘 공지사항
                const params = getSchoolParams();
                const nRes = await fetch(`/api/notice/list?${params.toString()}`);
                const nData = await nRes.json();
                if (nData.success) {
                    const today = new Date().toISOString().slice(0, 10);
                    const todayNotices = (nData.notices || []).filter(n => n.created_at?.startsWith(today)).length;
                    if (todayNotices > 0) todos.push({icon: 'fa-bullhorn', color: 'orange', text: `오늘 공지 ${todayNotices}건`, action: "location.href='notice.html'"});
                }
            } catch(e) {}

            if (countEl) countEl.textContent = `${todos.length}건`;

            if (todos.length === 0) {
                container.innerHTML = '<p class="text-sm text-slate-400 text-center py-2 w-full">처리할 항목이 없습니다</p>';
            } else {
                const colorMap = {cyan: 'bg-cyan-100 text-cyan-600', amber: 'bg-amber-100 text-amber-600', orange: 'bg-orange-100 text-orange-600', indigo: 'bg-indigo-100 text-indigo-600'};
                container.innerHTML = todos.map(t =>
                    `<button onclick="${t.action}" class="flex items-center gap-2 px-4 py-2 rounded-xl hover:bg-slate-50 border border-slate-100 transition">
                        <span class="w-7 h-7 ${colorMap[t.color] || colorMap.indigo} rounded-lg flex items-center justify-center text-xs"><i class="fas ${t.icon}"></i></span>
                        <span class="text-sm font-medium text-slate-700">${t.text}</span>
                        <i class="fas fa-chevron-right text-xs text-slate-300"></i>
                    </button>`
                ).join('');
            }
        }

        function openChargeModal() { window.location.href = '/templates/charge.html'; }
        function closeChargeModal() { document.getElementById('charge-modal').classList.add('hidden'); document.body.style.overflow = 'auto'; }
        function selectChargeAmount(amount) { document.getElementById('custom-charge-amount').value = amount; }
        function processCharge() { window.location.href = '/templates/charge.html'; }

        let scheduleData = [];
        let selectedDate = null;

        async function loadSchedules() {
            try {
                const params = getSchoolParams();
                params.append('member_id', currentUser.member_id);
                params.append('member_roll', currentUser.member_roll);
                params.append('year', currentYear);
                params.append('month', currentMonth + 1);
                
                const response = await fetch(`/api/schedule/list?${params.toString()}`);
                const data = await response.json();
                
                if (data.success) {
                    scheduleData = data.schedules || [];
                    renderCalendar();
                    if (selectedDate) showDaySchedules(selectedDate);
                    else showTodaySchedules();
                }
            } catch (error) { console.error('일정 로드 오류:', error); }
        }

        function renderCalendar() {
            const calBody = document.getElementById('calendar-body');
            const calTitle = document.getElementById('cal-title');
            if (!calBody || !calTitle) return;
            calTitle.textContent = `${currentYear}년 ${currentMonth + 1}월`;
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const today = new Date();
            
            const scheduleDays = scheduleData.map(s => s.day);
            
            let html = '';
            for (let i = 0; i < firstDay.getDay(); i++) {
                const prevDate = new Date(currentYear, currentMonth, -firstDay.getDay() + i + 1);
                html += `<div class="cal-cell other-month">${prevDate.getDate()}</div>`;
            }
            for (let d = 1; d <= lastDay.getDate(); d++) {
                const isToday = today.getFullYear() === currentYear && today.getMonth() === currentMonth && today.getDate() === d;
                const hasSchedule = scheduleDays.includes(d);
                const isSelected = selectedDate === d;
                html += `<div class="cal-cell ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''}" onclick="selectDate(${d})">
                    ${d}${hasSchedule ? '<span class="schedule-dot"></span>' : ''}
                </div>`;
            }
            const remaining = 42 - (firstDay.getDay() + lastDay.getDate());
            for (let i = 1; i <= remaining; i++) html += `<div class="cal-cell other-month">${i}</div>`;
            calBody.innerHTML = html;
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            else if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            selectedDate = null;
            loadSchedules();
        }

        function selectDate(day) {
            selectedDate = day;
            renderCalendar();
            showDaySchedules(day);
        }

        function showTodaySchedules() {
            const today = new Date();
            if (today.getFullYear() === currentYear && today.getMonth() === currentMonth) {
                showDaySchedules(today.getDate());
            } else {
                setText('selected-date-title', '이번 달 일정');
                const container = document.getElementById('selected-date-list');
                if (scheduleData.length === 0) {
                    container.innerHTML = '<div class="text-center py-6 text-slate-300"><i class="fas fa-inbox text-2xl mb-2"></i><p class="text-xs font-medium">일정이 없습니다.</p></div>';
                } else {
                    container.innerHTML = scheduleData.slice(0, 5).map(s => createScheduleItem(s)).join('');
                }
            }
        }

        function showDaySchedules(day) {
            setText('selected-date-title', `${currentMonth + 1}월 ${day}일 일정`);
            const container = document.getElementById('selected-date-list');
            const daySchedules = scheduleData.filter(s => s.day === day);
            
            if (daySchedules.length === 0) {
                container.innerHTML = '<div class="text-center py-6 text-slate-300"><i class="fas fa-inbox text-2xl mb-2"></i><p class="text-xs font-medium">일정이 없습니다.</p></div>';
            } else {
                container.innerHTML = daySchedules.map(s => createScheduleItem(s)).join('');
            }
        }

        function createScheduleItem(s) {
            const isOwner = s.member_id === currentUser.member_id;
            const rollMap = {'self': '나만', 'teacher': '교사', 'student': '학생', 'parent': '학부모', 'all': '전체'};
            const rollLabel = s.read_roll.split(',').map(r => rollMap[r.trim()] || r).join(', ');
            return `
                <div class="p-3 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border border-indigo-100">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <p class="font-bold text-slate-800 text-sm">${s.title}</p>
                            <p class="text-xs text-slate-500 mt-1">${s.schedule_date.split(' ')[1] || ''} · ${s.member_name}</p>
                            ${rollLabel ? `<span class="inline-block mt-1 px-2 py-0.5 bg-indigo-100 text-indigo-600 text-xs rounded-full">${rollLabel}</span>` : ''}
                        </div>
                        ${isOwner ? `<div class="flex gap-1">
                            <button onclick="editSchedule(${s.id})" class="text-indigo-400 hover:text-indigo-600 p-1"><i class="fas fa-pen text-xs"></i></button>
                            <button onclick="deleteSchedule(${s.id})" class="text-red-400 hover:text-red-600 p-1"><i class="fas fa-trash text-xs"></i></button>
                        </div>` : ''}
                    </div>
                </div>
            `;
        }

        async function deleteSchedule(id) {
            if (!confirm('이 일정을 삭제하시겠습니까?')) return;
            try {
                const response = await fetch('/api/schedule/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, member_id: currentUser.member_id })
                });
                const data = await response.json();
                if (data.success) { alert(data.message); loadSchedules(); }
                else alert(data.message);
            } catch (error) { alert('삭제 중 오류가 발생했습니다.'); }
        }

        let editingScheduleId = null;

        function openScheduleModal() {
            editingScheduleId = null;
            document.getElementById('schedule-modal-title').textContent = '일정 등록';
            document.getElementById('schedule-modal-desc').textContent = '새 일정을 추가하세요';
            document.getElementById('schedule-submit-btn').textContent = '등록하기';
            document.getElementById('schedule-title').value = '';
            document.getElementById('schedule-content').value = '';
            document.querySelectorAll('input[name="read_roll"]').forEach(cb => cb.checked = cb.value === 'self');
            const now = new Date();
            if (selectedDate) {
                now.setFullYear(currentYear, currentMonth, selectedDate);
            }
            const pad = n => String(n).padStart(2, '0');
            const dateStr = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
            document.getElementById('schedule-date').value = dateStr;
            document.getElementById('schedule-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function editSchedule(id) {
            const s = scheduleData.find(item => item.id === id);
            if (!s) return;
            editingScheduleId = id;
            document.getElementById('schedule-modal-title').textContent = '일정 수정';
            document.getElementById('schedule-modal-desc').textContent = '일정을 수정하세요';
            document.getElementById('schedule-submit-btn').textContent = '수정하기';
            document.getElementById('schedule-title').value = s.title;
            document.getElementById('schedule-content').value = s.content || '';
            document.getElementById('schedule-date').value = s.schedule_date.replace(' ', 'T');
            const rolls = s.read_roll.split(',').map(r => r.trim());
            document.querySelectorAll('input[name="read_roll"]').forEach(cb => cb.checked = rolls.includes(cb.value));
            document.getElementById('schedule-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeScheduleModal() {
            editingScheduleId = null;
            document.getElementById('schedule-modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        async function submitSchedule() {
            const title = document.getElementById('schedule-title').value.trim();
            const schedule_date = document.getElementById('schedule-date').value;
            const content = document.getElementById('schedule-content').value.trim();
            const checked = document.querySelectorAll('input[name="read_roll"]:checked');
            const read_roll = Array.from(checked).map(c => c.value).join(',');
            
            if (!title) return alert('일정 제목을 입력해주세요.');
            if (!schedule_date) return alert('날짜를 선택해주세요.');
            if (!read_roll) return alert('공개 대상을 선택해주세요.');
            
            try {
                const url = editingScheduleId ? '/api/schedule/update' : '/api/schedule/create';
                const body = {
                    school_id: currentUser.school_id,
                    member_school: currentUser.member_school,
                    member_id: currentUser.member_id,
                    member_name: currentUser.member_name,
                    member_roll: currentUser.member_roll,
                    read_roll, schedule_date, title, content
                };
                if (editingScheduleId) body.id = editingScheduleId;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await response.json();
                if (data.success) {
                    alert(data.message);
                    closeScheduleModal();
                    loadSchedules();
                } else alert(data.message);
            } catch (error) { alert('처리 중 오류가 발생했습니다.'); }
        }

        // ============================================
        // 실시간 푸시 알림 시스템
        // ============================================
        let lastCheckTime = null;
        let notificationInterval = null;

        async function updateNotificationBadge() {
            try {
                const params = getSchoolParams();
                const today = new Date().toISOString().slice(0, 10);
                const noticeRes = await fetch(`/api/notice/list?${params.toString()}`);
                const noticeData = await noticeRes.json();
                const todayNotices = (noticeData.notices || []).filter(n => n.created_at && n.created_at.startsWith(today)).length;
                
                const now = new Date();
                params.set('year', now.getFullYear());
                params.set('month', now.getMonth() + 1);
                params.set('member_id', currentUser.member_id);
                params.set('member_roll', currentUser.member_roll);
                const schedRes = await fetch(`/api/schedule/list?${params.toString()}`);
                const schedData = await schedRes.json();
                const todaySchedules = (schedData.schedules || []).filter(s => s.date_only === today).length;
                
                const total = todayNotices + todaySchedules;
                const badge = document.getElementById('notification-badge');
                if (total > 0) {
                    badge.textContent = total > 99 ? '99+' : total;
                    badge.classList.remove('hidden');
                    badge.classList.add('flex');
                } else {
                    badge.classList.add('hidden');
                    badge.classList.remove('flex');
                }
            } catch (e) { console.error('알림 배지 오류:', e); }
        }

        function initPushNotifications() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            initCheckTime().then(() => {
                notificationInterval = setInterval(checkNewNotifications, 30000);
            });
        }

        async function initCheckTime() {
            try {
                const params = getSchoolParams();
                params.set('member_id', currentUser.member_id);
                params.set('member_roll', currentUser.member_roll);
                params.set('since', '2099-12-31 23:59:59');
                const res = await fetch(`/api/notifications/check?${params.toString()}`);
                const data = await res.json();
                if (data.success) lastCheckTime = data.server_time;
            } catch (e) { lastCheckTime = new Date().toISOString().slice(0, 19).replace('T', ' '); }
        }

        async function checkNewNotifications() {
            if (!lastCheckTime || !currentUser) return;
            try {
                const params = getSchoolParams();
                params.set('member_id', currentUser.member_id);
                params.set('member_roll', currentUser.member_roll);
                params.set('since', lastCheckTime);
                const res = await fetch(`/api/notifications/check?${params.toString()}`);
                const data = await res.json();
                if (!data.success) return;

                lastCheckTime = data.server_time;

                data.new_notices.forEach(n => {
                    showPushNotification('📢 새 공지사항', `${n.title} - ${n.member_name}`);
                });
                data.new_schedules.forEach(s => {
                    showPushNotification('📅 새 일정', `${s.title} - ${s.member_name}`);
                });

                if (data.new_notices.length > 0 || data.new_schedules.length > 0) {
                    updateNotificationBadge();
                    loadNoticeList();
                    loadSchedules();
                }
            } catch (e) { console.error('알림 폴링 오류:', e); }
        }

        function showPushNotification(title, body) {
            if (!('Notification' in window) || Notification.permission !== 'granted') return;
            try {
                const noti = new Notification(title, {
                    body: body,
                    icon: '/static/icon-192.png',
                    tag: title + '-' + Date.now(),
                    requireInteraction: false
                });
                noti.onclick = () => { window.focus(); noti.close(); };
                setTimeout(() => noti.close(), 5000);
            } catch (e) { console.error('푸시 알림 오류:', e); }
        }

        function toggleNotificationPanel() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(p => {
                    if (p === 'granted') alert('알림이 활성화되었습니다!');
                });
            } else if ('Notification' in window && Notification.permission === 'granted') {
                alert('알림이 이미 활성화되어 있습니다. 새 공지사항/일정 등록 시 브라우저 알림을 받습니다.');
            }
        }

        // ── 사이드바 스크롤 힌트 ──
        (function() {
            const nav = document.getElementById('sidebar-nav');
            const hint = document.getElementById('nav-scroll-hint');
            if (!nav || !hint) return;
            function checkScroll() {
                const canScroll = nav.scrollHeight > nav.clientHeight;
                const atBottom = nav.scrollHeight - nav.scrollTop - nav.clientHeight < 8;
                if (canScroll && !atBottom) hint.classList.remove('hidden');
                else hint.classList.add('hidden');
            }
            nav.addEventListener('scroll', checkScroll);
            window.addEventListener('resize', checkScroll);
            checkScroll();
            new MutationObserver(checkScroll).observe(nav, { childList: true, subtree: true });
        })();

        // ── 학급 담임 및 부서입력 모달 ──
        function openTeacherInfoModal() {
            document.getElementById('ti-pw-step').classList.remove('hidden');
            document.getElementById('ti-form-step').classList.add('hidden');
            document.getElementById('ti-password').value = '';
            document.getElementById('teacher-info-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('ti-password').focus(), 200);
        }

        function closeTeacherInfoModal() {
            document.getElementById('teacher-info-modal').classList.add('hidden');
        }

        async function verifyTeacherInfoPw() {
            const pw = document.getElementById('ti-password').value;
            if (!pw) { alert('비밀번호를 입력해주세요.'); return; }
            try {
                const res = await fetch('/api/member/verify-password', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ member_id: currentUser.member_id, password: pw })
                });
                const r = await res.json();
                if (!r.success) { alert(r.message || '비밀번호가 일치하지 않습니다.'); return; }

                // 기존 데이터 로드 (실패해도 폼은 보여줌)
                try {
                    const infoRes = await fetch('/api/member/info?member_id=' + encodeURIComponent(currentUser.member_id));
                    const info = await infoRes.json();
                    if (info.success && info.member) {
                        document.getElementById('ti-department').value = info.member.department || '';
                        document.getElementById('ti-position').value = info.member.department_position || '';
                        document.getElementById('ti-grade').value = info.member.class_grade || '';
                        document.getElementById('ti-classno').value = info.member.class_no || '';
                    }
                } catch (loadErr) {
                    console.warn('기존 데이터 로드 실패 (새로 입력 가능):', loadErr);
                }

                document.getElementById('ti-pw-step').classList.add('hidden');
                document.getElementById('ti-form-step').classList.remove('hidden');
            } catch (e) {
                console.error('비밀번호 확인 오류:', e);
                alert('오류가 발생했습니다.');
            }
        }

        async function saveTeacherInfo() {
            const department = document.getElementById('ti-department').value.trim();
            const position = document.getElementById('ti-position').value.trim();
            const grade = document.getElementById('ti-grade').value;
            const classno = document.getElementById('ti-classno').value;

            try {
                const res = await fetch('/api/teacher/update-class-info', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({
                        member_id: currentUser.member_id,
                        department: department,
                        department_position: position,
                        class_grade: grade,
                        class_no: classno
                    })
                });
                const r = await res.json();
                if (r.success) {
                    alert('저장되었습니다.');
                    currentUser.class_grade = grade;
                    currentUser.class_no = classno;
                    localStorage.setItem('schoolus_user', JSON.stringify(currentUser));
                    closeTeacherInfoModal();
                } else {
                    alert(r.message || '저장 실패');
                }
            } catch (e) {
                console.error('저장 오류:', e);
                alert('저장 중 오류가 발생했습니다.');
            }
        }

        // ============================================
        // 동명이인 시간표 매칭
        // ============================================
        let _matchEntries = [];

        async function checkTimetableMatch() {
            if (localStorage.getItem('schoolus_match_skip')) return;
            try {
                const res = await fetch('/api/teacher/timetable-match-check');
                const data = await res.json();
                if (!data.success || !data.needs_match) return;
                _matchEntries = data.entries;
                const container = document.getElementById('match-entries');
                container.innerHTML = _matchEntries.map((e, i) => `
                    <label class="flex items-center gap-3 p-3 rounded-xl border-2 border-slate-200 hover:border-amber-400 cursor-pointer transition-all">
                        <input type="checkbox" value="${i}" class="w-5 h-5 rounded text-amber-500 focus:ring-amber-400">
                        <div class="flex-1">
                            <span class="font-bold text-slate-700">${e.subject}</span>
                            <span class="text-sm text-slate-500 ml-2">(${e.grade}학년 ${e.classes.join(',')}반)</span>
                        </div>
                        <span class="text-xs text-slate-400">${e.hours}시간</span>
                    </label>
                `).join('');
                document.getElementById('timetable-match-modal').classList.remove('hidden');
            } catch (err) { console.error('매칭 확인 오류:', err); }
        }

        async function submitTimetableMatch() {
            const checks = document.querySelectorAll('#match-entries input[type=checkbox]:checked');
            if (checks.length === 0) { alert('본인의 수업을 선택해 주세요.'); return; }
            const selected = Array.from(checks).map(cb => {
                const e = _matchEntries[parseInt(cb.value)];
                return { subject: e.subject, grade: e.grade };
            });
            try {
                const res = await fetch('/api/teacher/timetable-match', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ selected })
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('timetable-match-modal').classList.add('hidden');
                    localStorage.removeItem('schoolus_match_skip');
                    showToast(`시간표 매칭 완료 (${data.matched_count}건)`);
                    loadTodayTimetable('my');
                } else {
                    alert(data.message || '매칭 처리 중 오류가 발생했습니다.');
                }
            } catch (err) { alert('매칭 처리 중 오류가 발생했습니다.'); }
        }

        function closeTimetableMatch() {
            document.getElementById('timetable-match-modal').classList.add('hidden');
            localStorage.setItem('schoolus_match_skip', Date.now());
        }

        function openSettingsPopup() { location.href = 'mypage.html'; }

        function handleLogout() { if (confirm('로그아웃 하시겠습니까?')) { clearInterval(notificationInterval); localStorage.removeItem('schoolus_user'); window.location.href = '/'; } }

        // 모바일 사이드바 토글
        function toggleMobileSidebar() {
            document.getElementById('sidebar').classList.toggle('mobile-open');
            document.getElementById('mobile-overlay').classList.toggle('active');
        }
        document.getElementById('mobile-overlay').onclick = function() {
            document.getElementById('sidebar').classList.remove('mobile-open');
            this.classList.remove('active');
        };
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMessage');
            toast.className = 'fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 z-[9999] ' + (type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white');
            toastMsg.textContent = message;
            toast.classList.remove('translate-x-full');
            setTimeout(function() { toast.classList.add('translate-x-full'); }, 1500);
        }

    </script>
    <script>
    // 대시보드 메시지 위젯 — 최근 대화방 로드
    function loadDashMessages() {
        fetch('/api/message/rooms').then(r=>r.json()).then(data=>{
            if(!data.success) return;
            const list = document.getElementById('dash-msg-list');
            const rooms = data.rooms || [];
            let totalUnread = 0;
            if(rooms.length === 0){
                list.innerHTML='<div class="text-center py-8 text-slate-300"><i class="fas fa-comments text-2xl mb-2"></i><p class="text-xs font-medium">메시지가 없습니다.</p></div>';
            } else {
                let html = '';
                const myId = sessionStorage.getItem('member_id') || '';
                rooms.slice(0, 8).forEach(r => {
                    const unread = r.unread_count || 0;
                    totalUnread += unread;
                    const lastMsg = r.last_message || '';
                    const preview = lastMsg.length > 20 ? lastMsg.substring(0,20)+'...' : lastMsg;
                    const time = r.last_msg_time ? formatMsgTime(r.last_msg_time) : '';
                    // class/grade/school 단체방은 고정 제목, direct/group은 상대방 이름 표시
                    let title;
                    if(r.room_title && r.room_type && ['class','grade','school'].includes(r.room_type)) {
                        title = r.room_title;
                    } else if(r.members) {
                        const others = r.members.filter(m => m.member_id !== myId);
                        title = others.length ? others.map(m => m.member_name).join(', ') : '나';
                    } else {
                        title = r.room_title || '대화방';
                    }
                    const badge = unread > 0 ? `<span class="shrink-0 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center font-bold">${unread > 99 ? '99+' : unread}</span>` : '';
                    const boldCls = unread > 0 ? 'font-bold text-slate-900' : 'text-slate-400';
                    html += `<a href="#" onclick="openMsgChat(${r.id});return false" class="flex items-center gap-2 p-2 rounded-lg hover:bg-slate-50 transition group">
                        <div class="w-8 h-8 shrink-0 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-white text-xs font-bold">${title[0]}</div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between gap-1">
                                <p class="text-xs font-semibold text-slate-700 truncate">${title}</p>
                                <span class="text-[10px] text-slate-400 shrink-0">${time}</span>
                            </div>
                            <p class="text-[11px] ${boldCls} truncate">${preview || '새 대화방'}</p>
                        </div>
                        ${badge}
                    </a>`;
                });
                list.innerHTML = html;
            }
            // 뱃지 업데이트
            ['dash-msg-count'].forEach(id=>{
                const el=document.getElementById(id);if(!el)return;
                if(totalUnread>0){el.textContent=totalUnread>99?'99+':totalUnread;el.classList.remove('hidden');}
                else{el.classList.add('hidden');}
            });
        }).catch(()=>{});
    }
    function formatMsgTime(t){
        if(!t) return '';
        const d = new Date(t.replace(' ','T'));
        const now = new Date();
        const diff = now - d;
        if(diff < 60000) return '방금';
        if(diff < 3600000) return Math.floor(diff/60000)+'분 전';
        if(diff < 86400000) return Math.floor(diff/3600000)+'시간 전';
        if(diff < 604800000) return Math.floor(diff/86400000)+'일 전';
        return (d.getMonth()+1)+'/'+d.getDate();
    }
    loadDashMessages();
    setInterval(loadDashMessages, 30000);
    </script>
    <script src="js/messenger-popup.js?v=20260227a"></script>
    <script>initMsgPopup();</script>
    <div id="toast" class="fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-[9999] bg-green-500 text-white">
        <span id="toastMessage"></span>
    </div>
<script src="/static/js/help-modal.js" data-doc="teacher-dashboard"></script>
</body>
</html>