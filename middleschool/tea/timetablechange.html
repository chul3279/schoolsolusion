<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SchoolUs - 시간표 조회/변경</title>
    <script src="/static/js/tailwindcss.js"></script>
    <link href="/static/fontawesome/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
body { font-family: 'Noto Sans KR', sans-serif; }
        .sidebar-gradient { background: linear-gradient(180deg, #0f172a 0%, #1e293b 50%, #334155 100%); }

        .tt-grid { display: grid; grid-template-columns: 50px repeat(5, 1fr); border: 1px solid #e2e8f0; background: #fff; border-radius: 8px; overflow: hidden; }
        .tt-head { background: #f8fafc; color: #64748b; font-weight: bold; text-align: center; padding: 10px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; font-size: 0.85rem; }
        .tt-cell { border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; min-height: 72px; position: relative; padding: 6px; display: flex; align-items: center; justify-content: center; flex-direction: column; cursor: pointer; transition: background 0.15s; }
        .tt-cell:hover { background-color: #f1f5f9; }
        .tt-cell:nth-child(6n) { border-right: none; }
        .period-badge { background: #f1f5f9; color: #94a3b8; font-weight: bold; display: flex; align-items: center; justify-content: center; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; font-size: 0.85rem; }

        .subject-tag { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; border-radius: 6px; padding: 2px 8px; font-size: 0.8rem; font-weight: 600; margin-bottom: 2px; white-space: nowrap; }
        .class-tag { font-size: 0.7rem; color: #64748b; }
        .changed-cell { background-color: #fff7ed !important; }
        .changed-tag { color: #c2410c; border-color: #fdba74; background-color: #ffedd5; }
        .exchanged-cell { background-color: #f0fdf4 !important; }
        .exchanged-tag { color: #15803d; border-color: #86efac; background-color: #dcfce7; }

        .search-dropdown { position: absolute; z-index: 50; background: white; border: 1px solid #cbd5e1; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; width: 100%; }
        .search-dropdown div { padding: 8px 12px; cursor: pointer; font-size: 0.85rem; }
        .search-dropdown div:hover { background: #eef2ff; }

        .tab-btn { transition: all 0.2s; cursor: pointer; }
        .tab-btn.active { background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; box-shadow: 0 4px 12px rgba(99,102,241,0.3); border-color: transparent; }

        .period-card { border: 2px solid #e2e8f0; border-radius: 12px; padding: 12px 16px; cursor: pointer; transition: all 0.2s; }
        .period-card:hover { border-color: #a5b4fc; background: #f5f3ff; }
        .period-card.selected-mine { border-color: #6366f1; background: #eef2ff; box-shadow: 0 0 0 3px rgba(99,102,241,0.2); }
        .period-card.selected-target { border-color: #22c55e; background: #f0fdf4; box-shadow: 0 0 0 3px rgba(34,197,94,0.2); }

        /* 연쇄 교환 계산기 스타일 */
        .ex-cell { border: 2px solid #e2e8f0; border-radius: 12px; padding: 12px 8px; text-align: center; transition: all 0.2s; min-height: 80px; display: flex; flex-direction: column; justify-content: center; }
        .ex-cell.has-class { cursor: pointer; background: #f8fafc; }
        .ex-cell.has-class:hover { border-color: #818cf8; background: #eef2ff; }
        .ex-cell.is-free { background: #fafafa; border-style: dashed; color: #94a3b8; }
        .ex-cell.source-selected { border-color: #6366f1; background: #eef2ff; box-shadow: 0 0 0 3px rgba(99,102,241,0.3); }
        .ex-cell.free-active { border-color: #22c55e; background: #f0fdf4; cursor: pointer; animation: pulse-green 1.5s ease-in-out infinite; }
        .ex-cell.free-active:hover { background: #dcfce7; box-shadow: 0 0 0 3px rgba(34,197,94,0.3); }
        .ex-cell.free-hovered { border-color: #16a34a; background: #dcfce7; box-shadow: 0 0 0 3px rgba(34,197,94,0.4); }
        .ex-cell.impossible { border-color: #fca5a5; background: #fef2f2; opacity: 0.7; }
        @keyframes pulse-green { 0%,100% { box-shadow: 0 0 0 0 rgba(34,197,94,0.4); } 50% { box-shadow: 0 0 0 8px rgba(34,197,94,0); } }
        .chain-badge-simple { background: #dcfce7; color: #15803d; padding: 4px 12px; border-radius: 20px; }
        .chain-badge-complex { background: #fff7ed; color: #c2410c; padding: 4px 12px; border-radius: 20px; }
        .chain-badge-impossible { background: #fee2e2; color: #dc2626; padding: 4px 12px; border-radius: 20px; }
        .chain-step { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px 16px; margin-bottom: 8px; }
        .chain-step .swap-row { display: flex; align-items: center; gap: 8px; padding: 4px 0; font-size: 0.85rem; }
        .chain-step .swap-arrow { color: #6366f1; font-weight: bold; }

        /* 연쇄 교환 그룹 카드 */
        .chain-group-card { background: linear-gradient(135deg, #faf5ff, #f5f3ff); border: 2px solid #c4b5fd; border-radius: 16px; padding: 16px; margin-bottom: 12px; }
        .chain-group-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .chain-group-badge { background: linear-gradient(135deg, #8b5cf6, #6d28d9); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
        .chain-progress-bar { width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; }
        .chain-progress-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
        .chain-progress-fill.all-approved { background: linear-gradient(90deg, #22c55e, #16a34a); }
        .chain-progress-fill.partial { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .chain-member-row { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border: 1px solid #e2e8f0; border-radius: 10px; margin-bottom: 6px; font-size: 0.85rem; flex-wrap: wrap; }
        .chain-member-row .member-status { margin-left: auto; }

        .status-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
        .status-pending { background: #fef9c3; color: #a16207; }
        .status-approved { background: #dcfce7; color: #15803d; }
        .status-rejected { background: #fee2e2; color: #dc2626; }
        .status-cancelled { background: #f1f5f9; color: #64748b; }

        @media print {
            aside, header, .no-print, .search-bar, .tab-bar { display: none !important; }
            @page { size: A4 landscape; margin: 5mm; }
            body { background: white !important; }
            main { overflow: visible !important; }
            .tt-grid { border: 2px solid #333; }
            .tt-head { background: #d0d0d0 !important; color: #000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .subject-tag { border-color: #333; }
            .changed-cell { background: #ffe0c0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .exchanged-cell { background: #c0ffd0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }

        #mobile-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; }
        #mobile-overlay.active { display: block; }
        #sidebar.mobile-open { display: flex !important; position: fixed !important; left: 0 !important; top: 0 !important; bottom: 0 !important; z-index: 50 !important; flex-direction: column !important; }

        @media (max-width: 767px) {
            #sidebar.mobile-open { overflow-y: auto !important; }
            #sidebar.mobile-open .nav-wrap { flex: none !important; min-height: auto !important; }
            #sidebar.mobile-open #sidebar-nav { height: auto !important; overflow: visible !important; }
            .nav-item { min-height: 52px; padding-top: 14px !important; padding-bottom: 14px !important; font-size: 15px !important; }
            #sidebar .space-y-1 > li { margin-bottom: 4px; }
            #sidebar .p-4.border-t a { min-height: 48px; padding-top: 14px !important; padding-bottom: 14px !important; font-size: 14px !important; }
            .tab-btn { min-height: 48px; padding: 12px 16px !important; font-size: 14px !important; white-space: nowrap; }
        }
    </style>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7LJ1TCE277"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-7LJ1TCE277');
    </script>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SchoolUs">
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
    <script src="/static/js/pwa-install.js" defer></script>
    <script src="/static/js/pwa-push.js" defer></script>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden">

    <!-- 변경 모달 -->
    <div id="changeModal" class="fixed inset-0 bg-black bg-opacity-30 z-50 hidden items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="bg-slate-800 text-white p-4 flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fas fa-exchange-alt mr-2"></i>수업 변경 / 보강 처리</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex gap-4 p-3 bg-slate-50 rounded-lg border border-slate-200">
                    <div class="flex-1 text-center border-r border-slate-200">
                        <div class="text-xs text-slate-500">대상</div>
                        <div class="font-bold text-indigo-600" id="modalTargetInfo">-</div>
                    </div>
                    <div class="flex-1 text-center border-r border-slate-200">
                        <div class="text-xs text-slate-500">기존 과목</div>
                        <div class="font-bold text-slate-800" id="modalOrigSubject">-</div>
                    </div>
                    <div class="flex-1 text-center">
                        <div class="text-xs text-slate-500" id="modalOrigLabel">기존 교사</div>
                        <div class="font-bold text-slate-800" id="modalOrigTeacher">-</div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-600 mb-2">변경 사유</label>
                    <select id="modalReason" class="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="출장(관내)">출장 (관내)</option>
                        <option value="출장(관외)">출장 (관외)</option>
                        <option value="병가">병가</option>
                        <option value="연가">연가</option>
                        <option value="연수">연수</option>
                        <option value="기타">기타</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="relative">
                        <label class="block text-sm font-bold text-slate-600 mb-2">보강 교사</label>
                        <input type="text" id="modalNewTeacher" class="w-full border border-slate-300 rounded-lg p-2 text-sm" placeholder="교사명 검색" autocomplete="off">
                        <div id="modalTeacherDropdown" class="search-dropdown hidden"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">변경 과목</label>
                        <input type="text" id="modalNewSubject" class="w-full border border-slate-300 rounded-lg p-2 text-sm" placeholder="자습" value="자습">
                    </div>
                </div>

                <div class="pt-4 flex gap-2">
                    <button class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-2.5 rounded-lg font-bold transition" onclick="closeModal()">취소</button>
                    <button class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 rounded-lg font-bold shadow transition" onclick="applyChange()">변경 적용</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 거절 사유 모달 -->
    <div id="rejectModal" class="fixed inset-0 bg-black bg-opacity-30 z-50 hidden items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="bg-red-600 text-white p-4"><h3 class="font-bold"><i class="fas fa-times-circle mr-2"></i>교환 요청 거절</h3></div>
            <div class="p-6 space-y-4">
                <div><label class="block text-sm font-bold text-slate-600 mb-2">거절 사유</label>
                <input type="text" id="rejectReasonInput" class="w-full border border-slate-300 rounded-lg p-2 text-sm" placeholder="거절 사유 입력 (선택)"></div>
                <div class="flex gap-2">
                    <button class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-2.5 rounded-lg font-bold" onclick="closeRejectModal()">취소</button>
                    <button class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2.5 rounded-lg font-bold" onclick="confirmReject()">거절 확인</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 사이드바 -->
    <div id="mobile-overlay"></div>
    <aside id="sidebar" class="w-72 sidebar-gradient text-slate-300 flex-col flex-shrink-0 hidden md:flex no-print shadow-2xl">
        <div class="p-6 border-b border-slate-700/50">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
                    <i class="fas fa-school text-xl"></i>
                </div>
                <div>
                    <span class="font-black text-2xl text-white tracking-tight">SchoolUs</span>
                    <p class="text-xs text-slate-400 font-medium">스마트 교육 플랫폼</p>
                </div>
            </div>
        </div>
        <nav class="flex-1 overflow-y-auto py-4">
            <ul class="space-y-1">
                <li><a href="../tea.html" class="flex items-center px-6 py-3 hover:bg-slate-800 transition"><i class="fas fa-desktop w-6 mr-3"></i> 나의 대시보드</a></li>
                <li class="px-6 pt-6 pb-2 text-xs font-bold uppercase text-slate-500">반편성 · 시간표</li>
                <li><a href="classtime_maker_base.html" class="flex items-center px-6 py-3 hover:bg-slate-800 transition"><i class="fas fa-database w-6 mr-3"></i> 기초데이터 관리</a></li>
                <li><a href="class_maker.html" class="flex items-center px-6 py-3 hover:bg-slate-800 transition"><i class="fas fa-layer-group w-6 mr-3"></i> 반편성</a></li>
                <li><a href="timetablemaker.html" class="flex items-center px-6 py-3 hover:bg-slate-800 transition"><i class="fas fa-edit w-6 mr-3"></i> 시간표 작성</a></li>
                <li><a href="#" class="flex items-center px-6 py-3 bg-slate-800 text-white border-l-4 border-blue-500"><i class="fas fa-calendar-alt w-6 mr-3 text-green-400"></i> <span class="font-medium">시간표 조회/변경</span></a></li>
                <li><a href="timetableprint.html" class="flex items-center px-6 py-3 hover:bg-slate-800 transition"><i class="fas fa-print w-6 mr-3"></i> 시간표 출력</a></li>
            </ul>
        </nav>
        <div class="p-4 border-t border-slate-700">
            <a href="../tea.html" class="flex items-center justify-center w-full py-2 bg-slate-800 hover:bg-slate-700 rounded text-sm transition"><i class="fas fa-arrow-left mr-2"></i> 메인으로 돌아가기</a>
        </div>
    </aside>

    <!-- 메인 -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <header class="bg-white h-16 border-b flex items-center justify-between px-8 shadow-sm z-30 flex-shrink-0 no-print">
            <div class="flex items-center gap-3">
                <button id="sidebar-toggle" onclick="toggleMobileSidebar()" class="md:hidden text-slate-600"><i class="fas fa-bars text-xl"></i></button>
                <h2 class="text-xl font-bold text-slate-800">시간표 조회 및 변경</h2>
                <span id="schoolBadge" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold"></span>
            </div>
            <button onclick="window.print()" class="bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 px-3 py-1.5 rounded text-sm font-bold transition">
                <i class="fas fa-print mr-1"></i> 출력
            </button>
        </header>

        <!-- 탭 바 -->
        <div class="bg-white border-b px-8 py-2 z-20 no-print tab-bar flex items-center gap-2 flex-wrap">
            <button onclick="switchTab('timetable')" class="tab-btn active px-5 py-2.5 rounded-xl font-bold text-sm border-2 border-transparent" id="tab-timetable">
                <i class="fas fa-calendar-alt mr-2"></i>시간표 조회/변경
            </button>
            <button onclick="switchTab('exchange-request')" class="tab-btn px-5 py-2.5 rounded-xl font-bold text-sm bg-white border-2 border-slate-200 text-slate-600" id="tab-exchange-request">
                <i class="fas fa-exchange-alt mr-2"></i>수업 교환 / 대강
            </button>
            <button onclick="switchTab('exchange-list')" class="tab-btn px-5 py-2.5 rounded-xl font-bold text-sm bg-white border-2 border-slate-200 text-slate-600" id="tab-exchange-list">
                <i class="fas fa-list-alt mr-2"></i>교환 요청 목록
                <span id="pendingBadge" class="hidden ml-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[20px] text-center">0</span>
            </button>
        </div>

        <!-- ============================== 탭1: 시간표 조회/변경 ============================== -->
        <div id="panel-timetable" class="tab-panel flex-1 flex flex-col overflow-hidden">
            <!-- 검색 바 -->
            <div class="bg-white border-b px-8 py-3 z-10 shadow-sm flex items-center gap-4 flex-wrap search-bar no-print">
                <div class="flex items-center gap-2">
                    <label class="text-xs font-bold text-slate-500">기준일자</label>
                    <input type="date" id="searchDate" class="border border-slate-300 rounded px-2 py-1.5 text-sm text-slate-700">
                </div>
                <div class="h-6 w-px bg-slate-200"></div>
                <div class="flex items-center gap-2">
                    <label class="text-xs font-bold text-slate-500">검색 대상</label>
                    <select id="searchMode" class="border border-slate-300 rounded px-2 py-1.5 text-sm text-slate-700" onchange="toggleSearchMode()">
                        <option value="teacher">교사별</option>
                        <option value="class">학급별</option>
                    </select>
                </div>
                <div id="teacherSearchWrap" class="flex items-center gap-2 relative">
                    <input type="text" id="searchTeacherInput" class="border border-slate-300 rounded px-2 py-1.5 text-sm w-48" placeholder="교사명 입력" autocomplete="off">
                    <div id="searchTeacherDropdown" class="search-dropdown hidden" style="top:100%; left:0; width:192px;"></div>
                </div>
                <div id="classSearchWrap" class="hidden flex items-center gap-2">
                    <select id="searchGrade" class="border border-slate-300 rounded px-2 py-1.5 text-sm" onchange="onGradeChange()"></select>
                    <select id="searchClassNo" class="border border-slate-300 rounded px-2 py-1.5 text-sm"></select>
                </div>
                <button onclick="doSearch()" class="bg-indigo-600 text-white px-4 py-1.5 rounded text-sm font-bold hover:bg-indigo-700 transition">
                    <i class="fas fa-search mr-1"></i> 조회
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-8 bg-slate-50">
                <div class="max-w-7xl mx-auto">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 mb-6">
                        <div class="flex justify-between items-end mb-4">
                            <h3 class="font-bold text-lg text-slate-800" id="tableTitle">
                                <i class="fas fa-chalkboard-teacher mr-2 text-indigo-500"></i>교사 또는 학급을 검색하세요
                            </h3>
                            <div class="text-xs text-slate-400">
                                <i class="fas fa-info-circle mr-1"></i>셀 클릭 → 보강/변경 처리 &nbsp;|&nbsp;
                                <span class="inline-block w-3 h-3 rounded bg-orange-200 align-middle"></span> 대강
                                <span class="inline-block w-3 h-3 rounded bg-green-200 align-middle ml-2"></span> 교환
                            </div>
                        </div>
                        <div class="tt-grid">
                            <div class="tt-head bg-slate-100"></div>
                            <div class="tt-head">월</div><div class="tt-head">화</div><div class="tt-head">수</div><div class="tt-head">목</div><div class="tt-head">금</div>
                            <div id="timetableBody" style="display: contents;"></div>
                        </div>
                        <div id="emptyState" class="text-center py-16 text-slate-400">
                            <i class="fas fa-calendar-alt fa-3x mb-4"></i>
                            <p class="font-bold text-lg">시간표를 조회하려면 교사 또는 학급을 검색하세요.</p>
                        </div>
                    </div>
                    <div id="changesPanel" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 hidden no-print">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-800"><i class="fas fa-history mr-2 text-amber-500"></i>변경 이력 (<span id="changesCount">0</span>건)</h3>
                        </div>
                        <div class="overflow-auto max-h-[300px]">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 sticky top-0 text-xs text-slate-500">
                                    <tr>
                                        <th class="p-2 text-center w-20">요일/교시</th>
                                        <th class="p-2 text-left">기존 교사</th>
                                        <th class="p-2 text-left">기존 과목</th>
                                        <th class="p-2 text-center"><i class="fas fa-arrow-right"></i></th>
                                        <th class="p-2 text-left">변경 교사</th>
                                        <th class="p-2 text-left">변경 과목</th>
                                        <th class="p-2 text-left">사유</th>
                                        <th class="p-2 text-center w-16">취소</th>
                                    </tr>
                                </thead>
                                <tbody id="changesTableBody" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================== 탭2: 수업 교환 / 대강 ============================== -->
        <div id="panel-exchange-request" class="tab-panel hidden flex-1 overflow-y-auto p-8 bg-slate-50">
            <div class="max-w-6xl mx-auto space-y-6">
                <!-- 카드1: 주 선택 + 모드 토글 + 주간 시간표 -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-3">
                        <h3 class="font-bold text-lg"><i class="fas fa-exchange-alt mr-2 text-indigo-500"></i>수업 교환 / 대강</h3>
                        <div class="flex items-center gap-2">
                            <button onclick="changeWeek(-1)" class="bg-slate-100 hover:bg-slate-200 text-slate-700 w-9 h-9 rounded-lg text-sm font-bold transition"><i class="fas fa-chevron-left"></i></button>
                            <span id="exWeekLabel" class="text-sm font-bold text-slate-700 min-w-[200px] text-center"></span>
                            <button onclick="changeWeek(1)" class="bg-slate-100 hover:bg-slate-200 text-slate-700 w-9 h-9 rounded-lg text-sm font-bold transition"><i class="fas fa-chevron-right"></i></button>
                            <button onclick="loadExchangeWeek()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 transition ml-2">
                                <i class="fas fa-sync-alt mr-1"></i>불러오기
                            </button>
                        </div>
                    </div>
                    <!-- 모드 토글 -->
                    <div class="flex gap-2 mb-4">
                        <button onclick="setExMode('exchange')" id="exModeExchange" class="px-4 py-2 rounded-lg text-sm font-bold transition border-2 border-indigo-500 bg-indigo-50 text-indigo-700">
                            <i class="fas fa-exchange-alt mr-1"></i>수업 교환
                        </button>
                        <button onclick="setExMode('substitute')" id="exModeSubstitute" class="px-4 py-2 rounded-lg text-sm font-bold transition border-2 border-slate-200 bg-white text-slate-600">
                            <i class="fas fa-user-plus mr-1"></i>대강
                        </button>
                    </div>
                    <p class="text-sm text-slate-500 mb-4" id="exModeDesc">수업 셀을 클릭하여 이동할 수업을 선택한 후, 같은 날 공강 셀에 마우스를 올려 교환 경로를 확인하세요.</p>
                    <!-- 주간 시간표 그리드 -->
                    <div id="exWeekGridWrap" class="hidden">
                        <div class="tt-grid" id="exWeekGrid">
                            <div class="tt-head bg-slate-100"></div>
                            <div class="tt-head">월</div><div class="tt-head">화</div><div class="tt-head">수</div><div class="tt-head">목</div><div class="tt-head">금</div>
                            <div id="exWeekBody" style="display:contents;"></div>
                        </div>
                    </div>
                    <div id="exWeekPlaceholder" class="text-center py-8 text-slate-400">
                        <i class="fas fa-calendar-week fa-2x mb-2"></i>
                        <p>불러오기를 클릭하여 주간 시간표를 조회하세요.</p>
                    </div>
                </div>
                <!-- 카드2: 연쇄 교환 경로 시각화 (교환 모드) -->
                <div id="chainResultCard" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 hidden">
                    <div class="flex items-center gap-3 mb-4">
                        <h3 class="font-bold text-lg"><i class="fas fa-project-diagram mr-2 text-purple-500"></i>교환 경로</h3>
                        <span id="chainBadge" class="px-3 py-1 rounded-full text-xs font-bold"></span>
                    </div>
                    <div id="chainStepsArea"></div>
                    <div id="chainActions" class="hidden mt-4 pt-4 border-t border-slate-200">
                        <div class="flex items-center gap-4 flex-wrap">
                            <input type="text" id="exReqReason" class="flex-1 min-w-[200px] border border-slate-300 rounded-lg p-2 text-sm" placeholder="교환 사유 입력 (선택)">
                            <button onclick="submitChainExchange()" class="bg-indigo-600 text-white px-6 py-2.5 rounded-xl font-bold text-sm hover:bg-indigo-700 transition whitespace-nowrap">
                                <i class="fas fa-paper-plane mr-2"></i>교환 요청 보내기
                            </button>
                        </div>
                    </div>
                </div>
                <!-- 카드3: 대강 - 공강 교사 목록 (대강 모드) -->
                <div id="substituteCard" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 hidden">
                    <div class="flex items-center gap-3 mb-4">
                        <h3 class="font-bold text-lg"><i class="fas fa-user-plus mr-2 text-amber-500"></i>대강 가능 교사</h3>
                        <span id="subPeriodInfo" class="text-sm text-slate-500"></span>
                    </div>
                    <div id="subTeacherList"></div>
                </div>
            </div>
        </div>

        <!-- ============================== 탭3: 교환 요청 목록 ============================== -->
        <div id="panel-exchange-list" class="tab-panel hidden flex-1 overflow-y-auto p-8 bg-slate-50">
            <div class="max-w-5xl mx-auto space-y-6">
                <!-- 필터 -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 flex items-center gap-4 flex-wrap">
                    <select id="exListStatus" class="border border-slate-300 rounded px-3 py-2 text-sm" onchange="loadExchangeList()">
                        <option value="all">전체 상태</option>
                        <option value="pending" selected>대기중</option>
                        <option value="approved">승인됨</option>
                        <option value="rejected">거절됨</option>
                        <option value="cancelled">취소됨</option>
                    </select>
                    <input type="date" id="exListDate" class="border border-slate-300 rounded px-3 py-2 text-sm" onchange="loadExchangeList()">
                    <button onclick="loadExchangeList()" class="bg-slate-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-slate-700 transition">
                        <i class="fas fa-sync-alt mr-1"></i>새로고침
                    </button>
                </div>
                <!-- 학교 전체 교환 요청 (담당자 승인) -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <h3 class="font-bold text-lg mb-4">
                        <i class="fas fa-school mr-2 text-indigo-500"></i>학교 교환 요청
                        <span id="schoolExCount" class="text-sm font-normal text-slate-400 ml-2">0건</span>
                    </h3>
                    <div id="schoolExchanges" class="space-y-3">
                        <div class="text-center py-6 text-slate-400 text-sm">교환 요청이 없습니다.</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const DAYS = ['월', '화', '수', '목', '금'];
        const DAY_IDX = {'월':0, '화':1, '수':2, '목':3, '금':4};
        const PERIODS = 7;

        let currentUser = null;
        let allTeachers = [];
        let classInfo = {};
        let timetableData = [];
        let changesData = [];
        let searchMode = 'teacher';
        let currentTarget = {};
        let modalCell = null;

        // 교환/대강 계산기 상태
        let schoolFullTimetable = null; // /api/timetable/school/all 전체 시간표 캐시
        let dayIndices = {};            // { '월': buildDayIndex(), '화': ..., }  요일별 인덱스
        let exWeekMonday = null;        // 현재 선택된 주의 월요일 Date
        let exSelectedSource = null;    // { period, dayName, classes, teacherId }
        let exCurrentChain = null;      // 현재 계산된 체인 결과
        let exMode = 'exchange';        // 'exchange' | 'substitute'

        // 거절 모달 상태
        let rejectExchangeId = null;

        // ==========================================
        // 탭 전환
        // ==========================================
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('bg-white', 'border-slate-200', 'text-slate-600');
            });
            const activeBtn = document.getElementById('tab-' + tabName);
            activeBtn.classList.add('active');
            activeBtn.classList.remove('bg-white', 'border-slate-200', 'text-slate-600');

            document.querySelectorAll('.tab-panel').forEach(p => {
                p.classList.add('hidden');
                p.classList.remove('flex');
            });
            const panel = document.getElementById('panel-' + tabName);
            panel.classList.remove('hidden');
            if (tabName === 'timetable') panel.classList.add('flex');

            if (tabName === 'exchange-list') loadExchangeList();
            if (tabName === 'exchange-request') {
                if (!exWeekMonday) {
                    exWeekMonday = getWeekMonday(new Date());
                    updateWeekLabel();
                }
            }
        }

        // ==========================================
        // 초기화
        // ==========================================
        async function init() {
            const userStr = localStorage.getItem('schoolus_user');
            if (!userStr) { alert('로그인이 필요합니다.'); window.location.href = '/'; return; }
            currentUser = JSON.parse(userStr);

            if (!currentUser.school_id) {
                try {
                    const res = await fetch('/api/teacher/info?member_id=' + encodeURIComponent(currentUser.member_id));
                    if (res.ok) {
                        const d = await res.json();
                        if (d.success && d.teacher && d.teacher.school_id) {
                            currentUser.school_id = d.teacher.school_id;
                            localStorage.setItem('schoolus_user', JSON.stringify(currentUser));
                        }
                    }
                } catch (e) { console.error(e); }
            }

            document.getElementById('schoolBadge').textContent = currentUser.member_school || currentUser.school_id || '';
            document.getElementById('searchDate').value = new Date().toISOString().split('T')[0];

            await loadTeachersList();
            await loadClassInfo();
            renderEmptyGrid();

            // 탭1 교사 검색 자동완성
            setupTeacherAutocomplete('searchTeacherInput', 'searchTeacherDropdown', (t) => {
                document.getElementById('searchTeacherInput').value = t.member_name;
                document.getElementById('searchTeacherInput').dataset.memberId = t.member_id || '';
                document.getElementById('searchTeacherDropdown').classList.add('hidden');
                doSearch();
            });
            // 탭1 모달 교사 자동완성
            setupTeacherAutocomplete('modalNewTeacher', 'modalTeacherDropdown', (t) => {
                document.getElementById('modalNewTeacher').value = t.member_name;
                document.getElementById('modalTeacherDropdown').classList.add('hidden');
            });
            // 탭2 교환 대상 교사 자동완성
            setupTeacherAutocomplete('exTargetTeacher', 'exTargetDropdown', (t) => {
                document.getElementById('exTargetTeacher').value = t.member_name;
                document.getElementById('exTargetTeacher').dataset.memberId = t.member_id || '';
                document.getElementById('exTargetDropdown').classList.add('hidden');
                exTargetInfo = { member_id: t.member_id, member_name: t.member_name };
            });

            // pending 배지 로드
            loadPendingCount();
        }

        async function loadTeachersList() {
            try {
                let url = '/api/teachers/list?';
                if (currentUser.school_id) url += 'school_id=' + encodeURIComponent(currentUser.school_id);
                else if (currentUser.member_school) url += 'member_school=' + encodeURIComponent(currentUser.member_school);
                const res = await fetch(url);
                if (res.ok) { const data = await res.json(); if (data.success) allTeachers = data.data || []; }
            } catch (e) { console.error('교사 목록 로드 실패:', e); }
        }

        async function loadClassInfo() {
            try {
                let url = '/api/timetable-tea/list?';
                if (currentUser.school_id) url += 'school_id=' + encodeURIComponent(currentUser.school_id);
                else if (currentUser.member_school) url += 'member_school=' + encodeURIComponent(currentUser.member_school);
                const res = await fetch(url);
                if (!res.ok) return;
                const data = await res.json();
                if (!data.success) return;
                classInfo = {};
                (data.data || []).forEach(row => {
                    const g = String(row.grade || '').trim();
                    if (!g) return;
                    if (!classInfo[g]) classInfo[g] = new Set();
                    String(row.class_no || '').split(',').forEach(c => { const cn = c.trim(); if (cn && !isNaN(cn)) classInfo[g].add(cn); });
                });
                for (const g in classInfo) classInfo[g] = [...classInfo[g]].sort((a, b) => Number(a) - Number(b));
                const gradeSelect = document.getElementById('searchGrade');
                const grades = Object.keys(classInfo).sort((a, b) => Number(a) - Number(b));
                gradeSelect.innerHTML = grades.map(g => `<option value="${g}">${g}학년</option>`).join('');
                if (grades.length > 0) onGradeChange();
            } catch (e) { console.error('학급 정보 로드 실패:', e); }
        }

        function onGradeChange() {
            const grade = document.getElementById('searchGrade').value;
            const classSelect = document.getElementById('searchClassNo');
            const classes = classInfo[grade] || [];
            classSelect.innerHTML = classes.map(c => `<option value="${c}">${c}반</option>`).join('');
        }

        function setupTeacherAutocomplete(inputId, dropdownId, onSelect) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            input.addEventListener('input', () => {
                const kw = input.value.trim();
                if (!kw) { dropdown.classList.add('hidden'); return; }
                const matched = allTeachers.filter(t => t.member_name && t.member_name.includes(kw));
                if (matched.length === 0) {
                    dropdown.innerHTML = '<div class="text-slate-400 p-2 text-xs">결과 없음</div>';
                } else {
                    dropdown.innerHTML = matched.slice(0, 15).map((t, i) =>
                        `<div data-idx="${i}"><span class="font-medium">${t.member_name}</span><span class="text-xs text-slate-400 ml-2">${t.department || ''}</span></div>`
                    ).join('');
                    dropdown.querySelectorAll('[data-idx]').forEach(el => {
                        el.addEventListener('click', () => { const t = matched[parseInt(el.dataset.idx)]; if (t) onSelect(t); });
                    });
                }
                dropdown.classList.remove('hidden');
            });
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); dropdown.classList.add('hidden'); if (inputId === 'searchTeacherInput') doSearch(); }
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#' + inputId) && !e.target.closest('#' + dropdownId)) dropdown.classList.add('hidden');
            });
        }

        // ==========================================
        // 탭1: 시간표 조회/변경
        // ==========================================
        function toggleSearchMode() {
            searchMode = document.getElementById('searchMode').value;
            document.getElementById('teacherSearchWrap').classList.toggle('hidden', searchMode !== 'teacher');
            document.getElementById('classSearchWrap').classList.toggle('hidden', searchMode !== 'class');
        }

        async function doSearch() {
            const changeDate = document.getElementById('searchDate').value;
            if (searchMode === 'teacher') {
                const input = document.getElementById('searchTeacherInput');
                const name = input.value.trim();
                if (!name) { alert('교사명을 입력하세요.'); return; }
                const memberId = input.dataset.memberId || '';
                currentTarget = { mode: 'teacher', member_name: name, member_id: memberId };
                await loadTeacherWeek(name, changeDate, memberId);
            } else {
                const grade = document.getElementById('searchGrade').value;
                const classNo = document.getElementById('searchClassNo').value;
                currentTarget = { mode: 'class', grade, class_no: classNo };
                await loadClassWeek(grade, classNo, changeDate);
            }
        }

        async function loadTeacherWeek(memberName, changeDate, memberId) {
            try {
                let url = '/api/timetable/teacher/week?member_name=' + encodeURIComponent(memberName);
                if (memberId) url += '&member_id=' + encodeURIComponent(memberId);
                if (currentUser.school_id) url += '&school_id=' + encodeURIComponent(currentUser.school_id);
                else url += '&member_school=' + encodeURIComponent(currentUser.member_school);
                if (changeDate) url += '&change_date=' + encodeURIComponent(changeDate);
                const res = await fetch(url);
                if (!res.ok) throw new Error('서버 오류');
                const data = await res.json();
                if (!data.success) { alert(data.message); return; }
                timetableData = data.timetable || [];
                changesData = data.changes || [];
                document.getElementById('tableTitle').innerHTML = `<i class="fas fa-chalkboard-teacher mr-2 text-indigo-500"></i>${memberName} 선생님 시간표`;
                document.getElementById('emptyState').classList.add('hidden');
                renderTimetable('teacher');
                loadChanges(changeDate);
            } catch (e) { alert('시간표 조회 실패: ' + e.message); }
        }

        async function loadClassWeek(grade, classNo, changeDate) {
            try {
                let url = `/api/timetable/class/week?grade=${grade}&class_no=${classNo}`;
                if (currentUser.school_id) url += '&school_id=' + encodeURIComponent(currentUser.school_id);
                else url += '&member_school=' + encodeURIComponent(currentUser.member_school);
                if (changeDate) url += '&change_date=' + encodeURIComponent(changeDate);
                const res = await fetch(url);
                if (!res.ok) throw new Error('서버 오류');
                const data = await res.json();
                if (!data.success) { alert(data.message); return; }
                timetableData = data.timetable || [];
                changesData = data.changes || [];
                document.getElementById('tableTitle').innerHTML = `<i class="fas fa-users mr-2 text-green-500"></i>${grade}학년 ${classNo}반 시간표`;
                document.getElementById('emptyState').classList.add('hidden');
                renderTimetable('class');
                loadChanges(changeDate);
            } catch (e) { alert('시간표 조회 실패: ' + e.message); }
        }

        function renderEmptyGrid() {
            const con = document.getElementById('timetableBody');
            con.innerHTML = '';
            for (let p = 1; p <= PERIODS; p++) {
                con.innerHTML += `<div class="period-badge">${p}</div>`;
                for (let d = 0; d < 5; d++) con.innerHTML += `<div class="tt-cell"></div>`;
            }
        }

        function renderTimetable(mode) {
            const con = document.getElementById('timetableBody');
            con.innerHTML = '';
            const grid = {};
            timetableData.forEach(item => {
                const dIdx = DAY_IDX[item.day_of_week];
                if (dIdx === undefined || !item.period) return;
                const key = `${dIdx}-${item.period}`;
                if (!grid[key]) grid[key] = [];
                grid[key].push(item);
            });
            const changeMap = {};
            changesData.forEach(c => {
                const dIdx = DAY_IDX[c.day_of_week];
                if (dIdx === undefined) return;
                changeMap[`${dIdx}-${c.period}`] = c;
            });

            for (let p = 1; p <= PERIODS; p++) {
                con.innerHTML += `<div class="period-badge">${p}</div>`;
                for (let d = 0; d < 5; d++) {
                    const key = `${d}-${p}`;
                    const items = grid[key] || [];
                    const change = changeMap[key];
                    let cellClass = 'tt-cell';
                    let content = '';

                    if (change) {
                        const isExchange = (change.change_reason === '교환수업');
                        if (isExchange) {
                            cellClass += ' exchanged-cell';
                            content = `<div class="subject-tag exchanged-tag">${change.new_subject || change.original_subject || ''}</div>`;
                            if (mode === 'teacher') {
                                content += `<div class="class-tag text-green-600">${change.original_grade || ''}-${change.original_class_no || ''} (교환)</div>`;
                            } else {
                                content += `<div class="class-tag text-green-600">${change.new_teacher || ''} (교환)</div>`;
                            }
                        } else {
                            cellClass += ' changed-cell';
                            content = `<div class="subject-tag changed-tag">${change.new_subject || '자습'}</div>`;
                            if (mode === 'teacher') {
                                content += `<div class="class-tag text-orange-500">${change.original_grade || ''}-${change.original_class_no || ''} (변경)</div>`;
                            } else {
                                content += `<div class="class-tag text-orange-500">${change.new_teacher || '자습'} (변경)</div>`;
                            }
                        }
                    } else if (items.length > 0) {
                        const item = items[0];
                        content = `<div class="subject-tag">${item.subject || ''}</div>`;
                        if (mode === 'teacher') {
                            content += `<div class="class-tag">${item.grade || ''}-${item.class_no || ''}</div>`;
                        } else {
                            content += `<div class="class-tag">${item.member_name || ''}</div>`;
                        }
                        if (items.length > 1) content += `<div class="class-tag text-indigo-400">+${items.length - 1}개</div>`;
                    }

                    const origData = items.length > 0 ? JSON.stringify(items[0]).replace(/'/g, '&#39;').replace(/"/g, '&quot;') : '';
                    const changeData = change ? JSON.stringify(change).replace(/'/g, '&#39;').replace(/"/g, '&quot;') : '';
                    con.innerHTML += `<div class="${cellClass}" onclick="openModal(${d}, ${p}, this)" data-day="${d}" data-period="${p}" data-orig="${origData}" data-change="${changeData}">${content}</div>`;
                }
            }
        }

        // 변경 모달
        function openModal(dayIdx, period, cellEl) {
            modalCell = { dayIdx, period, el: cellEl };
            const day = DAYS[dayIdx];
            const origStr = cellEl.getAttribute('data-orig');
            let orig = origStr ? JSON.parse(origStr) : null;
            document.getElementById('modalTargetInfo').textContent = `${day}요일 ${period}교시`;
            if (orig) {
                document.getElementById('modalOrigSubject').textContent = orig.subject || '-';
                if (currentTarget.mode === 'teacher') {
                    document.getElementById('modalOrigLabel').textContent = '학급';
                    document.getElementById('modalOrigTeacher').textContent = `${orig.grade || ''}-${orig.class_no || ''}`;
                } else {
                    document.getElementById('modalOrigLabel').textContent = '기존 교사';
                    document.getElementById('modalOrigTeacher').textContent = orig.member_name || '-';
                }
            } else {
                document.getElementById('modalOrigSubject').textContent = '-';
                document.getElementById('modalOrigLabel').textContent = currentTarget.mode === 'teacher' ? '학급' : '기존 교사';
                document.getElementById('modalOrigTeacher').textContent = '-';
            }
            document.getElementById('modalNewTeacher').value = '';
            document.getElementById('modalNewSubject').value = '자습';
            document.getElementById('modalReason').value = '출장(관내)';
            const modal = document.getElementById('changeModal');
            modal.classList.remove('hidden'); modal.classList.add('flex');
        }

        function closeModal() {
            const modal = document.getElementById('changeModal');
            modal.classList.add('hidden'); modal.classList.remove('flex');
            modalCell = null;
        }
        document.getElementById('changeModal').addEventListener('click', (e) => { if (e.target === document.getElementById('changeModal')) closeModal(); });

        async function applyChange() {
            if (!modalCell) return;
            const { dayIdx, period } = modalCell;
            const day = DAYS[dayIdx];
            const origStr = modalCell.el.getAttribute('data-orig');
            const orig = origStr ? JSON.parse(origStr) : {};
            const newTeacher = document.getElementById('modalNewTeacher').value.trim();
            const newSubject = document.getElementById('modalNewSubject').value.trim() || '자습';
            const reason = document.getElementById('modalReason').value;
            const changeDate = document.getElementById('searchDate').value;
            if (!changeDate) { alert('기준일자를 선택하세요.'); return; }
            try {
                const res = await fetch('/api/timetable/change/save', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        school_id: currentUser.school_id, member_school: currentUser.member_school,
                        change_date: changeDate, day_of_week: day, period: period,
                        original_teacher: currentTarget.mode === 'teacher' ? currentTarget.member_name : (orig.member_name || ''),
                        original_subject: orig.subject || '',
                        original_grade: orig.grade || (currentTarget.mode === 'class' ? currentTarget.grade : ''),
                        original_class_no: orig.class_no || (currentTarget.mode === 'class' ? currentTarget.class_no : ''),
                        new_teacher: newTeacher || '자습', new_subject: newSubject,
                        change_reason: reason, changed_by: currentUser.member_name || currentUser.member_id
                    })
                });
                if (!res.ok) throw new Error('서버 오류');
                const data = await res.json();
                if (data.success) { closeModal(); doSearch(); } else { alert(data.message); }
            } catch (e) { alert('변경 저장 실패: ' + e.message); }
        }

        // 변경이력 패널
        async function loadChanges(changeDate) {
            try {
                let url = `/api/timetable/changes?school_id=${encodeURIComponent(currentUser.school_id)}`;
                if (changeDate) url += `&change_date=${encodeURIComponent(changeDate)}`;
                const res = await fetch(url);
                if (!res.ok) return;
                const data = await res.json();
                if (!data.success) return;
                const changes = data.changes || [];
                const panel = document.getElementById('changesPanel');
                const tbody = document.getElementById('changesTableBody');
                document.getElementById('changesCount').textContent = changes.length;
                if (changes.length === 0) { panel.classList.add('hidden'); return; }
                panel.classList.remove('hidden');
                tbody.innerHTML = changes.map(c => {
                    const isEx = (c.change_reason === '교환수업');
                    const reasonBadge = isEx ? '<span class="status-badge status-approved">교환</span>' : (c.change_reason || '');
                    return `<tr class="hover:bg-slate-50">
                        <td class="p-2 text-center font-medium">${c.day_of_week} ${c.period}교시</td>
                        <td class="p-2">${c.original_teacher || '-'}</td>
                        <td class="p-2">${c.original_subject || '-'}</td>
                        <td class="p-2 text-center text-indigo-400"><i class="fas fa-arrow-right"></i></td>
                        <td class="p-2 font-medium ${isEx ? 'text-green-600' : 'text-orange-600'}">${c.new_teacher || '-'}</td>
                        <td class="p-2 font-medium ${isEx ? 'text-green-600' : 'text-orange-600'}">${c.new_subject || '-'}</td>
                        <td class="p-2 text-xs text-slate-500">${reasonBadge}</td>
                        <td class="p-2 text-center">
                            <button onclick="cancelChange(${c.id})" class="text-red-400 hover:text-red-600" title="변경 취소"><i class="fas fa-undo"></i></button>
                        </td>
                    </tr>`;
                }).join('');
            } catch (e) { console.error('변경이력 로드 실패:', e); }
        }

        async function cancelChange(id) {
            if (!confirm('이 변경사항을 취소하시겠습니까?')) return;
            try {
                const res = await fetch('/api/timetable/change/delete', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, school_id: currentUser.school_id })
                });
                if (!res.ok) throw new Error('서버 오류');
                const data = await res.json();
                if (data.success) doSearch(); else alert(data.message);
            } catch (e) { alert('취소 실패: ' + e.message); }
        }

        // ==========================================
        // 탭2: 수업 교환 / 대강 (주간 시간표 기반)
        // ==========================================

        function getWeekMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.getFullYear(), d.getMonth(), diff);
        }

        function formatDate(d) {
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${d.getFullYear()}-${mm}-${dd}`;
        }

        function getWeekDateForDay(monday, dayIdx) {
            const d = new Date(monday);
            d.setDate(d.getDate() + dayIdx);
            return formatDate(d);
        }

        function updateWeekLabel() {
            if (!exWeekMonday) exWeekMonday = getWeekMonday(new Date());
            const fri = new Date(exWeekMonday);
            fri.setDate(fri.getDate() + 4);
            const ml = `${exWeekMonday.getMonth()+1}.${exWeekMonday.getDate()}`;
            const fl = `${fri.getMonth()+1}.${fri.getDate()}`;
            document.getElementById('exWeekLabel').textContent = `${exWeekMonday.getFullYear()}. ${ml} (월) ~ ${fl} (금)`;
        }

        function changeWeek(delta) {
            if (!exWeekMonday) exWeekMonday = getWeekMonday(new Date());
            exWeekMonday.setDate(exWeekMonday.getDate() + delta * 7);
            updateWeekLabel();
        }

        function setExMode(mode) {
            exMode = mode;
            exSelectedSource = null;
            exCurrentChain = null;
            document.getElementById('chainResultCard').classList.add('hidden');
            document.getElementById('substituteCard').classList.add('hidden');

            const btnEx = document.getElementById('exModeExchange');
            const btnSub = document.getElementById('exModeSubstitute');
            const desc = document.getElementById('exModeDesc');

            if (mode === 'exchange') {
                btnEx.className = 'px-4 py-2 rounded-lg text-sm font-bold transition border-2 border-indigo-500 bg-indigo-50 text-indigo-700';
                btnSub.className = 'px-4 py-2 rounded-lg text-sm font-bold transition border-2 border-slate-200 bg-white text-slate-600';
                desc.textContent = '수업 셀을 클릭하여 이동할 수업을 선택한 후, 같은 날 공강 셀에 마우스를 올려 교환 경로를 확인하세요.';
            } else {
                btnSub.className = 'px-4 py-2 rounded-lg text-sm font-bold transition border-2 border-amber-500 bg-amber-50 text-amber-700';
                btnEx.className = 'px-4 py-2 rounded-lg text-sm font-bold transition border-2 border-slate-200 bg-white text-slate-600';
                desc.textContent = '수업 셀을 클릭하면 해당 교시에 공강인 교사 목록이 표시됩니다.';
            }
            // 이미 로드된 시간표가 있으면 다시 렌더
            if (schoolFullTimetable && Object.keys(dayIndices).length > 0) renderWeekGrid();
        }

        // --- 전체 시간표 로드 ---
        async function loadSchoolFullTimetable() {
            if (schoolFullTimetable) return schoolFullTimetable;
            try {
                const url = `/api/timetable/school/all?school_id=${encodeURIComponent(currentUser.school_id)}`;
                const res = await fetch(url);
                const data = await res.json();
                if (!data.success) throw new Error(data.message);
                schoolFullTimetable = data.timetable || [];
                return schoolFullTimetable;
            } catch (e) { alert('전체 시간표 로드 실패: ' + e.message); return []; }
        }

        // ★ 밴드 과목 감지: A_화학→"A", 일반과목→null
        function getBandPrefix(subject) {
            if (!subject) return null;
            const m = subject.match(/^([A-E])[_\-]/);
            return m ? m[1] : null;
        }

        // ★ 특정 교시에서 같은 밴드의 모든 교사+반 찾기
        function findBandClasses(idx, period, bandPrefix) {
            const results = [];
            for (const [tid, periods] of Object.entries(idx.teacherToPeriod)) {
                const classes = periods[period] || [];
                for (const c of classes) {
                    if (getBandPrefix(c.subject) === bandPrefix) {
                        results.push({ teacherId: tid, teacherName: idx.teacherNames[tid] || tid, grade: c.grade, classNo: c.classNo, subject: c.subject, classKey: `${c.grade}-${c.classNo}` });
                    }
                }
            }
            return results;
        }

        function buildDayIndex(timetable, dayName) {
            const classToPeriod = {};
            const teacherToPeriod = {};
            const teacherNames = {};

            timetable.filter(c => c.day_of_week === dayName).forEach(cell => {
                const classKey = `${cell.grade}-${cell.class_no}`;
                const p = parseInt(cell.period);
                const tid = cell.member_id || cell.member_name;

                if (!classToPeriod[classKey]) classToPeriod[classKey] = {};
                classToPeriod[classKey][p] = { teacherId: tid, teacherName: cell.member_name, subject: cell.subject };

                if (!teacherToPeriod[tid]) teacherToPeriod[tid] = {};
                if (!teacherToPeriod[tid][p]) teacherToPeriod[tid][p] = [];
                teacherToPeriod[tid][p].push({ grade: cell.grade, classNo: cell.class_no, subject: cell.subject });

                teacherNames[tid] = cell.member_name;
            });

            return { classToPeriod, teacherToPeriod, teacherNames };
        }

        // --- 주간 시간표 로드 ---
        async function loadExchangeWeek() {
            if (!exWeekMonday) exWeekMonday = getWeekMonday(new Date());
            updateWeekLabel();

            const tt = await loadSchoolFullTimetable();
            if (!tt.length) return;

            dayIndices = {};
            DAYS.forEach(d => { dayIndices[d] = buildDayIndex(tt, d); });

            exSelectedSource = null;
            exCurrentChain = null;
            document.getElementById('chainResultCard').classList.add('hidden');
            document.getElementById('substituteCard').classList.add('hidden');
            document.getElementById('exWeekPlaceholder').classList.add('hidden');
            document.getElementById('exWeekGridWrap').classList.remove('hidden');

            renderWeekGrid();
        }

        // --- 주간 그리드 렌더링 ---
        function renderWeekGrid() {
            const myId = currentUser.member_id || currentUser.member_name;
            const body = document.getElementById('exWeekBody');
            let html = '';

            for (let p = 1; p <= PERIODS; p++) {
                // 교시 번호
                html += `<div class="period-badge">${p}</div>`;
                for (let di = 0; di < 5; di++) {
                    const dayName = DAYS[di];
                    const idx = dayIndices[dayName];
                    if (!idx) { html += `<div class="tt-cell"></div>`; continue; }

                    const myPeriods = idx.teacherToPeriod[myId] || {};
                    const classes = myPeriods[p] || [];
                    const hasClass = classes.length > 0;

                    const isSource = exSelectedSource && exSelectedSource.period === p && exSelectedSource.dayName === dayName;
                    const isFreeActive = exMode === 'exchange' && exSelectedSource && !hasClass && !isSource;

                    let cellCls = 'tt-cell';
                    let extraStyle = '';
                    if (isSource) {
                        cellCls += ' source-selected';
                        extraStyle = 'border:2px solid #6366f1; background:#eef2ff; box-shadow:0 0 0 3px rgba(99,102,241,0.3);';
                    } else if (isFreeActive) {
                        cellCls += ' free-active';
                        extraStyle = 'border:2px solid #22c55e; background:#f0fdf4; cursor:pointer; animation:pulse-green 1.5s ease-in-out infinite;';
                    }

                    const cellId = `ex-cell-${di}-${p}`;

                    if (hasClass) {
                        const c = classes[0];
                        const multi = classes.length > 1;
                        const classLabel = multi ? `${c.grade}-${c.classNo} 외 ${classes.length-1}` : `${c.grade}-${c.classNo}`;
                        html += `<div class="${cellCls}" id="${cellId}" style="${extraStyle}" onclick="onExCellClick('${dayName}',${p},true)">
                            <span class="subject-tag">${c.subject}</span>
                            <span class="class-tag">${classLabel}</span>
                        </div>`;
                    } else {
                        const freeLabel = isFreeActive ? '여기로 이동' : '공강';
                        const freeEvents = isFreeActive
                            ? `onclick="onExCellClick('${dayName}',${p},false)" onmouseenter="onFreeHover('${dayName}',${p})" onmouseleave="onFreeLeave('${dayName}',${p})"`
                            : '';
                        html += `<div class="${cellCls}" id="${cellId}" style="${extraStyle}; ${!isFreeActive && !isSource ? 'color:#cbd5e1;' : ''}" ${freeEvents}>
                            <span class="text-xs" style="color:#94a3b8;">${freeLabel}</span>
                        </div>`;
                    }
                }
            }
            body.innerHTML = html;
        }

        // --- 셀 클릭 핸들러 ---
        function onExCellClick(dayName, period, hasClass) {
            if (exMode === 'exchange') {
                if (hasClass) {
                    selectSourcePeriod(dayName, period);
                } else if (exSelectedSource) {
                    onFreeClick(dayName, period);
                }
            } else {
                // 대강 모드: 수업 셀 클릭 → 공강 교사 표시
                if (hasClass) {
                    showSubstituteTeachers(dayName, period);
                }
            }
        }

        function selectSourcePeriod(dayName, period) {
            const myId = currentUser.member_id || currentUser.member_name;
            const idx = dayIndices[dayName];
            if (!idx) return;
            const myPeriods = idx.teacherToPeriod[myId] || {};
            if (!myPeriods[period]) return;

            exSelectedSource = { period, dayName, classes: myPeriods[period], teacherId: myId, teacherName: currentUser.member_name };
            exCurrentChain = null;
            document.getElementById('chainResultCard').classList.add('hidden');
            document.getElementById('substituteCard').classList.add('hidden');
            renderWeekGrid();
        }

        // --- 공강 호버/클릭 → 연쇄 교환 계산 ---
        function onFreeHover(dayName, targetPeriod) {
            if (!exSelectedSource) return;
            const di = DAY_IDX[dayName];
            const el = document.getElementById(`ex-cell-${di}-${targetPeriod}`);
            if (el) { el.style.borderColor = '#16a34a'; el.style.background = '#dcfce7'; el.style.animation = 'none'; el.style.boxShadow = '0 0 0 3px rgba(34,197,94,0.4)'; }

            const isSameDay = exSelectedSource.dayName === dayName;
            const idx = dayIndices[dayName];
            let chain;
            if (isSameDay) {
                chain = findExchangeChain(exSelectedSource.teacherId, exSelectedSource.period, targetPeriod, idx);
            } else {
                chain = findCrossDayChain(exSelectedSource, dayName, targetPeriod);
            }
            exCurrentChain = chain;
            exCurrentChain.targetPeriod = targetPeriod;
            exCurrentChain.dayName = dayName;
            renderChainVisualization(chain, exSelectedSource.period, targetPeriod, idx);
        }

        function onFreeLeave(dayName, targetPeriod) {
            const di = DAY_IDX[dayName];
            const el = document.getElementById(`ex-cell-${di}-${targetPeriod}`);
            if (el) { el.style.borderColor = '#22c55e'; el.style.background = '#f0fdf4'; el.style.animation = 'pulse-green 1.5s ease-in-out infinite'; el.style.boxShadow = ''; }
        }

        function onFreeClick(dayName, targetPeriod) {
            if (!exSelectedSource) return;
            const isSameDay = exSelectedSource.dayName === dayName;
            const idx = dayIndices[dayName];
            let chain;
            if (isSameDay) {
                chain = findExchangeChain(exSelectedSource.teacherId, exSelectedSource.period, targetPeriod, idx);
            } else {
                chain = findCrossDayChain(exSelectedSource, dayName, targetPeriod);
            }
            exCurrentChain = chain;
            exCurrentChain.targetPeriod = targetPeriod;
            exCurrentChain.dayName = dayName;
            renderChainVisualization(chain, exSelectedSource.period, targetPeriod, idx);
        }

        // --- 교차 요일 교환 알고리즘 (대상 요일 내 연쇄 포함) ---
        // ★ 밴드 과목(A_~E_ 접두사)은 같은 교시의 밴드 전체가 하나의 묶음으로 함께 이동
        function findCrossDayChain(source, targetDayName, targetPeriod) {
            const srcIdx = dayIndices[source.dayName];
            const tgtIdx = dayIndices[targetDayName];
            if (!srcIdx || !tgtIdx) return { valid: false, reason: '시간표 데이터가 없습니다.' };

            const myId = source.teacherId;
            const srcClasses = srcIdx.teacherToPeriod[myId]?.[source.period] || [];
            if (srcClasses.length === 0) return { valid: false, reason: '소스 교시에 수업이 없습니다.' };

            const myTgtClasses = tgtIdx.teacherToPeriod[myId]?.[targetPeriod] || [];
            if (myTgtClasses.length > 0) return { valid: false, reason: '대상 요일 해당 교시에 이미 수업이 있습니다.' };

            const allSteps = [];
            const involvedTeachers = new Set([myId]);
            const processedClasses = new Set();
            const visitedTeachers = new Set([myId]);
            const expandedBands = new Set();

            // ★ 소스교시 밴드 확장: 같은 밴드 교사 전체 포함
            const allSrcClasses = [...srcClasses];
            for (const sc of srcClasses) {
                const bp = getBandPrefix(sc.subject);
                if (bp && !expandedBands.has(`${bp}:src:${source.period}`)) {
                    expandedBands.add(`${bp}:src:${source.period}`);
                    const bandClasses = findBandClasses(srcIdx, source.period, bp);
                    for (const bc of bandClasses) {
                        if (bc.teacherId === myId) continue;
                        // 밴드 교사도 대상 요일 targetPeriod에 공강인지 확인
                        const btClasses = tgtIdx.teacherToPeriod[bc.teacherId]?.[targetPeriod] || [];
                        if (btClasses.length > 0) {
                            return { valid: false, reason: `같은 밴드(${bp}) ${bc.teacherName} 선생님이 ${targetDayName}요일 ${targetPeriod}교시에 수업이 있어 교차 요일 교환이 어렵습니다.`, steps: [], teacherCount: 0, teachers: new Set(), crossDay: true };
                        }
                        if (!visitedTeachers.has(bc.teacherId)) { visitedTeachers.add(bc.teacherId); involvedTeachers.add(bc.teacherId); }
                        allSrcClasses.push({ grade: bc.grade, classNo: bc.classNo, subject: bc.subject, teacherId: bc.teacherId, teacherName: bc.teacherName });
                    }
                }
            }

            for (const srcClass of allSrcClasses) {
                const classKey = `${srcClass.grade}-${srcClass.classNo}`;
                if (processedClasses.has(classKey)) continue;
                processedClasses.add(classKey);
                const srcTeacherId = srcClass.teacherId || myId;
                const srcTeacherName = srcClass.teacherName || source.teacherName;
                const cellAtTarget = tgtIdx.classToPeriod[classKey]?.[targetPeriod];

                if (!cellAtTarget) {
                    allSteps.push({ type: 'direct_move', classKey, teacherId: srcTeacherId, teacherName: srcTeacherName, subject: srcClass.subject, fromPeriod: source.period, toPeriod: targetPeriod, fromDay: source.dayName, toDay: targetDayName });
                } else {
                    const displacedId = cellAtTarget.teacherId;
                    const displacedName = cellAtTarget.teacherName;
                    const displacedSubject = cellAtTarget.subject;
                    involvedTeachers.add(displacedId);

                    const displacedOnSrcDay = srcIdx.teacherToPeriod[displacedId]?.[source.period];
                    if (!displacedOnSrcDay || displacedOnSrcDay.length === 0) {
                        allSteps.push({ type: 'swap', classKey, fromTeacherId: srcTeacherId, fromTeacherName: srcTeacherName, fromSubject: srcClass.subject, displacedTeacherId: displacedId, displacedTeacherName: displacedName, displacedSubject, period1: source.period, period2: targetPeriod, fromDay: source.dayName, toDay: targetDayName });
                    } else {
                        allSteps.push({ type: 'swap', classKey, fromTeacherId: srcTeacherId, fromTeacherName: srcTeacherName, fromSubject: srcClass.subject, displacedTeacherId: displacedId, displacedTeacherName: displacedName, displacedSubject, period1: source.period, period2: targetPeriod, fromDay: source.dayName, toDay: targetDayName });
                        return { valid: false, reason: `${displacedName} 선생님이 ${source.dayName}요일 ${source.period}교시에 수업(${displacedOnSrcDay.map(c=>c.subject+'('+c.grade+'-'+c.classNo+')').join(',')})이 있어 교차 요일 교환이 어렵습니다.`, steps: allSteps, teacherCount: involvedTeachers.size, teachers: involvedTeachers, crossDay: true };
                    }

                    // ★ 대상교시 밴드 확장: displaced teacher 과목이 밴드이면 같은 밴드 전체 처리
                    const dBandPrefix = getBandPrefix(displacedSubject);
                    if (dBandPrefix && !expandedBands.has(`${dBandPrefix}:tgt:${targetPeriod}`)) {
                        expandedBands.add(`${dBandPrefix}:tgt:${targetPeriod}`);
                        const bandClasses = findBandClasses(tgtIdx, targetPeriod, dBandPrefix);
                        for (const bc of bandClasses) {
                            if (processedClasses.has(bc.classKey)) continue;
                            processedClasses.add(bc.classKey);
                            const cellAtSrcForBand = srcIdx.classToPeriod[bc.classKey]?.[source.period];
                            if (!cellAtSrcForBand) {
                                if (!visitedTeachers.has(bc.teacherId)) { visitedTeachers.add(bc.teacherId); involvedTeachers.add(bc.teacherId); }
                                allSteps.push({ type: 'bundle_move', classKey: bc.classKey, teacherId: bc.teacherId, teacherName: bc.teacherName, subject: bc.subject, fromPeriod: targetPeriod, toPeriod: source.period, fromDay: targetDayName, toDay: source.dayName });
                            } else {
                                const bSrcId = cellAtSrcForBand.teacherId;
                                const bSrcOnSrcDay = srcIdx.teacherToPeriod[bSrcId]?.[source.period];
                                if (!bSrcOnSrcDay || bSrcOnSrcDay.length === 0 || visitedTeachers.has(bSrcId)) {
                                    if (!visitedTeachers.has(bc.teacherId)) { visitedTeachers.add(bc.teacherId); involvedTeachers.add(bc.teacherId); }
                                    allSteps.push({ type: 'bundle_move', classKey: bc.classKey, teacherId: bc.teacherId, teacherName: bc.teacherName, subject: bc.subject, fromPeriod: targetPeriod, toPeriod: source.period, fromDay: targetDayName, toDay: source.dayName });
                                } else {
                                    involvedTeachers.add(bSrcId);
                                    if (!visitedTeachers.has(bc.teacherId)) { visitedTeachers.add(bc.teacherId); involvedTeachers.add(bc.teacherId); }
                                    allSteps.push({ type: 'swap', classKey: bc.classKey, fromTeacherId: bSrcId, fromTeacherName: cellAtSrcForBand.teacherName, fromSubject: cellAtSrcForBand.subject, displacedTeacherId: bc.teacherId, displacedTeacherName: bc.teacherName, displacedSubject: bc.subject, period1: source.period, period2: targetPeriod, fromDay: source.dayName, toDay: targetDayName });
                                }
                            }
                        }
                    }
                }
            }

            return { valid: true, steps: allSteps, teacherCount: involvedTeachers.size, teachers: involvedTeachers, crossDay: true };
        }

        // --- 핵심: 같은 날 연쇄 교환 알고리즘 (BFS 큐 기반) ---
        // ★ 밴드 과목(A_~E_ 접두사)은 같은 교시의 밴드 전체가 하나의 묶음으로 함께 이동
        function findExchangeChain(teacherId, srcPeriod, tgtPeriod, idx) {
            const myClasses = idx.teacherToPeriod[teacherId]?.[srcPeriod] || [];
            if (myClasses.length === 0) return { valid: false, reason: '소스 교시에 수업이 없습니다.' };

            const allSteps = [];
            const visited = new Set([teacherId]);
            const involvedTeachers = new Set([teacherId]);
            const processedClasses = new Set();
            const expandedBands = new Set(); // "밴드:교시" 이미 확장됨

            const queue = [];

            // ① 내 수업을 큐에 추가
            for (const c of myClasses) {
                const ck = `${c.grade}-${c.classNo}`;
                if (!processedClasses.has(ck)) {
                    processedClasses.add(ck);
                    queue.push({ classKey: ck, subject: c.subject, teacherId, teacherName: idx.teacherNames[teacherId] || teacherId });
                }
                // ② ★ 소스교시 밴드 확장: 같은 밴드 교사 전체를 큐에 추가
                const bp = getBandPrefix(c.subject);
                if (bp && !expandedBands.has(`${bp}:${srcPeriod}`)) {
                    expandedBands.add(`${bp}:${srcPeriod}`);
                    const bandClasses = findBandClasses(idx, srcPeriod, bp);
                    for (const bc of bandClasses) {
                        if (processedClasses.has(bc.classKey)) continue;
                        processedClasses.add(bc.classKey);
                        if (!visited.has(bc.teacherId)) { visited.add(bc.teacherId); involvedTeachers.add(bc.teacherId); }
                        queue.push({ classKey: bc.classKey, subject: bc.subject, teacherId: bc.teacherId, teacherName: bc.teacherName });
                    }
                }
            }

            let safety = 0;
            while (queue.length > 0 && safety < 200) {
                safety++;
                const item = queue.shift();

                const cellAtTarget = idx.classToPeriod[item.classKey]?.[tgtPeriod];

                if (!cellAtTarget) {
                    allSteps.push({ type: 'direct_move', classKey: item.classKey, teacherId: item.teacherId, teacherName: item.teacherName, subject: item.subject, fromPeriod: srcPeriod, toPeriod: tgtPeriod });
                    continue;
                }

                const dId = cellAtTarget.teacherId;
                const dName = cellAtTarget.teacherName;
                const dSubject = cellAtTarget.subject;

                if (visited.has(dId)) {
                    allSteps.push({ type: 'direct_move', classKey: item.classKey, teacherId: item.teacherId, teacherName: item.teacherName, subject: item.subject, fromPeriod: srcPeriod, toPeriod: tgtPeriod });
                    continue;
                }

                const dAtSrc = idx.teacherToPeriod[dId]?.[srcPeriod] || [];

                if (dAtSrc.length === 0) {
                    allSteps.push({ type: 'swap', classKey: item.classKey, fromTeacherId: item.teacherId, fromTeacherName: item.teacherName, fromSubject: item.subject, displacedTeacherId: dId, displacedTeacherName: dName, displacedSubject: dSubject, period1: srcPeriod, period2: tgtPeriod });
                    visited.add(dId);
                    involvedTeachers.add(dId);
                } else {
                    allSteps.push({ type: 'chain_link', classKey: item.classKey, fromTeacherId: item.teacherId, fromTeacherName: item.teacherName, fromSubject: item.subject, displacedTeacherId: dId, displacedTeacherName: dName, displacedSubject: dSubject, period1: srcPeriod, period2: tgtPeriod });
                    visited.add(dId);
                    involvedTeachers.add(dId);

                    for (const dc of dAtSrc) {
                        const ck = `${dc.grade}-${dc.classNo}`;
                        if (!processedClasses.has(ck)) {
                            processedClasses.add(ck);
                            queue.push({ classKey: ck, subject: dc.subject, teacherId: dId, teacherName: dName });
                        }
                        // ★ 밀려난 교사의 소스교시 과목이 밴드이면 같은 밴드 전체 추가
                        const bp2 = getBandPrefix(dc.subject);
                        if (bp2 && !expandedBands.has(`${bp2}:${srcPeriod}`)) {
                            expandedBands.add(`${bp2}:${srcPeriod}`);
                            const bandClasses = findBandClasses(idx, srcPeriod, bp2);
                            for (const bc of bandClasses) {
                                if (processedClasses.has(bc.classKey)) continue;
                                processedClasses.add(bc.classKey);
                                if (!visited.has(bc.teacherId)) { visited.add(bc.teacherId); involvedTeachers.add(bc.teacherId); }
                                queue.push({ classKey: bc.classKey, subject: bc.subject, teacherId: bc.teacherId, teacherName: bc.teacherName });
                            }
                        }
                    }
                }

                // ③ ★ 대상교시 밴드 확장: displaced teacher의 과목이 밴드이면 같은 밴드 전체도 처리
                const dBandPrefix = getBandPrefix(dSubject);
                if (dBandPrefix && !expandedBands.has(`${dBandPrefix}:${tgtPeriod}`)) {
                    expandedBands.add(`${dBandPrefix}:${tgtPeriod}`);
                    const bandClasses = findBandClasses(idx, tgtPeriod, dBandPrefix);
                    for (const bc of bandClasses) {
                        if (processedClasses.has(bc.classKey)) continue;
                        processedClasses.add(bc.classKey);
                        // 이 밴드 멤버의 반이 srcPeriod에 어떤 교사가 있는지 확인
                        const cellAtSrc = idx.classToPeriod[bc.classKey]?.[srcPeriod];
                        if (!cellAtSrc || visited.has(cellAtSrc.teacherId)) {
                            // srcPeriod 빈 슬롯이거나 이미 이동 중 → 밴드멤버 직접 이동
                            if (!visited.has(bc.teacherId)) { visited.add(bc.teacherId); involvedTeachers.add(bc.teacherId); }
                            allSteps.push({ type: 'bundle_move', classKey: bc.classKey, teacherId: bc.teacherId, teacherName: bc.teacherName, subject: bc.subject, fromPeriod: tgtPeriod, toPeriod: srcPeriod });
                        } else {
                            // srcPeriod에 교사 있음 → 큐에 추가하여 BFS로 처리
                            queue.push({ classKey: bc.classKey, subject: cellAtSrc.subject, teacherId: cellAtSrc.teacherId, teacherName: cellAtSrc.teacherName });
                        }
                    }
                }
            }

            if (safety >= 200) return { valid: false, reason: '체인이 너무 깁니다 (200단계 초과)' };
            return { valid: true, steps: allSteps, teacherCount: involvedTeachers.size, teachers: involvedTeachers };
        }

        // --- 체인 시각화 ---
        function renderChainVisualization(chain, srcPeriod, tgtPeriod, idx) {
            const card = document.getElementById('chainResultCard');
            const badge = document.getElementById('chainBadge');
            const area = document.getElementById('chainStepsArea');
            const actions = document.getElementById('chainActions');
            card.classList.remove('hidden');
            document.getElementById('substituteCard').classList.add('hidden');

            if (!chain.valid) {
                badge.className = 'chain-badge-impossible text-xs font-bold';
                badge.textContent = '교환 불가';
                area.innerHTML = `<div class="text-center py-6 text-red-500"><i class="fas fa-times-circle fa-2x mb-2"></i><p class="font-bold">${chain.reason}</p></div>`;
                actions.classList.add('hidden');
                return;
            }

            const cnt = chain.teacherCount;
            const crossLabel = chain.crossDay ? ' (교차 요일)' : '';
            if (cnt <= 2) { badge.className = 'chain-badge-simple text-xs font-bold'; badge.textContent = `${cnt}명 직접 교환${crossLabel}`; }
            else { badge.className = 'chain-badge-complex text-xs font-bold'; badge.textContent = `${cnt}명 연쇄 교환${crossLabel}`; }

            let html = '';
            if (chain.crossDay && exSelectedSource) {
                html += `<div class="text-xs font-bold text-purple-600 mb-3"><i class="fas fa-calendar-week mr-1"></i>${exSelectedSource.dayName}요일 ${exSelectedSource.period}교시 → ${chain.dayName}요일 ${tgtPeriod}교시</div>`;
            }

            const byClass = {};
            chain.steps.forEach(s => { if (!byClass[s.classKey]) byClass[s.classKey] = []; byClass[s.classKey].push(s); });

            for (const [classKey, steps] of Object.entries(byClass)) {
                const [g, c] = classKey.split('-');
                html += `<div class="chain-step"><div class="text-xs font-bold text-slate-500 mb-2"><i class="fas fa-users mr-1"></i>${g}학년 ${c}반</div>`;
                for (const s of steps) {
                    const dayInfo = s.fromDay && s.toDay && s.fromDay !== s.toDay ? `<span class="text-purple-500 text-xs ml-1">${s.fromDay}→${s.toDay}</span>` : '';
                    if (s.type === 'direct_move' || s.type === 'bundle_move') {
                        const moveLabel = s.type === 'bundle_move' ? '<span class="text-orange-500 text-xs">묶음이동</span>' : '<span class="text-green-600 text-xs">이동</span>';
                        html += `<div class="swap-row"><span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded text-xs font-bold">${s.fromPeriod}교시</span><span class="font-bold">${s.teacherName}</span><span class="text-slate-400">(${s.subject})</span><span class="swap-arrow">→</span><span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-bold">${s.toPeriod}교시</span>${moveLabel}${dayInfo}</div>`;
                    } else {
                        html += `<div class="swap-row"><span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded text-xs font-bold">${s.period1}교시</span><span class="font-bold">${s.fromTeacherName}</span><span class="text-slate-400">(${s.fromSubject})</span><span class="swap-arrow">↔</span><span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-bold">${s.period2}교시</span><span class="font-bold">${s.displacedTeacherName}</span><span class="text-slate-400">(${s.displacedSubject})</span>${s.type === 'swap' ? '<span class="text-green-600 text-xs ml-1">공강</span>' : '<span class="text-amber-500 text-xs ml-1">→연쇄</span>'}${dayInfo}</div>`;
                    }
                }
                html += '</div>';
            }

            const teacherList = [...chain.teachers].map(tid => (idx || dayIndices[exSelectedSource?.dayName])?.teacherNames?.[tid] || tid);
            html += `<div class="text-xs text-slate-500 mt-3"><i class="fas fa-user-friends mr-1"></i>관련 교사: <strong>${teacherList.join(', ')}</strong></div>`;
            area.innerHTML = html;
            actions.classList.remove('hidden');
        }

        // --- 연쇄 교환 요청 제출 ---
        async function submitChainExchange() {
            if (!exCurrentChain || !exCurrentChain.valid) { alert('유효한 교환 경로가 없습니다.'); return; }
            if (!exWeekMonday) return;

            const targetDayName = exCurrentChain.dayName || exSelectedSource?.dayName;
            const srcDayName = exSelectedSource?.dayName || targetDayName;
            const isCrossDay = srcDayName !== targetDayName;
            const di = DAY_IDX[targetDayName];
            const exDateStr = getWeekDateForDay(exWeekMonday, di);
            const idx = dayIndices[targetDayName];
            const srcIdx = dayIndices[srcDayName];

            const allNames = {};
            if (idx) Object.assign(allNames, idx.teacherNames);
            if (srcIdx) Object.assign(allNames, srcIdx.teacherNames);
            const teacherNames = [...exCurrentChain.teachers].map(tid => allNames[tid] || tid).filter(n => n !== currentUser.member_name);
            const dayLabel = isCrossDay ? `${srcDayName}→${targetDayName}요일` : `${targetDayName}요일(${exDateStr})`;
            if (!confirm(`${dayLabel} 교환 요청을 보내시겠습니까?\n관련 교사: ${teacherNames.join(', ')} (${exCurrentChain.teacherCount}명)`)) return;

            const reason = document.getElementById('exReqReason').value.trim();
            const chainSteps = [];
            let seq = 0;
            for (const s of exCurrentChain.steps) {
                if (s.type === 'direct_move' || s.type === 'bundle_move') {
                    // 빈 교시로 이동 (교환 상대 없음) — 해당 교시 자습 처리용
                    chainSteps.push({
                        requester_id: s.teacherId,
                        requester_name: s.teacherName,
                        requester_day: s.fromDay || srcDayName,
                        requester_period: s.fromPeriod,
                        requester_subject: s.subject,
                        requester_grade: s.classKey.split('-')[0],
                        requester_class_no: s.classKey.split('-')[1],
                        target_id: '__EMPTY__',
                        target_name: '자습',
                        target_day: s.toDay || targetDayName,
                        target_period: s.toPeriod,
                        target_subject: '',
                        target_grade: s.classKey.split('-')[0],
                        target_class_no: s.classKey.split('-')[1],
                        sequence: seq++,
                        move_type: s.type
                    });
                } else {
                    chainSteps.push({
                        requester_id: s.fromTeacherId || s.teacherId,
                        requester_name: s.fromTeacherName || s.teacherName,
                        requester_day: s.fromDay || srcDayName,
                        requester_period: s.period1 || s.fromPeriod,
                        requester_subject: s.fromSubject || s.subject,
                        requester_grade: s.classKey.split('-')[0],
                        requester_class_no: s.classKey.split('-')[1],
                        target_id: s.displacedTeacherId,
                        target_name: s.displacedTeacherName,
                        target_day: s.toDay || targetDayName,
                        target_period: s.period2 || s.toPeriod,
                        target_subject: s.displacedSubject,
                        target_grade: s.classKey.split('-')[0],
                        target_class_no: s.classKey.split('-')[1],
                        sequence: seq++
                    });
                }
            }

            if (chainSteps.length === 0) { alert('교환 대상이 없습니다.'); return; }

            try {
                const body = chainSteps.length === 1 ? {
                    school_id: currentUser.school_id,
                    member_school: currentUser.member_school || '',
                    exchange_date: exDateStr,
                    ...chainSteps[0],
                    reason
                } : {
                    school_id: currentUser.school_id,
                    member_school: currentUser.member_school || '',
                    exchange_date: exDateStr,
                    chain_steps: chainSteps,
                    reason
                };
                const res = await fetch('/api/timetable/exchange/create', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
                });
                const data = await res.json();
                if (data.success) {
                    alert(data.message || '교환 요청이 등록되었습니다!');
                    exSelectedSource = null;
                    exCurrentChain = null;
                    document.getElementById('chainResultCard').classList.add('hidden');
                    document.getElementById('exReqReason').value = '';
                    renderWeekGrid();
                    loadPendingCount();
                } else { alert(data.message); }
            } catch (e) { alert('요청 실패: ' + e.message); }
        }

        // --- 대강: 공강 교사 표시 ---
        function showSubstituteTeachers(dayName, period) {
            exSelectedSource = { period, dayName, classes: null, teacherId: currentUser.member_id };
            document.getElementById('chainResultCard').classList.add('hidden');
            renderWeekGrid();

            const idx = dayIndices[dayName];
            if (!idx) return;

            // 이 교시에 수업이 없는 교사 = 전체 교사 - 이 교시에 수업 있는 교사
            const busyTeachers = new Set();
            Object.entries(idx.teacherToPeriod).forEach(([tid, periods]) => {
                if (periods[period] && periods[period].length > 0) busyTeachers.add(tid);
            });

            const freeTeachers = [];
            Object.entries(idx.teacherNames).forEach(([tid, name]) => {
                if (!busyTeachers.has(tid) && tid !== (currentUser.member_id || currentUser.member_name)) {
                    freeTeachers.push({ id: tid, name });
                }
            });

            freeTeachers.sort((a, b) => a.name.localeCompare(b.name));

            const card = document.getElementById('substituteCard');
            card.classList.remove('hidden');
            document.getElementById('subPeriodInfo').textContent = `${dayName}요일 ${period}교시 공강 교사 (${freeTeachers.length}명)`;

            if (freeTeachers.length === 0) {
                document.getElementById('subTeacherList').innerHTML = '<div class="text-center py-6 text-slate-400 text-sm">공강인 교사가 없습니다.</div>';
                return;
            }

            let html = '<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">';
            freeTeachers.forEach(t => {
                html += `<div class="flex items-center gap-2 p-3 bg-amber-50 border border-amber-200 rounded-xl cursor-pointer hover:bg-amber-100 transition" onclick="selectSubstitute('${dayName}',${period},'${t.id}','${t.name}')">
                    <i class="fas fa-user-circle text-amber-400"></i>
                    <span class="font-bold text-sm text-slate-700">${t.name}</span>
                </div>`;
            });
            html += '</div>';
            document.getElementById('subTeacherList').innerHTML = html;
        }

        function selectSubstitute(dayName, period, teacherId, teacherName) {
            if (!exWeekMonday) return;
            const di = DAY_IDX[dayName];
            const dateStr = getWeekDateForDay(exWeekMonday, di);
            const myName = currentUser.member_name;

            if (!confirm(`${dayName}요일(${dateStr}) ${period}교시에 ${teacherName} 선생님을 대강으로 배정하시겠습니까?`)) return;

            // 대강도 exchange로 저장 (requester=나, target=대강교사, 단 target_period와 requester_period 동일)
            const myId = currentUser.member_id || currentUser.member_name;
            const idx = dayIndices[dayName];
            const myClasses = idx.teacherToPeriod[myId]?.[period] || [];
            const cls = myClasses[0] || {};

            const body = {
                school_id: currentUser.school_id,
                member_school: currentUser.member_school || '',
                exchange_date: dateStr,
                requester_id: myId,
                requester_name: myName,
                requester_day: dayName,
                requester_period: period,
                requester_subject: cls.subject || '',
                requester_grade: cls.grade || '',
                requester_class_no: cls.classNo || '',
                target_id: teacherId,
                target_name: teacherName,
                target_day: dayName,
                target_period: period,
                target_subject: '',
                target_grade: cls.grade || '',
                target_class_no: cls.classNo || '',
                reason: '대강'
            };

            fetch('/api/timetable/exchange/create', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    alert('대강 요청이 등록되었습니다.');
                    document.getElementById('substituteCard').classList.add('hidden');
                    loadPendingCount();
                } else { alert(data.message); }
            }).catch(e => alert('요청 실패: ' + e.message));
        }

        // ==========================================
        // 탭3: 교환 요청 목록 (학교 전체, 담당자 승인)
        // ==========================================
        async function loadExchangeList() {
            try {
                // 학교 전체 요청 조회 (member_id 없이)
                let url = `/api/timetable/exchange/list?school_id=${encodeURIComponent(currentUser.school_id)}`;
                const status = document.getElementById('exListStatus').value;
                if (status !== 'all') url += '&status=' + encodeURIComponent(status);
                const dateVal = document.getElementById('exListDate').value;
                if (dateVal) url += '&exchange_date=' + encodeURIComponent(dateVal);

                const res = await fetch(url);
                if (!res.ok) throw new Error('서버 오류');
                const data = await res.json();
                if (!data.success) { alert(data.message); return; }

                const items = data.data || [];

                // chain_id로 그룹핑
                const chainGroups = {};
                const singles = [];
                items.forEach(item => {
                    if (item.chain_id) {
                        if (!chainGroups[item.chain_id]) chainGroups[item.chain_id] = [];
                        chainGroups[item.chain_id].push(item);
                    } else {
                        singles.push(item);
                    }
                });

                // chain 그룹 내 정렬
                Object.values(chainGroups).forEach(group => {
                    group.sort((a, b) => (a.chain_sequence || 0) - (b.chain_sequence || 0));
                });

                const totalCount = Object.keys(chainGroups).length + singles.length;
                document.getElementById('schoolExCount').textContent = totalCount + '건';

                const container = document.getElementById('schoolExchanges');
                if (totalCount === 0) {
                    container.innerHTML = '<div class="text-center py-6 text-slate-400 text-sm">교환 요청이 없습니다.</div>';
                    return;
                }

                let html = '';
                // 연쇄 교환 그룹 먼저
                Object.values(chainGroups).forEach(group => { html += renderChainGroupCard(group); });
                // 단일 교환
                singles.forEach(r => { html += renderExchangeCard(r); });
                container.innerHTML = html;
            } catch (e) { console.error('교환 목록 로드 실패:', e); }
        }

        function renderChainGroupCard(group) {
            if (!group || group.length === 0) return '';
            const first = group[0];
            const chainId = first.chain_id;
            const total = group.length;
            const approvedCount = group.filter(g => g.status === 'approved').length;
            const hasFailed = group.some(g => g.status === 'rejected' || g.status === 'cancelled');
            const allApproved = approvedCount === total && !hasFailed;
            const isPending = group.some(g => g.status === 'pending');

            let overallLabel, overallCls;
            if (hasFailed) { overallLabel = '취소됨'; overallCls = 'status-cancelled'; }
            else if (allApproved) { overallLabel = '승인 완료'; overallCls = 'status-approved'; }
            else { overallLabel = '승인 대기'; overallCls = 'status-pending'; }

            // 관련 교사
            const teacherSet = new Set();
            group.forEach(g => { teacherSet.add(g.requester_name); teacherSet.add(g.target_name); });

            let actions = '';
            if (isPending && !hasFailed) {
                actions = `
                    <button onclick="approveExchange(${first.id})" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition"><i class="fas fa-check mr-1"></i>승인</button>
                    <button onclick="openRejectModal(${first.id})" class="bg-red-400 hover:bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-bold transition"><i class="fas fa-times mr-1"></i>거절</button>`;
            } else if (allApproved) {
                actions = `<button onclick="cancelExchange(${first.id})" class="bg-red-400 hover:bg-red-500 text-white px-3 py-1.5 rounded text-xs font-bold transition">교환 취소</button>`;
            }

            let stepsHtml = group.map((g, idx) => {
                const isSubstitute = g.reason === '대강';
                const icon = isSubstitute ? '<i class="fas fa-user-plus text-amber-400 mr-1"></i>' : '<i class="fas fa-exchange-alt text-indigo-400 mr-1"></i>';
                return `<div class="chain-member-row">
                    <span class="text-xs text-slate-400">${idx + 1}</span>
                    ${icon}
                    <span class="font-medium text-indigo-600">${g.requester_name}</span>
                    <span class="text-xs">${g.requester_period}교시 ${g.requester_subject || ''}(${g.requester_grade || ''}-${g.requester_class_no || ''})</span>
                    <i class="fas fa-arrow-right text-slate-400 text-xs"></i>
                    <span class="font-medium text-green-600">${g.target_name}</span>
                    <span class="text-xs">${g.target_period}교시 ${g.target_subject || ''}(${g.target_grade || ''}-${g.target_class_no || ''})</span>
                </div>`;
            }).join('');

            return `<div class="chain-group-card">
                <div class="chain-group-header">
                    <span class="chain-group-badge"><i class="fas fa-link mr-1"></i>연쇄 교환 (${teacherSet.size}명)</span>
                    <span class="status-badge ${overallCls}">${overallLabel}</span>
                    <span class="text-sm font-bold text-slate-700">${first.exchange_date} (${first.requester_day || ''})</span>
                    <span class="text-xs text-slate-400 ml-auto">요청자: ${first.requester_name}</span>
                </div>
                ${stepsHtml}
                <div class="text-xs text-slate-400 mt-2">사유: ${first.reason || '-'} | 요청일: ${(first.created_at || '').slice(0, 10)}</div>
                <div class="flex gap-2 mt-3 justify-end">${actions}</div>
            </div>`;
        }

        function renderExchangeCard(r) {
            const statusMap = {
                'pending': { label: '대기중', cls: 'status-pending' },
                'approved': { label: '승인됨', cls: 'status-approved' },
                'rejected': { label: '거절됨', cls: 'status-rejected' },
                'cancelled': { label: '취소됨', cls: 'status-cancelled' }
            };
            const st = statusMap[r.status] || { label: r.status, cls: '' };
            const isSubstitute = r.reason === '대강';

            let actions = '';
            if (r.status === 'pending') {
                actions = `
                    <button onclick="approveExchange(${r.id})" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded text-xs font-bold transition">승인</button>
                    <button onclick="openRejectModal(${r.id})" class="bg-red-400 hover:bg-red-500 text-white px-3 py-1.5 rounded text-xs font-bold transition">거절</button>`;
            } else if (r.status === 'approved') {
                actions = `<button onclick="cancelExchange(${r.id})" class="bg-red-400 hover:bg-red-500 text-white px-3 py-1.5 rounded text-xs font-bold transition">교환 취소</button>`;
            }

            const rejectInfo = r.status === 'rejected' && r.reject_reason ? ` | 거절사유: ${r.reject_reason}` : '';
            const typeLabel = isSubstitute
                ? '<span class="bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-xs font-bold mr-2">대강</span>'
                : '<span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded text-xs font-bold mr-2">교환</span>';

            return `<div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg border border-slate-200 gap-4 flex-wrap">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1 flex-wrap">
                        ${typeLabel}
                        <span class="status-badge ${st.cls}">${st.label}</span>
                        <span class="text-sm font-bold text-slate-700">${r.exchange_date} (${r.requester_day})</span>
                    </div>
                    <div class="text-sm text-slate-600">
                        <span class="font-medium text-indigo-600">${r.requester_name}</span>
                        ${r.requester_period}교시 ${r.requester_subject || ''}(${r.requester_grade || ''}-${r.requester_class_no || ''})
                        <i class="fas fa-${isSubstitute ? 'arrow-right' : 'exchange-alt'} mx-2 text-slate-400"></i>
                        <span class="font-medium text-green-600">${r.target_name}</span>
                        ${isSubstitute ? '' : `${r.target_period}교시 ${r.target_subject || ''}(${r.target_grade || ''}-${r.target_class_no || ''})`}
                    </div>
                    <div class="text-xs text-slate-400 mt-1">사유: ${r.reason || '-'}${rejectInfo} | 요청일: ${(r.created_at || '').slice(0, 10)}</div>
                </div>
                <div class="flex gap-2 flex-shrink-0">${actions}</div>
            </div>`;
        }

        async function approveExchange(id) {
            if (!confirm('이 교환 요청을 승인하시겠습니까? (연쇄 교환인 경우 전체가 한 번에 승인됩니다)')) return;
            try {
                const res = await fetch('/api/timetable/exchange/respond', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ exchange_id: id, school_id: currentUser.school_id, action: 'approve', reject_reason: '' })
                });
                if (!res.ok) throw new Error('서버 오류');
                const data = await res.json();
                if (data.success) { alert(data.message); loadExchangeList(); loadPendingCount(); }
                else alert(data.message);
            } catch (e) { alert('처리 실패: ' + e.message); }
        }

        function openRejectModal(id) {
            rejectExchangeId = id;
            document.getElementById('rejectReasonInput').value = '';
            const m = document.getElementById('rejectModal');
            m.classList.remove('hidden'); m.classList.add('flex');
        }
        function closeRejectModal() {
            const m = document.getElementById('rejectModal');
            m.classList.add('hidden'); m.classList.remove('flex');
            rejectExchangeId = null;
        }
        document.getElementById('rejectModal').addEventListener('click', (e) => { if (e.target === document.getElementById('rejectModal')) closeRejectModal(); });

        async function confirmReject() {
            if (!rejectExchangeId) return;
            const reason = document.getElementById('rejectReasonInput').value.trim();
            try {
                const res = await fetch('/api/timetable/exchange/respond', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ exchange_id: rejectExchangeId, school_id: currentUser.school_id, action: 'reject', reject_reason: reason })
                });
                if (!res.ok) throw new Error('서버 오류');
                const data = await res.json();
                if (data.success) { closeRejectModal(); alert(data.message); loadExchangeList(); loadPendingCount(); }
                else alert(data.message);
            } catch (e) { alert('처리 실패: ' + e.message); }
        }

        async function cancelExchange(id) {
            if (!confirm('이 교환 요청을 취소하시겠습니까?')) return;
            try {
                const res = await fetch('/api/timetable/exchange/cancel', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ exchange_id: id, school_id: currentUser.school_id })
                });
                if (!res.ok) throw new Error('서버 오류');
                const data = await res.json();
                if (data.success) { alert(data.message); loadExchangeList(); loadPendingCount(); }
                else alert(data.message);
            } catch (e) { alert('취소 실패: ' + e.message); }
        }

        async function loadPendingCount() {
            try {
                const res = await fetch(`/api/timetable/exchange/list?school_id=${encodeURIComponent(currentUser.school_id)}&status=pending`);
                if (!res.ok) return;
                const data = await res.json();
                if (!data.success) return;
                const count = (data.data || []).length;
                const badge = document.getElementById('pendingBadge');
                if (count > 0) {
                    badge.textContent = count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            } catch (e) { console.error(e); }
        }

        // ==========================================
        // 시작
        // ==========================================
        init();

        function toggleMobileSidebar() {
            document.getElementById('sidebar').classList.toggle('mobile-open');
            document.getElementById('mobile-overlay').classList.toggle('active');
        }
        document.getElementById('mobile-overlay').onclick = function() {
            document.getElementById('sidebar').classList.remove('mobile-open');
            this.classList.remove('active');
        };
    </script>
</body>
</html>
