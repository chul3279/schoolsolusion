<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입 - SchoolUs</title>
    <script src="/static/js/tailwindcss.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.9); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15); }
        .school-dropdown { max-height: 300px; overflow-y: auto; border: 2px solid #e2e8f0; border-top: none; }
        .school-item:hover { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .password-strength { height: 4px; border-radius: 2px; transition: all 0.3s; }
        .strength-weak { background: #ef4444; width: 33%; }
        .strength-medium { background: #f59e0b; width: 66%; }
        .strength-strong { background: #10b981; width: 100%; }
        .date-input-group { display: flex; gap: 8px; align-items: center; }
        .date-input-group input { text-align: center; }
        .date-separator { color: #94a3b8; font-weight: bold; }
        .child-card { position: relative; transition: all 0.3s ease; }
        .child-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.08); }
        .child-remove-btn { position: absolute; top: 12px; right: 12px; }
    </style>
    <!-- Google Analytics (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7LJ1TCE277"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-7LJ1TCE277');
    </script>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-purple-50 min-h-screen flex items-center justify-center p-4">
    <div class="glass-card rounded-3xl shadow-2xl w-full max-w-3xl overflow-hidden border-2 border-white/50 my-8">
        <!-- 헤더 -->
        <div class="bg-gradient-to-br from-slate-50 to-blue-50/30 p-8 border-b border-slate-100 text-center relative">
            <button onclick="location.href='/'" class="absolute top-6 left-6 text-slate-400 hover:text-slate-700"><i class="fas fa-arrow-left text-xl"></i></button>
            <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-purple-600 rounded-2xl flex items-center justify-center text-white text-3xl shadow-xl mx-auto mb-4"><i class="fas fa-user-plus"></i></div>
            <h1 class="text-3xl font-black text-slate-800 mb-2">회원가입</h1>
            <p class="text-sm text-slate-500 font-medium">SchoolUs 계정을 만들어보세요</p>
        </div>

        <div class="p-8">
            <form onsubmit="return handleSignup(event)" class="space-y-5">

                <!-- ===== 기본 정보 ===== -->
                <div class="border-l-4 border-blue-500 pl-4 mb-6"><h3 class="text-lg font-black text-slate-700">기본 정보</h3></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-xs font-black text-slate-600 mb-2 ml-1 uppercase">이름 *</label>
                        <div class="relative group">
                            <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-400"><i class="fas fa-user"></i></span>
                            <input id="member_name" type="text" required placeholder="이름을 입력하세요" class="w-full pl-11 pr-4 py-3.5 bg-slate-50/80 border-2 border-slate-200 rounded-xl focus:bg-white focus:border-blue-500 outline-none font-medium text-sm text-slate-700">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 mb-2 ml-1 uppercase">생년월일 *</label>
                        <div class="relative group">
                            <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-400"><i class="fas fa-calendar"></i></span>
                            <div class="date-input-group pl-11">
                                <input id="birth_year" type="text" maxlength="4" placeholder="YYYY" class="w-20 px-2 py-3.5 bg-slate-50/80 border-2 border-slate-200 rounded-xl focus:bg-white focus:border-blue-500 outline-none font-medium text-sm text-slate-700" oninput="autoMoveDate(this, 'birth_month', 4)">
                                <span class="date-separator">-</span>
                                <input id="birth_month" type="text" maxlength="2" placeholder="MM" class="w-14 px-2 py-3.5 bg-slate-50/80 border-2 border-slate-200 rounded-xl focus:bg-white focus:border-blue-500 outline-none font-medium text-sm text-slate-700" oninput="autoMoveDate(this, 'birth_day', 2)">
                                <span class="date-separator">-</span>
                                <input id="birth_day" type="text" maxlength="2" placeholder="DD" class="w-14 px-2 py-3.5 bg-slate-50/80 border-2 border-slate-200 rounded-xl focus:bg-white focus:border-blue-500 outline-none font-medium text-sm text-slate-700" oninput="validateDay(this)">
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-black text-slate-600 mb-2 ml-1 uppercase">이메일 *</label>
                    <div class="relative group">
                        <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-400"><i class="fas fa-envelope"></i></span>
                        <input id="member_email" type="email" required placeholder="example@email.com" class="w-full pl-11 pr-4 py-3.5 bg-slate-50/80 border-2 border-slate-200 rounded-xl focus:bg-white focus:border-blue-500 outline-none font-medium text-sm text-slate-700">
                    </div>
                    <p class="text-xs text-slate-500 mt-1 ml-1">아이디/비밀번호 찾기에 사용됩니다</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-xs font-black text-slate-600 mb-2 ml-1 uppercase">전화번호 *</label>
                        <div class="relative group">
                            <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-400"><i class="fas fa-phone"></i></span>
                            <input id="member_tel" type="tel" required placeholder="01012345678" oninput="formatPhoneNumber(this)" class="w-full pl-11 pr-4 py-3.5 bg-slate-50/80 border-2 border-slate-200 rounded-xl focus:bg-white focus:border-blue-500 outline-none font-medium text-sm text-slate-700">
                        </div>
                        <p class="text-xs text-slate-500 mt-1 ml-1">숫자만 입력하면 자동으로 하이픈 추가</p>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 mb-2 ml-1 uppercase">주소 *</label>
                        <div class="relative group">
                            <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-400"><i class="fas fa-map-marker-alt"></i></span>
                            <input id="member_add" type="text" required placeholder="주소를 입력하세요" class="w-full pl-11 pr-4 py-3.5 bg-slate-50/80 border-2 border-slate-200 rounded-xl focus:bg-white focus:border-blue-500 outline-none font-medium text-sm text-slate-700">
                        </div>
                    </div>
                </div>

                <!-- ===== 계정 정보 ===== -->
                <div class="border-l-4 border-purple-500 pl-4 mb-6 mt-8"><h3 class="text-lg font-black text-slate-700">계정 정보</h3></div>
                <div>
                    <label class="block text-xs font-black text-slate-600 mb-2 ml-1 uppercase">아이디 *</label>
                    <div class="relative group">
                        <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-400"><i class="fas fa-at"></i></span>
                        <input id="login_id" type="text" required placeholder="영문, 숫자 조합 4자 이상" class="w-full pl-11 pr-4 py-3.5 bg-slate-50/80 border-2 border-slate-200 rounded-xl focus:bg-white focus:border-blue-500 outline-none font-medium text-sm text-slate-700">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-xs font-black text-slate-600 mb-2 ml-1 uppercase">비밀번호 *</label>
                        <div class="relative group">
                            <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-400"><i class="fas fa-key"></i></span>
                            <input id="password" type="password" required placeholder="8자 이상" oninput="checkPasswordStrength()" class="w-full pl-11 pr-4 py-3.5 bg-slate-50/80 border-2 border-slate-200 rounded-xl focus:bg-white focus:border-blue-500 outline-none font-medium text-sm text-slate-700">
                        </div>
                        <div class="mt-2 flex items-center gap-2">
                            <div class="flex-1 h-1 bg-slate-200 rounded-full overflow-hidden"><div id="password-strength-bar" class="password-strength h-full"></div></div>
                            <span id="password-strength-text" class="text-xs font-bold text-slate-400"></span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 mb-2 ml-1 uppercase">비밀번호 확인 *</label>
                        <div class="relative group">
                            <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-400"><i class="fas fa-check-circle"></i></span>
                            <input id="password_confirm" type="password" required placeholder="비밀번호 재입력" oninput="checkPasswordMatch()" class="w-full pl-11 pr-4 py-3.5 bg-slate-50/80 border-2 border-slate-200 rounded-xl focus:bg-white focus:border-blue-500 outline-none font-medium text-sm text-slate-700">
                        </div>
                        <p id="password-match-error" class="text-xs text-red-500 mt-1 ml-1 hidden font-medium">비밀번호가 일치하지 않습니다.</p>
                    </div>
                </div>

                <!-- ===== 역할 선택 (체크박스) ===== -->
                <div class="border-l-4 border-green-500 pl-4 mb-6 mt-8"><h3 class="text-lg font-black text-slate-700">역할 선택</h3></div>
                <p class="text-xs text-slate-500 mb-3 ml-1">교사와 학부모는 동시 선택이 가능합니다. 학생은 단독 선택만 가능합니다.</p>
                <div class="grid grid-cols-3 gap-3">
                    <label class="cursor-pointer">
                        <div class="bg-slate-50 border-2 border-slate-200 rounded-xl p-4 text-center transition-all hover:border-green-300">
                            <i class="fas fa-chalkboard-teacher text-2xl mb-2 text-slate-600"></i>
                            <p class="text-xs font-bold text-slate-700 mb-2">교사</p>
                            <input type="checkbox" id="role_teacher" value="teacher" onchange="handleRoleChange()" class="w-4 h-4 accent-green-500 cursor-pointer">
                        </div>
                    </label>
                    <label class="cursor-pointer">
                        <div class="bg-slate-50 border-2 border-slate-200 rounded-xl p-4 text-center transition-all hover:border-blue-300">
                            <i class="fas fa-user-graduate text-2xl mb-2 text-slate-600"></i>
                            <p class="text-xs font-bold text-slate-700 mb-2">학생</p>
                            <input type="checkbox" id="role_student" value="student" onchange="handleRoleChange()" class="w-4 h-4 accent-blue-500 cursor-pointer">
                        </div>
                    </label>
                    <label class="cursor-pointer">
                        <div class="bg-slate-50 border-2 border-slate-200 rounded-xl p-4 text-center transition-all hover:border-purple-300">
                            <i class="fas fa-users text-2xl mb-2 text-slate-600"></i>
                            <p class="text-xs font-bold text-slate-700 mb-2">학부모</p>
                            <input type="checkbox" id="role_parent" value="parent" onchange="handleRoleChange()" class="w-4 h-4 accent-purple-500 cursor-pointer">
                        </div>
                    </label>
                </div>

                <!-- ===== 소속 학교 (교사/학생용) ===== -->
                <div id="school-section" class="hidden">
                    <div class="border-l-4 border-teal-500 pl-4 mb-6 mt-8"><h3 class="text-lg font-black text-slate-700" id="school-section-title">소속 학교</h3></div>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-400 z-10"><i class="fas fa-school"></i></span>
                        <input id="school-search" type="text" placeholder="학교명을 입력하세요" oninput="searchSchool(this.value, 'school-dropdown', 'school-list')" onfocus="searchSchool(this.value, 'school-dropdown', 'school-list')" class="w-full pl-11 pr-4 py-3.5 bg-slate-50/80 border-2 border-slate-200 rounded-xl focus:bg-white focus:border-blue-500 outline-none font-medium text-sm text-slate-700">
                        <input type="hidden" id="member_school">
                        <input type="hidden" id="school_id">
                        <div id="school-dropdown" class="hidden absolute z-20 w-full mt-1 bg-white rounded-xl shadow-xl school-dropdown"><div id="school-list" class="py-2"></div></div>
                    </div>
                </div>

                <!-- ===== 학생 학급 정보 ===== -->
                <div id="student-info-section" class="hidden">
                    <div class="border-l-4 border-blue-500 pl-4 mb-6 mt-8"><h3 class="text-lg font-black text-slate-700">학급 정보</h3></div>
                    <div class="bg-blue-50/50 border-2 border-blue-200 rounded-xl p-6">
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs font-black text-slate-600 mb-2 uppercase">학년 *</label>
                                <select id="stu_grade_self" class="w-full px-4 py-3.5 bg-white border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none font-medium text-sm text-slate-700">
                                    <option value="">선택</option><option value="1">1학년</option><option value="2">2학년</option><option value="3">3학년</option><option value="4">4학년</option><option value="5">5학년</option><option value="6">6학년</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-black text-slate-600 mb-2 uppercase">반 *</label>
                                <input id="stu_class_self" type="number" min="1" max="20" placeholder="반" class="w-full px-4 py-3.5 bg-white border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none font-medium text-sm text-slate-700">
                            </div>
                            <div>
                                <label class="block text-xs font-black text-slate-600 mb-2 uppercase">번호 *</label>
                                <input id="stu_number_self" type="number" min="1" max="40" placeholder="번호" class="w-full px-4 py-3.5 bg-white border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none font-medium text-sm text-slate-700">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== 자녀 정보 (학부모용, 다중 자녀) ===== -->
                <div id="children-section" class="hidden">
                    <div class="border-l-4 border-pink-500 pl-4 mb-6 mt-8 flex items-center justify-between">
                        <h3 class="text-lg font-black text-slate-700">자녀 정보</h3>
                        <button type="button" onclick="addChildCard()" class="flex items-center gap-1 px-4 py-2 bg-pink-500 hover:bg-pink-600 text-white text-xs font-bold rounded-lg transition-colors shadow-md">
                            <i class="fas fa-plus"></i> 자녀 추가
                        </button>
                    </div>
                    <div id="children-container" class="space-y-4">
                        <!-- 자녀 카드가 여기에 동적으로 추가됨 -->
                    </div>
                </div>

                <!-- ===== 가입 버튼 ===== -->
                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 hover:from-blue-700 hover:via-purple-700 hover:to-pink-700 text-white font-black py-4 rounded-xl shadow-xl transition-all mt-8 flex justify-center items-center gap-2">
                    <span>가입하기</span><i class="fas fa-arrow-right"></i>
                </button>
                <div class="text-center pt-4">
                    <p class="text-sm text-slate-500">이미 계정이 있으신가요? <a href="/" class="text-blue-600 font-black hover:underline ml-1">로그인</a></p>
                </div>
            </form>
        </div>
    </div>

    <script>
        let schools = [];
        let childCount = 0;

        // ============================================
        // 초기화: 학교 목록 로드
        // ============================================
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/schools');
                const data = await response.json();
                if (data.success) { schools = data.schools; }
            } catch (error) { console.error('학교 목록 로드 실패:', error); }
        });

        // ============================================
        // 역할 선택 핸들러 (체크박스)
        // ============================================
        function handleRoleChange() {
            const isTeacher = document.getElementById('role_teacher').checked;
            const isStudent = document.getElementById('role_student').checked;
            const isParent = document.getElementById('role_parent').checked;

            // 학생 선택 시: 교사/학부모 비활성화
            if (isStudent) {
                document.getElementById('role_teacher').checked = false;
                document.getElementById('role_parent').checked = false;
                document.getElementById('role_teacher').disabled = true;
                document.getElementById('role_parent').disabled = true;
                // 학생 비활성화 스타일
                document.getElementById('role_teacher').closest('label').classList.add('opacity-40', 'pointer-events-none');
                document.getElementById('role_parent').closest('label').classList.add('opacity-40', 'pointer-events-none');
            } else {
                document.getElementById('role_teacher').disabled = false;
                document.getElementById('role_parent').disabled = false;
                document.getElementById('role_teacher').closest('label').classList.remove('opacity-40', 'pointer-events-none');
                document.getElementById('role_parent').closest('label').classList.remove('opacity-40', 'pointer-events-none');
            }

            // 교사/학부모 선택 시: 학생 비활성화
            if (isTeacher || isParent) {
                document.getElementById('role_student').disabled = true;
                document.getElementById('role_student').closest('label').classList.add('opacity-40', 'pointer-events-none');
            } else if (!isStudent) {
                document.getElementById('role_student').disabled = false;
                document.getElementById('role_student').closest('label').classList.remove('opacity-40', 'pointer-events-none');
            }

            // 섹션 표시/숨김
            const schoolSection = document.getElementById('school-section');
            const studentSection = document.getElementById('student-info-section');
            const childrenSection = document.getElementById('children-section');

            // 교사 또는 학생: 소속 학교 표시
            if (isTeacher || isStudent) {
                schoolSection.classList.remove('hidden');
                document.getElementById('school-section-title').textContent = isTeacher ? '소속 학교 (교사)' : '소속 학교';
            } else {
                schoolSection.classList.add('hidden');
            }

            // 학생: 학급 정보 표시
            if (isStudent) {
                studentSection.classList.remove('hidden');
            } else {
                studentSection.classList.add('hidden');
            }

            // 학부모: 자녀 정보 표시
            if (isParent) {
                childrenSection.classList.remove('hidden');
                // 자녀 카드가 없으면 1개 추가
                if (document.querySelectorAll('.child-card').length === 0) {
                    addChildCard();
                }
            } else {
                childrenSection.classList.add('hidden');
            }
        }

        // ============================================
        // 자녀 카드 추가
        // ============================================
        function addChildCard() {
            childCount++;
            const idx = childCount;
            const container = document.getElementById('children-container');
            
            const card = document.createElement('div');
            card.className = 'child-card bg-pink-50/50 border-2 border-pink-200 rounded-xl p-6 space-y-4';
            card.id = `child-card-${idx}`;
            card.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-black text-pink-600"><i class="fas fa-child mr-1"></i> 자녀 ${document.querySelectorAll('.child-card').length + 1}</span>
                    <button type="button" onclick="removeChildCard(${idx})" class="text-slate-400 hover:text-red-500 transition-colors text-sm" title="삭제">
                        <i class="fas fa-times-circle text-lg"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 mb-2 uppercase">자녀 이름 *</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-400"><i class="fas fa-child"></i></span>
                            <input id="child_name_${idx}" type="text" placeholder="자녀 이름" class="w-full pl-11 pr-4 py-3 bg-white border-2 border-slate-200 rounded-xl focus:border-pink-500 outline-none font-medium text-sm text-slate-700">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 mb-2 uppercase">자녀 생년월일 *</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-400"><i class="fas fa-birthday-cake"></i></span>
                            <div class="date-input-group pl-11">
                                <input id="child_birth_year_${idx}" type="text" maxlength="4" placeholder="YYYY" class="w-20 px-2 py-3 bg-white border-2 border-slate-200 rounded-xl focus:border-pink-500 outline-none font-medium text-sm text-slate-700" oninput="autoMoveDate(this, 'child_birth_month_${idx}', 4)">
                                <span class="date-separator">-</span>
                                <input id="child_birth_month_${idx}" type="text" maxlength="2" placeholder="MM" class="w-14 px-2 py-3 bg-white border-2 border-slate-200 rounded-xl focus:border-pink-500 outline-none font-medium text-sm text-slate-700" oninput="autoMoveDate(this, 'child_birth_day_${idx}', 2)">
                                <span class="date-separator">-</span>
                                <input id="child_birth_day_${idx}" type="text" maxlength="2" placeholder="DD" class="w-14 px-2 py-3 bg-white border-2 border-slate-200 rounded-xl focus:border-pink-500 outline-none font-medium text-sm text-slate-700" oninput="validateDay(this)">
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-black text-slate-600 mb-2 uppercase">자녀 소속 학교 *</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-400 z-10"><i class="fas fa-school"></i></span>
                        <input id="child_school_search_${idx}" type="text" placeholder="학교명을 입력하세요" 
                            oninput="searchSchool(this.value, 'child-school-dropdown-${idx}', 'child-school-list-${idx}')" 
                            onfocus="searchSchool(this.value, 'child-school-dropdown-${idx}', 'child-school-list-${idx}')" 
                            class="w-full pl-11 pr-4 py-3 bg-white border-2 border-slate-200 rounded-xl focus:border-pink-500 outline-none font-medium text-sm text-slate-700">
                        <input type="hidden" id="child_school_${idx}">
                        <input type="hidden" id="child_school_id_${idx}">
                        <div id="child-school-dropdown-${idx}" class="hidden absolute z-20 w-full mt-1 bg-white rounded-xl shadow-xl school-dropdown">
                            <div id="child-school-list-${idx}" class="py-2"></div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-xs font-black text-slate-600 mb-2 uppercase">학년 *</label>
                        <select id="child_grade_${idx}" class="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-xl focus:border-pink-500 outline-none font-medium text-sm text-slate-700">
                            <option value="">선택</option><option value="1">1학년</option><option value="2">2학년</option><option value="3">3학년</option><option value="4">4학년</option><option value="5">5학년</option><option value="6">6학년</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 mb-2 uppercase">반 *</label>
                        <input id="child_class_${idx}" type="number" min="1" max="20" placeholder="반" class="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-xl focus:border-pink-500 outline-none font-medium text-sm text-slate-700">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 mb-2 uppercase">번호 *</label>
                        <input id="child_number_${idx}" type="number" min="1" max="40" placeholder="번호" class="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-xl focus:border-pink-500 outline-none font-medium text-sm text-slate-700">
                    </div>
                </div>
            `;
            container.appendChild(card);
            reindexChildCards();
        }

        // ============================================
        // 자녀 카드 삭제
        // ============================================
        function removeChildCard(idx) {
            const cards = document.querySelectorAll('.child-card');
            if (cards.length <= 1) {
                alert('자녀는 최소 1명 이상이어야 합니다.');
                return;
            }
            const card = document.getElementById(`child-card-${idx}`);
            if (card) {
                card.remove();
                reindexChildCards();
            }
        }

        // ============================================
        // 자녀 카드 번호 재정렬
        // ============================================
        function reindexChildCards() {
            const cards = document.querySelectorAll('.child-card');
            cards.forEach((card, i) => {
                const label = card.querySelector('.text-pink-600');
                if (label) label.innerHTML = `<i class="fas fa-child mr-1"></i> 자녀 ${i + 1}`;
            });
        }

        // ============================================
        // 학교 검색 (범용 - 교사용 및 자녀용)
        // ============================================
        function searchSchool(keyword, dropdownId, listId) {
            const dropdown = document.getElementById(dropdownId);
            const list = document.getElementById(listId);
            if (!keyword || keyword.trim().length === 0) { dropdown.classList.add('hidden'); return; }
            
            const filtered = schools.filter(school => school.member_school.toLowerCase().includes(keyword.toLowerCase()));
            if (filtered.length === 0) {
                list.innerHTML = '<div class="px-4 py-3 text-sm text-slate-400">검색 결과가 없습니다</div>';
                dropdown.classList.remove('hidden');
                return;
            }
            
            list.innerHTML = filtered.slice(0, 10).map(school => 
                `<div class="school-item px-4 py-3 cursor-pointer" onclick="selectSchoolFor('${dropdownId}', '${school.member_school}', '${school.school_id || ''}')">
                    <p class="text-sm font-bold">${school.member_school}</p>
                    <p class="text-xs opacity-70">${school.region || ''}</p>
                </div>`
            ).join('');
            dropdown.classList.remove('hidden');
        }

        // ============================================
        // 학교 선택 (범용)
        // ============================================
        function selectSchoolFor(dropdownId, name, schoolId) {
            const dropdown = document.getElementById(dropdownId);
            
            if (dropdownId === 'school-dropdown') {
                // 교사/학생 본인 학교
                document.getElementById('school-search').value = name;
                document.getElementById('member_school').value = name;
                document.getElementById('school_id').value = schoolId || '';
            } else {
                // 자녀 학교 (dropdownId = 'child-school-dropdown-N')
                const idx = dropdownId.replace('child-school-dropdown-', '');
                document.getElementById(`child_school_search_${idx}`).value = name;
                document.getElementById(`child_school_${idx}`).value = name;
                document.getElementById(`child_school_id_${idx}`).value = schoolId || '';
            }
            dropdown.classList.add('hidden');
        }

        // 외부 클릭 시 드롭다운 닫기
        document.addEventListener('click', (e) => {
            document.querySelectorAll('.school-dropdown').forEach(dd => {
                const input = dd.previousElementSibling?.previousElementSibling?.previousElementSibling;
                if (!dd.contains(e.target) && e.target !== input) {
                    dd.classList.add('hidden');
                }
            });
        });

        // ============================================
        // 유틸리티 함수들
        // ============================================
        function formatPhoneNumber(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value.length > 11) value = value.substring(0, 11);
            let formatted = '';
            if (value.length <= 3) { formatted = value; }
            else if (value.length <= 7) { formatted = value.substring(0, 3) + '-' + value.substring(3); }
            else { formatted = value.substring(0, 3) + '-' + value.substring(3, 7) + '-' + value.substring(7); }
            input.value = formatted;
        }

        function autoMoveDate(input, nextId, maxLength) {
            input.value = input.value.replace(/[^0-9]/g, '');
            if (input.id.includes('month')) {
                let month = parseInt(input.value);
                if (input.value.length === 2 && (month < 1 || month > 12)) { input.value = ''; alert('월은 01~12 사이로 입력해주세요.'); return; }
            }
            if (input.value.length >= maxLength) {
                const nextInput = document.getElementById(nextId);
                if (nextInput) nextInput.focus();
            }
        }

        function validateDay(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
            if (input.value.length === 2) {
                let day = parseInt(input.value);
                if (day < 1 || day > 31) { input.value = ''; alert('일은 01~31 사이로 입력해주세요.'); }
            }
        }

        function getBirthDate(yearId, monthId, dayId) {
            const year = document.getElementById(yearId)?.value || '';
            const month = (document.getElementById(monthId)?.value || '').padStart(2, '0');
            const day = (document.getElementById(dayId)?.value || '').padStart(2, '0');
            if (year && month !== '00' && day !== '00') return `${year}-${month}-${day}`;
            return '';
        }

        function checkPasswordStrength() {
            const password = document.getElementById('password').value;
            const bar = document.getElementById('password-strength-bar');
            const text = document.getElementById('password-strength-text');
            if (password.length < 8) { bar.className = 'password-strength strength-weak'; text.textContent = '약함'; text.className = 'text-xs font-bold text-red-500'; }
            else if (password.length < 12) { bar.className = 'password-strength strength-medium'; text.textContent = '보통'; text.className = 'text-xs font-bold text-yellow-500'; }
            else { bar.className = 'password-strength strength-strong'; text.textContent = '강함'; text.className = 'text-xs font-bold text-green-500'; }
            checkPasswordMatch();
        }

        function checkPasswordMatch() {
            const password = document.getElementById('password').value;
            const confirm = document.getElementById('password_confirm').value;
            const error = document.getElementById('password-match-error');
            if (confirm.length > 0) { error.classList.toggle('hidden', password === confirm); }
        }

        // ============================================
        // 자녀 정보 수집
        // ============================================
        function collectChildren() {
            const cards = document.querySelectorAll('.child-card');
            const children = [];
            cards.forEach(card => {
                const idx = card.id.replace('child-card-', '');
                children.push({
                    child_name: document.getElementById(`child_name_${idx}`)?.value?.trim() || '',
                    child_birth: getBirthDate(`child_birth_year_${idx}`, `child_birth_month_${idx}`, `child_birth_day_${idx}`),
                    child_school: document.getElementById(`child_school_${idx}`)?.value || '',
                    child_school_id: document.getElementById(`child_school_id_${idx}`)?.value || '',
                    stu_grade: document.getElementById(`child_grade_${idx}`)?.value || '',
                    stu_class: document.getElementById(`child_class_${idx}`)?.value || '',
                    stu_number: document.getElementById(`child_number_${idx}`)?.value || ''
                });
            });
            return children;
        }

        // ============================================
        // 회원가입 처리
        // ============================================
        async function handleSignup(event) {
            event.preventDefault();

            const isTeacher = document.getElementById('role_teacher').checked;
            const isStudent = document.getElementById('role_student').checked;
            const isParent = document.getElementById('role_parent').checked;

            // 역할 확인
            if (!isTeacher && !isStudent && !isParent) {
                alert('역할을 1개 이상 선택해주세요.');
                return false;
            }

            // 역할 문자열 생성
            const roles = [];
            if (isTeacher) roles.push('teacher');
            if (isStudent) roles.push('student');
            if (isParent) roles.push('parent');
            const memberRoll = roles.join(',');

            const password = document.getElementById('password').value;
            const passwordConfirm = document.getElementById('password_confirm').value;
            const memberBirth = getBirthDate('birth_year', 'birth_month', 'birth_day');

            const memberEmail = document.getElementById('member_email').value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (!memberBirth) { alert('생년월일을 모두 입력해주세요.'); return false; }
            if (!memberEmail) { alert('이메일을 입력해주세요.'); return false; }
            if (!emailRegex.test(memberEmail)) { alert('올바른 이메일 형식을 입력해주세요.'); return false; }
            if (password.length < 8) { alert('비밀번호는 8자 이상이어야 합니다.'); return false; }
            if (password !== passwordConfirm) { alert('비밀번호가 일치하지 않습니다.'); return false; }

            // 교사/학생: 학교 필수
            if ((isTeacher || isStudent) && !document.getElementById('member_school').value) {
                alert('소속 학교를 선택해주세요.');
                return false;
            }

            // 학생: 학급 정보 필수
            if (isStudent) {
                const g = document.getElementById('stu_grade_self').value;
                const c = document.getElementById('stu_class_self').value;
                const n = document.getElementById('stu_number_self').value;
                if (!g || !c || !n) { alert('학급 정보를 모두 입력해주세요.'); return false; }
            }

            // 학부모: 자녀 정보 검증
            let children = [];
            if (isParent) {
                children = collectChildren();
                if (children.length === 0) { alert('자녀 정보를 입력해주세요.'); return false; }
                for (let i = 0; i < children.length; i++) {
                    const c = children[i];
                    if (!c.child_name || !c.child_birth || !c.child_school || !c.stu_grade || !c.stu_class || !c.stu_number) {
                        alert(`자녀 ${i + 1}의 정보를 모두 입력해주세요.`);
                        return false;
                    }
                }
            }

            const formData = {
                member_name: document.getElementById('member_name').value,
                member_birth: memberBirth,
                member_email: memberEmail,
                member_tel: document.getElementById('member_tel').value,
                member_add: document.getElementById('member_add').value,
                login_id: document.getElementById('login_id').value,
                password: password,
                member_school: document.getElementById('member_school').value || '',
                school_id: document.getElementById('school_id').value || '',
                member_roll: memberRoll
            };

            // 학생: 학급 정보
            if (isStudent) {
                formData.stu_grade = document.getElementById('stu_grade_self').value;
                formData.stu_class = document.getElementById('stu_class_self').value;
                formData.stu_number = document.getElementById('stu_number_self').value;
            }

            // 학부모: 자녀 정보
            if (isParent) {
                formData.children = children;
            }

            try {
                const response = await fetch('/api/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                const data = await response.json();
                if (data.success) {
                    alert('회원가입이 완료되었습니다!');
                    window.location.href = '/';
                } else {
                    alert(data.message);
                }
            } catch (error) {
                console.error('회원가입 오류:', error);
                alert('회원가입 중 오류가 발생했습니다.');
            }
            return false;
        }
    </script>
</body>
</html>