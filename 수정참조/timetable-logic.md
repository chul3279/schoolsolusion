# 시간표 작성 로직 시각화

## 1. 전체 워크플로우 (Step 0 ~ Step 8)

```
┌─────────────────────────────────────────────────────────────────┐
│                    시간표 워크플로우 전체 흐름                      │
│                                                                  │
│  Step 0   Step 1   Step 2   Step 3   Step 4   Step 5            │
│  가이드 → 기초DB → 학생DB → 반편성 → 과목   → 교사               │
│  확인     과목목록  수요조사  배정     수급    수급                │
│                                                                  │
│           Step 6   Step 7         Step 8                         │
│         → 제약   → 시간표       → 교육반                         │
│           조건     자동생성       배정(선택과목)                   │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 단계별 상세 로직

### Step 1: 기초DB (교과목 목록)

```
cours_subject 테이블 (교육과정 기준 교과목)
┌──────────────────────────────────────┐
│ course_year │ domain  │ subject     │
│ 2022개정    │ 공통    │ 국어         │
│ 2022개정    │ 공통    │ 수학         │
│ 2022개정    │ 탐구    │ 물리학       │
│ ...         │ ...     │ ...         │
└──────────────────────────────────────┘
         │
         ▼ 학교에서 사용할 과목 선택
         │
timetable_data 테이블 (학교별 과목 설정)
┌──────────────────────────────────────────────────────────────┐
│ school_id │ subject │ grade │ subject_type │ subject_demand │
│           │         │       │ (공통/선택)   │ (주당 시수)    │
│           │         │       │              │                │
│ + stu_count(수강인원) │ class_demand(교육반수) │ band_group   │
│ + tea_demand(필요교사) │ tea_1person(1인시수)  │ (선택군)     │
└──────────────────────────────────────────────────────────────┘

API: GET  /api/cours-subject/list
     POST /api/cours-subject/save
     GET  /api/timetable-data/list
     POST /api/timetable-data/save
```

### Step 2: 학생DB (수요조사)

```
timetable_survey (설문 기간 관리)
┌────────────────────────────────────┐
│ school_id │ survey_start │ status  │
│           │ survey_end   │ active  │
└────────────────────────────────────┘
         │ 설문 활성화
         ▼
학생이 선택과목 응답 (최대 12과목)
         │
         ▼
timetable_stu (학생별 선택과목)
┌──────────────────────────────────────────────────────┐
│ member_id │ grade │ class_no │ student_num            │
│ subject1  │ subject2 │ ... │ subject12               │
│ (학생이 선택한 과목 최대 12개)                         │
└──────────────────────────────────────────────────────┘
         │
         ▼ 자동 집계
timetable_data.stu_count 업데이트
(과목별 수강 희망 인원)

API: GET  /api/timetable-survey/get
     POST /api/timetable-survey/save
     GET  /api/timetable-stu/list
     POST /api/timetable-stu/save
     POST /api/timetable-data/update-stu-count
```

### Step 3: 반편성

```
timetable_stu.class_no 배정
┌─────────────────────────────────┐
│ 학생 250명                       │
│ ├─ 1반: 25명                    │
│ ├─ 2반: 25명                    │
│ ├─ ...                          │
│ └─ 10반: 25명                   │
└─────────────────────────────────┘

※ class_maker.py에서 별도 학급편성 기능 제공
```

### Step 4: 과목 수급 (선택군 지정 포함)

```
timetable_data 설정:
┌──────────────────────────────────────────────────────┐
│ subject_type: '공통' 또는 '선택'                       │
│                                                       │
│ [공통과목]                                             │
│ ├─ subject_demand: 주당 시수 (예: 국어 4시간)          │
│ └─ class_demand: 학급 수와 같음 (전체 반 수업)          │
│                                                       │
│ [선택과목]                                             │
│ ├─ subject_demand: 주당 시수                           │
│ ├─ class_demand: 교육반 수 (stu_count 기반 산출)       │
│ └─ band_group: 선택군 라벨 (A, B, C, ...)  ◀── 핵심!  │
└──────────────────────────────────────────────────────┘

선택군(band_group) 의미:
┌──────────────────────────────────────────────────┐
│ 같은 band_group 내 과목들은 동시에 수업            │
│ → 학생은 같은 선택군에서 1개만 선택 가능            │
│                                                   │
│ 예) 교과간 선택:                                   │
│   band_group 'A': 물리학, 화학, 생명과학, 지구과학, │
│                   세계사, 사회와문화, 세계시민, 윤리  │
│   → 8과목 중 학생이 4개 선택                        │
│                                                   │
│ 예) 교과내 선택:                                   │
│   band_group 'A': 물리학, 화학, 생명과학, 지구과학  │
│   band_group 'B': 세계사, 사회와문화, 윤리          │
│   → A에서 2개 + B에서 2개 선택                      │
└──────────────────────────────────────────────────┘
```

### Step 5: 교사 수급 (교육반 설정)

```
timetable_tea (교사별 담당 교육반)
┌────────────────────────────────────────────────────┐
│ member_id │ subject │ grade │ class_no │ hours      │
│ 김선생     │ 물리학  │ 2     │ 1        │ 3          │
│ 김선생     │ 물리학  │ 2     │ 2        │ 3          │
│ 이선생     │ 화학    │ 2     │ 1        │ 3          │
│ ...                                                │
│                                                    │
│ [공통과목] class_no = 실제 반 번호 (1~10반)         │
│ [선택과목] class_no = 교육반 번호 (1반, 2반, ...)    │
└────────────────────────────────────────────────────┘

★ 밴드 균형 규칙 (하드 에러):
┌──────────────────────────────────────────────────┐
│ 선택군별 교육반 합계 = 원반 수 × N (자연수)        │
│                                                   │
│ 예) 원반 10개, band_group 'A' 에 8과목:            │
│   물리(5) + 화학(5) + 생명(5) + 지구(5)            │
│   + 세계사(5) + 사회문화(5) + 세계시민(5) + 윤리(5) │
│   = 40반 → 40 ÷ 10 = 4밴드 ✓                     │
│                                                   │
│   만약 39반이면 → 39 ÷ 10 = 나머지 9 → 오류!       │
│   "교육반 합계는 30개 또는 40개로 조정하세요"        │
│                                                   │
│ ※ 이 검증 실패 시 Step 8 진행 불가 (하드 에러)      │
└──────────────────────────────────────────────────┘

API: GET  /api/timetable-tea/list
     POST /api/timetable-tea/save
```

### Step 6: 제약 조건

```
timetable_constraint (교사별 불가 시간)
┌──────────────────────────────────────────┐
│ member_id │ day_of_week │ period │ type  │
│ 김선생     │ 월          │ 1      │ 불가  │
│ 이선생     │ 수          │ NULL   │ 종일  │
│ (period=NULL이면 해당 요일 종일 불가)     │
└──────────────────────────────────────────┘

timetable_fixed_subject (고정 교과)
┌────────────────────────────────────────────────┐
│ grade │ day_of_week │ period_start │ subject   │
│ all   │ 월          │ 1            │ 조회      │
│ 1     │ 금          │ 6            │ 창체      │
│ (전학년 또는 특정 학년, 특정 시간 고정)          │
└────────────────────────────────────────────────┘

API: GET  /api/timetable-constraint/list
     POST /api/timetable-constraint/save
```

### Step 7: 시간표 자동 생성 (timetable_engine.py)

```
┌─────────────────────────────────────────────────────────────┐
│                  시간표 자동 생성 엔진                         │
│                                                              │
│  입력                                                        │
│  ├─ teachers (timetable_tea)                                │
│  ├─ timetable_data (과목 설정 + subject_type)               │
│  ├─ constraints (교사별 불가 시간)                            │
│  └─ fixed_subjects (고정 교과)                               │
│                                                              │
│  처리 흐름:                                                   │
│                                                              │
│  1. build_blocks()                                           │
│     ├─ 공통과목 → regular_groups (학년_과목별 블록)           │
│     └─ 선택과목 → elective_sections                          │
│         ├─ 과학탐구 (물리,화학,생명,지구)                     │
│         ├─ 사회탐구 (세계사,사회문화,윤리 등)                  │
│         └─ 기타선택                                          │
│                                                              │
│  2. run_auto_generate()                                      │
│     ├─ ① 고정 교과 선배치 (조회, 창체 등)                    │
│     │                                                        │
│     ├─ ② 블록 정렬                                           │
│     │   (선택과목 우선 → 시수 많은 순)                        │
│     │                                                        │
│     └─ ③ 각 블록을 (요일, 교시) 슬롯에 배치                  │
│         ├─ Pass 1: 연속 2시간 이하 허용                       │
│         ├─ Pass 2: 연속 3시간까지 허용 (긴급)                 │
│         │                                                    │
│         │  슬롯 배치 가능 조건 5가지:                          │
│         │  ┌──────────────────────────────────┐              │
│         │  │ ① 해당 반에 빈 칸인가?            │              │
│         │  │ ② 해당 교사가 비어있는가? (busy)   │              │
│         │  │ ③ 교사 제약조건에 위배 안 되는가?   │              │
│         │  │ ④ 하루 2시수 초과 안 하는가?       │              │
│         │  │ ⑤ 연속시간 제한 초과 안 하는가?    │              │
│         │  └──────────────────────────────────┘              │
│         │                                                    │
│         └─ _place_block() → schedule dict에 기록              │
│            + busy set에 교사 시간 마킹                        │
│                                                              │
│  3. save_timetable()                                         │
│     schedule → timetable 테이블에 INSERT                      │
│     (school_id, grade, class_no, day, period, subject, teacher)│
└─────────────────────────────────────────────────────────────┘

출력:
┌────────────────────────────────────────┐
│ timetable 테이블                        │
│ ├─ school_id, grade, class_no          │
│ ├─ day_of_week (월~금)                 │
│ ├─ period (1~7)                        │
│ ├─ subject (과목명)                    │
│ ├─ member_name (교사명)                │
│ └─ member_id (교사ID)                  │
│                                        │
│ 선택과목 칸 = '선택' 또는 과목명         │
│ (Step 8에서 교육반 배정 후 덮어쓰기)     │
└────────────────────────────────────────┘

API: POST /api/pipeline/generate
```

### Step 8: 선택과목 교육반 배정 (elective_engine.py)

```
┌──────────────────────────────────────────────────────────────────┐
│              선택과목 교육반 배정 파이프라인                         │
│              run_elective_pipeline()                               │
│                                                                   │
│  Phase 0: 사전 검증                                               │
│  ┌────────────────────────────────────────────────────────┐      │
│  │ detect_elective_subjects()                              │      │
│  │ → timetable_data에서 subject_type='선택' 과목 추출       │      │
│  │                                                         │      │
│  │ load_elective_groups()                                  │      │
│  │ → timetable_tea에서 선택과목 교육반 로드                  │      │
│  │                                                         │      │
│  │ load_students()                                         │      │
│  │ → timetable_stu에서 학생+선택과목 로드                    │      │
│  │                                                         │      │
│  │ find_slot_positions()                                   │      │
│  │ → timetable에서 선택과목 시간 슬롯 위치 탐색              │      │
│  │                                                         │      │
│  │ ★ validate_band_balance() — 하드 에러 검증               │      │
│  │   선택군별 교육반 합계 % 원반수 != 0 이면 즉시 중단!      │      │
│  │   → status: 'error', error_type: 'band_balance'         │      │
│  └────────────────────────────────────────────────────────┘      │
│       │ 통과                                                      │
│       ▼                                                           │
│  Phase 1: 밴드 배정 (assign_groups_to_bands)                      │
│  ┌────────────────────────────────────────────────────────┐      │
│  │                                                         │      │
│  │  band_group별 과목 분류 → 밴드 수 계산                    │      │
│  │  밴드 수 = 교육반 합계 ÷ 원반 수                          │      │
│  │                                                         │      │
│  │  예) band_group 'A', 원반 10개, 교육반 40개:              │      │
│  │      밴드 수 = 40 ÷ 10 = 4                               │      │
│  │      밴드 라벨: A, B, C, D                                │      │
│  │                                                         │      │
│  │  Round-Robin 분산:                                       │      │
│  │  ┌──────────────────────────────────────┐               │      │
│  │  │ 물리1반→A  물리2반→B  물리3반→C       │               │      │
│  │  │ 물리4반→D  물리5반→A                  │               │      │
│  │  │ 화학1반→B  화학2반→C  화학3반→D       │               │      │
│  │  │ 화학4반→A  화학5반→B                  │               │      │
│  │  │ ...                                  │               │      │
│  │  │ (동일 교사의 반이 같은 밴드 회피)      │               │      │
│  │  └──────────────────────────────────────┘               │      │
│  │                                                         │      │
│  │  교사 충돌 회피 로직:                                     │      │
│  │  같은 교사의 다른 교육반이 같은 밴드에 배정되면             │      │
│  │  → 다음 밴드 라벨로 시도 (최대 num_bands번 시도)           │      │
│  │  → 모두 충돌이면 기본 밴드 배정 (경고)                     │      │
│  └────────────────────────────────────────────────────────┘      │
│       │                                                           │
│       ▼                                                           │
│  Phase 2: 학생 배정 (assign_students_to_groups)                   │
│  ┌────────────────────────────────────────────────────────┐      │
│  │                                                         │      │
│  │  학생 목록을 랜덤 셔플 (seed 기반 재현 가능)              │      │
│  │       │                                                 │      │
│  │       ▼ 각 학생마다:                                     │      │
│  │  find_valid_assignment() — 백트래킹 알고리즘              │      │
│  │  ┌──────────────────────────────────────────────┐       │      │
│  │  │                                               │       │      │
│  │  │  학생의 선택과목 중 교육반 있는 것만 필터       │       │      │
│  │  │       │                                       │       │      │
│  │  │       ▼                                       │       │      │
│  │  │  backtrack(idx, used_bands, assignment)        │       │      │
│  │  │       │                                       │       │      │
│  │  │       ├─ idx == 과목수 → 성공! 배정 확정       │       │      │
│  │  │       │                                       │       │      │
│  │  │       ├─ 현재 과목의 교육반 옵션 정렬           │       │      │
│  │  │       │  (학생 수 적은 반 우선 = 균등 배분)     │       │      │
│  │  │       │                                       │       │      │
│  │  │       └─ 각 옵션 시도:                         │       │      │
│  │  │          band가 used_bands에 없으면 선택       │       │      │
│  │  │          ├─ 성공 → 다음 과목으로 재귀           │       │      │
│  │  │          └─ 실패 → 다른 옵션 시도 (백트래킹)   │       │      │
│  │  │                                               │       │      │
│  │  │  ★ 핵심 제약: 한 학생이 같은 밴드의            │       │      │
│  │  │    교육반 2개에 배정될 수 없음                  │       │      │
│  │  │    (같은 시간에 2과목 수업 불가)                │       │      │
│  │  └──────────────────────────────────────────────┘       │      │
│  │                                                         │      │
│  │  결과: success(배정성공), fail(배정실패), fail_students    │      │
│  └────────────────────────────────────────────────────────┘      │
│       │                                                           │
│       ▼                                                           │
│  Phase 3: 슬롯 배정 (assign_slots_to_groups)                     │
│  ┌────────────────────────────────────────────────────────┐      │
│  │                                                         │      │
│  │  _build_bands_config():                                 │      │
│  │  시간표의 선택과목 슬롯을 밴드에 분배                      │      │
│  │                                                         │      │
│  │  예) 슬롯 12개, 밴드 4개:                                │      │
│  │  ┌──────────────────────────────────────┐               │      │
│  │  │ 밴드A: 슬롯 0,1,2  (3시간)           │               │      │
│  │  │ 밴드B: 슬롯 3,4,5  (3시간)           │               │      │
│  │  │ 밴드C: 슬롯 6,7,8  (3시간)           │               │      │
│  │  │ 밴드D: 슬롯 9,10,11 (3시간)          │               │      │
│  │  └──────────────────────────────────────┘               │      │
│  │                                                         │      │
│  │  각 교육반에 자기 밴드의 슬롯 할당                        │      │
│  │  (교사 중복 시 슬롯 순환으로 분산)                        │      │
│  └────────────────────────────────────────────────────────┘      │
│       │                                                           │
│       ▼                                                           │
│  Phase 4: 충돌 검증 (validate_conflicts)                         │
│  ┌────────────────────────────────────────────────────────┐      │
│  │                                                         │      │
│  │  학생 충돌: 한 학생이 같은 슬롯에 2과목 배정?             │      │
│  │  → student_conflicts (0이어야 저장)                      │      │
│  │                                                         │      │
│  │  교사 충돌: 한 교사가 같은 슬롯에 2교육반?                │      │
│  │  → teacher_conflicts (경고만, 저장은 허용)               │      │
│  └────────────────────────────────────────────────────────┘      │
│       │                                                           │
│       ▼                                                           │
│  Phase 5: 저장 조건 판단                                          │
│  ┌────────────────────────────────────────────────────────┐      │
│  │                                                         │      │
│  │  저장 조건:                                              │      │
│  │  ├─ student_conflicts == 0  (학생 시간 충돌 없음)        │      │
│  │  └─ assign_result.fail == 0  (배정 실패 학생 없음)       │      │
│  │                                                         │      │
│  │  ※ teacher_conflicts > 0 이어도 저장 허용 (경고 표시)    │      │
│  │                                                         │      │
│  │  저장 시 save_results():                                 │      │
│  │  ├─ timetable 테이블 갱신 (선택과목 슬롯 덮어쓰기)       │      │
│  │  ├─ timetable_stu_group 저장 (학생별 교육반 배정)        │      │
│  │  └─ timetable_band_slots 저장 (밴드→시간대 매핑)         │      │
│  └────────────────────────────────────────────────────────┘      │
│                                                                   │
│  API: POST /api/pipeline/assign-electives                         │
│       POST /api/pipeline/check (사전 조건 확인)                    │
└──────────────────────────────────────────────────────────────────┘
```

## 3. DB 테이블 관계도 (시간표 전용)

```
cours_subject (교육과정 기초DB)
    │ 과목 목록
    ▼
timetable_data (학교별 과목 설정)
┌─────────────────────────────────────────────────┐
│ school_id, subject, grade                        │
│ subject_type (공통/선택)                          │
│ subject_demand (주당 시수)                        │
│ class_demand (교육반 수)                          │
│ stu_count (수강 희망 인원)                        │
│ band_group (선택군: A, B, ...)  ◀── 핵심 설정     │
│ tea_demand, tea_1person (교사 수급)               │
└──────────┬──────────────────────────────────────┘
           │
    ┌──────┴──────┐
    ▼             ▼
timetable_tea    timetable_stu
(교사 교육반)    (학생 선택과목)
┌──────────┐    ┌──────────────┐
│member_id │    │ member_id    │
│subject   │    │ grade        │
│grade     │    │ class_no     │
│class_no  │    │ student_num  │
│hours     │    │ subject1~12  │
└────┬─────┘    └──────┬───────┘
     │                 │
     └────────┬────────┘
              ▼
   timetable_constraint    timetable_fixed_subject
   (교사 불가 시간)        (고정 교과)
   ┌──────────────┐       ┌──────────────────┐
   │ member_id    │       │ grade            │
   │ day, period  │       │ day, period_start│
   │ type         │       │ subject          │
   └──────┬───────┘       └────────┬─────────┘
          │                        │
          └───────────┬────────────┘
                      ▼
              timetable (최종 시간표)
              ┌────────────────────────┐
              │ school_id, grade       │
              │ class_no, day_of_week  │
              │ period, subject        │
              │ member_name, member_id │
              └──────────┬─────────────┘
                         │
              ┌──────────┴──────────┐
              ▼                     ▼
   timetable_stu_group     timetable_band_slots
   (학생별 교육반 배정)    (밴드→시간대 매핑)
   ┌──────────────────┐   ┌──────────────────┐
   │ member_id        │   │ band (A,B,C...)  │
   │ subject          │   │ day_of_week      │
   │ group_no (반번호)│   │ period           │
   │ band (A,B,C...)  │   └──────────────────┘
   │ teacher_name     │
   └──────────────────┘

   timetable_changes (시간표 변경 이력)
   ┌────────────────────────────┐
   │ change_date, day_of_week   │
   │ period, original_teacher   │
   │ new_teacher, new_subject   │
   │ original_grade, class_no   │
   │ change_reason              │
   └────────────────────────────┘
```

## 4. 밴드 배정 상세 로직

```
예시: 2학년, 원반 10개, 교과간 선택

선택군 A에 8과목, 각 5교육반 = 40교육반
밴드 수 = 40 ÷ 10 = 4밴드

  밴드A         밴드B         밴드C         밴드D
  (10교육반)    (10교육반)    (10교육반)    (10교육반)
┌───────────┐┌───────────┐┌───────────┐┌───────────┐
│물리1  화학2││물리2  화학3││물리3  화학4││물리4  화학5│
│생명3  지구4││생명4  지구5││생명5  지구1││생명1  지구2│
│세계1  물리5││세계2  생명2││세계3  세계5││세계4  화학1│
│  ...       ││  ...       ││  ...       ││  ...      │
└───────────┘└───────────┘└───────────┘└───────────┘

슬롯 배정 (12슬롯 = 4밴드 × 3시간):
  월3교시  월4교시  월5교시  ← 밴드A 시간
  수3교시  수4교시  수5교시  ← 밴드B 시간
  목3교시  목4교시  목5교시  ← 밴드C 시간
  금3교시  금4교시  금5교시  ← 밴드D 시간

학생 배정 예:
  홍길동: 물리(A밴드), 화학(B밴드), 세계사(C밴드), 윤리(D밴드)
  → 각 밴드 1개씩만 → 시간 충돌 없음 ✓

  김철수: 물리(A밴드), 화학(A밴드) ← 같은 밴드 2개!
  → 백트래킹으로 다른 반 탐색
  → 물리2(B밴드), 화학1(A밴드) 로 재배정 시도
```

## 5. 학생 배정 백트래킹 알고리즘

```
학생: 박영희
선택과목: [물리, 화학, 생명, 세계사]

교육반 옵션 (학생수 적은 순 정렬):
  물리: [(A,id1), (B,id2), (C,id3), (D,id4), (A,id5)]
  화학: [(B,id6), (C,id7), (D,id8), (A,id9), (B,id10)]
  생명: [(C,id11), (D,id12), (A,id13), (B,id14), (C,id15)]
  세계사: [(D,id16), (A,id17), (B,id18), (C,id19), (D,id20)]

backtrack(0, {}, []):
  물리 → A밴드(id1) 시도 → used_bands={A}
    backtrack(1, {A}, [id1]):
      화학 → B밴드(id6) 시도 → used_bands={A,B}
        backtrack(2, {A,B}, [id1,id6]):
          생명 → C밴드(id11) 시도 → used_bands={A,B,C}
            backtrack(3, {A,B,C}, [id1,id6,id11]):
              세계사 → D밴드(id16) 시도 → used_bands={A,B,C,D}
                backtrack(4, {A,B,C,D}, [id1,id6,id11,id16]):
                  idx == 4 == 과목수 → ★ 성공!
                  return [id1, id6, id11, id16]

결과: 물리1반(A), 화학1반(B), 생명1반(C), 세계사1반(D)

※ 만약 모든 경로 실패 → fail_students에 추가
```

## 6. 시간표 조회 흐름 (학생 개인)

```
학생 시간표 조회 API: GET /api/timetable/student

  1단계: 원반 시간표 조회
  ┌─────────────────────────────────────┐
  │ timetable WHERE class_no = '3'      │
  │ ├─ 1교시: 국어 / 김선생             │
  │ ├─ 2교시: 수학 / 이선생             │
  │ ├─ 3교시: 선택 / -     ◀ 선택슬롯   │
  │ ├─ 4교시: 선택 / -     ◀ 선택슬롯   │
  │ ├─ 5교시: 선택 / -     ◀ 선택슬롯   │
  │ ├─ 6교시: 영어 / 박선생             │
  │ └─ 7교시: 체육 / 최선생             │
  └─────────────────────────────────────┘

  2단계: 학생 교육반 조회
  ┌─────────────────────────────────────┐
  │ timetable_stu_group                  │
  │ WHERE member_id = '학생ID'           │
  │ ├─ band A → 물리학 2반 / 김과학 선생 │
  │ ├─ band B → 화학 1반 / 이과학 선생   │
  │ ├─ band C → 세계사 3반 / 박사회 선생 │
  │ └─ band D → 윤리 2반 / 최윤리 선생   │
  └─────────────────────────────────────┘

  3단계: 밴드→시간대 매핑
  ┌─────────────────────────────────────┐
  │ timetable_band_slots                 │
  │ WHERE day_of_week = '월'             │
  │ ├─ 3교시 → band A                   │
  │ ├─ 4교시 → band B                   │
  │ └─ 5교시 → band C                   │
  └─────────────────────────────────────┘

  4단계: 오버레이 적용
  ┌─────────────────────────────────────┐
  │ 최종 학생 시간표 (월요일):            │
  │ ├─ 1교시: 국어 / 김선생              │
  │ ├─ 2교시: 수학 / 이선생              │
  │ ├─ 3교시: 물리학(2반) / 김과학 ◀오버 │
  │ ├─ 4교시: 화학(1반) / 이과학   ◀오버 │
  │ ├─ 5교시: 세계사(3반) / 박사회 ◀오버 │
  │ ├─ 6교시: 영어 / 박선생              │
  │ └─ 7교시: 체육 / 최선생              │
  └─────────────────────────────────────┘

  5단계: 시간표 변경 오버레이 (당일)
  timetable_changes에 변경 있으면 추가 적용
```

## 7. 시간표 변경 관리

```
원본 시간표 (timetable)
     │
     │ 변경 발생 (교사 출장, 보강 등)
     ▼
timetable_changes
┌──────────────────────────────────────────┐
│ change_date: 2026-02-26                   │
│ day_of_week: 월                           │
│ period: 3                                 │
│ original_teacher: 김선생                   │
│ original_subject: 물리학                   │
│ original_grade: 2, original_class_no: 3    │
│ new_teacher: 이선생 (보강 교사)            │
│ new_subject: 자습 (또는 다른 과목)         │
│ change_reason: 출장                        │
└──────────────────────────────────────────┘

조회 시:
  교사 시간표 → 내 수업 취소 + 보강 투입 수업 표시
  학급 시간표 → 변경된 교사/과목 오버레이
  학생 시간표 → 위 두 가지 + 교육반 오버레이

교환 요청:
  POST /api/timetable/exchange/create  (교환 신청)
  GET  /api/timetable/exchange/list    (목록 조회)
  POST /api/timetable/exchange/respond (승인/거절)
  POST /api/timetable/exchange/cancel  (취소)
```

## 8. 에러 처리 체계

```
┌──────────────────────────────────────────────────────────┐
│                    에러 종류별 처리                        │
│                                                           │
│  [하드 에러 — 파이프라인 중단]                              │
│  ┌────────────────────────────────────────────────┐      │
│  │ ❌ band_balance 오류                             │      │
│  │    교육반 합계가 원반수의 배수가 아님              │      │
│  │    → status:'error', error_type:'band_balance'  │      │
│  │    → 프론트에 빨간 에러박스 표시                  │      │
│  │    → Step 5에서 교육반 수 조정 필요               │      │
│  │                                                  │      │
│  │ ❌ 학생 배정 실패 (fail > 0)                      │      │
│  │    백트래킹으로 해결 불가능한 학생 존재            │      │
│  │    → 저장하지 않음 (saved: false)                │      │
│  │    → fail_students 목록 반환 (최대 10명)          │      │
│  │                                                  │      │
│  │ ❌ 학생 시간 충돌 (student_conflicts > 0)         │      │
│  │    같은 슬롯에 2과목 배정된 학생 존재             │      │
│  │    → 저장하지 않음                               │      │
│  └────────────────────────────────────────────────┘      │
│                                                           │
│  [경고 — 파이프라인 계속]                                  │
│  ┌────────────────────────────────────────────────┐      │
│  │ ⚠️ 교사 충돌 (teacher_conflicts > 0)             │      │
│  │    한 교사가 같은 슬롯에 2교육반                  │      │
│  │    → 저장 허용 (amber 경고 표시)                  │      │
│  │    → 교사 시간표 수동 조정 권장                   │      │
│  │                                                  │      │
│  │ ⚠️ 시간표 생성 미배치 (placed < needed)           │      │
│  │    공간 부족으로 일부 블록 미배치                  │      │
│  │    → consecutive_warnings로 카운트                │      │
│  └────────────────────────────────────────────────┘      │
│                                                           │
│  [스킵 — 정상 생략]                                       │
│  ┌────────────────────────────────────────────────┐      │
│  │ ○ 선택과목 없음 → skipped: true                  │      │
│  │ ○ 교육반 없음 → skipped: true                    │      │
│  │ ○ 학생 없음 → skipped: true                      │      │
│  │ ○ 슬롯 없음 → skipped: true                      │      │
│  │   (해당 학년에 선택과목이 없으면 정상적으로 생략)  │      │
│  └────────────────────────────────────────────────┘      │
└──────────────────────────────────────────────────────────┘
```

## 9. 저장 테이블 요약

```
Step 7 생성 시 저장:
┌─────────────────────────┐
│ timetable               │ ← 전체 시간표 (공통+선택 슬롯)
│ (DELETE → INSERT 전체)   │
└─────────────────────────┘

Step 8 배정 시 저장 (3개 테이블):
┌─────────────────────────┐
│ timetable               │ ← 선택과목 슬롯만 덮어쓰기
│ (선택슬롯 DELETE→INSERT) │    (원반별 대표 과목으로)
├─────────────────────────┤
│ timetable_stu_group     │ ← 학생별 교육반 배정 결과
│ (DELETE → INSERT)        │    (개인 시간표 조회용)
├─────────────────────────┤
│ timetable_band_slots    │ ← 밴드→시간대 매핑
│ (DELETE → INSERT)        │    (학생 시간표 오버레이용)
└─────────────────────────┘
```
